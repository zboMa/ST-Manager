# äºŒæ”¹è¯´æ˜ï¼ˆRevision Notesï¼‰

## äºŒæ”¹æ¦‚è§ˆ

- ğŸ“ **é¢„è®¾ç®¡ç†** - ç®¡ç† SillyTavern ç”Ÿæˆå‚æ•°é¢„è®¾ï¼ˆJSONï¼‰å¹¶æ”¯æŒä¸Šä¼ /æŸ¥çœ‹
- ğŸ”— **é…’é¦†èµ„æºåŒæ­¥** - ä»æœ¬åœ° SillyTavern è¯»å–å¹¶åŒæ­¥è§’è‰²å¡ã€ä¸–ç•Œä¹¦ã€é¢„è®¾ã€æ­£åˆ™ã€å¿«é€Ÿå›å¤
- ğŸ§© **æ­£åˆ™æ±‡æ€»** - æ”¯æŒè¯»å–å…¨å±€æ­£åˆ™ä¸é¢„è®¾ç»‘å®šæ­£åˆ™å¹¶æ±‡æ€»å±•ç¤º

## åŠŸèƒ½æ·»åŠ 

- æ­£åˆ™è¯»å–ä¸æ±‡æ€»ï¼š
  - ç»Ÿä¸€æ­£åˆ™æå–é€»è¾‘ï¼Œå…¼å®¹å¤šç§å­—æ®µä¸æ ¼å¼ã€‚
  - æ–°å¢å…¨å±€æ­£åˆ™ï¼ˆsettings.jsonï¼‰è¯»å–ã€‚
  - æ–°å¢æ¥å£ï¼š`GET /api/st/regex`ï¼ˆæ±‡æ€»å…¨å±€ + é¢„è®¾ç»‘å®šï¼‰ã€‚
  - æ­£åˆ™åŒæ­¥æ–°å¢å…¨å±€æ­£åˆ™å¯¼å‡ºï¼šå°† settings.json çš„å…¨å±€æ­£åˆ™ç”Ÿæˆ `global__*.json` å†™å…¥æœ¬åœ° regex ç›®å½•ã€‚
  - å…¨å±€æ­£åˆ™å¯¼å‡ºæ”¹ä¸ºâ€œåç§° + å†…å®¹â€åŒ¹é…ï¼šåŒåä¸”å†…å®¹ä¸€è‡´åˆ™è¦†ç›–åŸæ–‡ä»¶ï¼Œå†…å®¹ä¸åŒåˆ™ç”Ÿæˆæ–°æ–‡ä»¶ã€‚
- ä¸–ç•Œä¹¦å¡æ­»ä¼˜åŒ–ï¼š
  - è¯¦æƒ…å¼¹çª—é»˜è®¤é¢„è§ˆå‰ 300 æ¡ï¼Œé¿å…è¶…å¤§æ¡ç›®å¯¼è‡´å¡æ­»ã€‚
  - å†…åµŒä¸–ç•Œä¹¦åŒæ ·å¯ç”¨é¢„è§ˆæˆªæ–­ï¼Œå¹¶å¯¹è¶…é•¿ content/comment åšé•¿åº¦æˆªæ–­ã€‚
  - é¢„è§ˆæˆªæ–­çŠ¶æ€ä¼šåœ¨è¯¦æƒ…å¼¹çª—æç¤ºï¼Œå¯æ‰‹åŠ¨â€œåŠ è½½å…¨éƒ¨â€ã€‚
  - æ”¯æŒç‚¹å‡»â€œåŠ è½½å…¨éƒ¨â€è·å–å®Œæ•´å†…å®¹ã€‚
  - ç¼–è¾‘å™¨æ‰“å¼€æ—¶å¼ºåˆ¶åŠ è½½å®Œæ•´å†…å®¹ï¼Œç¡®ä¿å¯ç¼–è¾‘ã€‚
- ä¸–ç•Œä¹¦å…¨å±€åˆ—è¡¨å»é‡ï¼š
  - æ’é™¤èµ„æºç›®å½•å†…çš„ lorebooksï¼Œé¿å…è¯¯åˆ¤ä¸ºå…¨å±€ã€‚
  - å¯¹å†…åµŒä¸–ç•Œä¹¦è¿›è¡Œå†…å®¹ç­¾åæ¯”å¯¹ï¼Œè‹¥å†…å®¹ç›¸åŒåˆ™ä»å…¨å±€åˆ—è¡¨å‰”é™¤ã€‚
- é¢„è®¾è¯¦æƒ…å¢å¼ºï¼š
  - é¢„è®¾è¯¦æƒ…å¼¹çª—æ–°å¢ Prompts æ¡ç›®åˆ—è¡¨ï¼Œæ”¯æŒå±•å¼€/æ”¶èµ·é€æ¡æŸ¥çœ‹ã€‚
  - Prompts å…¼å®¹ `prompts` åˆ—è¡¨ä¸ `prompt_order + prompts(dict)` ç»“æ„ï¼Œç»Ÿä¸€å½’ä¸€åŒ–å±•ç¤ºã€‚
- é¡¶éƒ¨æœç´¢è¦†ç›–ï¼š
  - é¢„è®¾é¡µæ–°å¢æœç´¢æ¡†ï¼ˆåç§°/æ–‡ä»¶åï¼‰ã€‚
  - æ­£åˆ™è„šæœ¬ / ST è„šæœ¬ / Quick Replies æ”¯æŒæœç´¢è¿‡æ»¤ã€‚

## é…ç½®æ–°å¢

```json
{
  "png_deterministic_sort": false,
  "allowed_abs_resource_roots": [],
  "wi_preview_limit": 300,
  "wi_preview_entry_max_chars": 2000
}
```

- `png_deterministic_sort`ï¼šPNG å…ƒæ•°æ®æ˜¯å¦ä½¿ç”¨ç¡®å®šæ€§æ’åºï¼ˆé»˜è®¤å…³é—­ï¼‰ã€‚
- `allowed_abs_resource_roots`ï¼šå…è®¸è®¿é—®çš„ç»å¯¹èµ„æºç›®å½•ç™½åå•ï¼ˆèµ„æºæ–‡ä»¶åˆ—è¡¨æ¥å£ä½¿ç”¨ï¼‰ã€‚
- `wi_preview_limit`ï¼šä¸–ç•Œä¹¦è¯¦æƒ…é¢„è§ˆæœ€å¤§æ¡ç›®æ•°ï¼ˆ0 ä¸ºä¸é™åˆ¶ï¼‰ã€‚
- `wi_preview_entry_max_chars`ï¼šä¸–ç•Œä¹¦å•æ¡å†…å®¹é¢„è§ˆæœ€å¤§å­—ç¬¦æ•°ï¼ˆ0 ä¸ºä¸æˆªæ–­ï¼‰ã€‚
  - ä¸Šè¿°é…ç½®å·²è¡¥å…¥å‰ç«¯è®¾ç½®é¡µï¼ˆç»´æŠ¤ä¸é«˜çº§ â†’ é«˜çº§é€‰é¡¹ï¼‰ã€‚

## æ¥å£æ›´æ–°

- ä¸–ç•Œä¹¦è¯¦æƒ…ï¼š
  - `POST /api/world_info/detail` æ–°å¢ `preview_limit` / `force_full`ã€‚
- æ­£åˆ™æ±‡æ€»ï¼š
  - æ–°å¢ `GET /api/st/regex`ã€‚

---


### 1) é¢„è®¾ç®¡ç†

**æ¨¡å—åˆ†å±‚**

- API å±‚ï¼š`core/api/v1/presets.py`
- å·¥å…·å±‚ï¼š`core/utils/regex.py`
- é…ç½®å±‚ï¼š`core/config.py`ï¼ˆ`presets_dir`ã€`resources_dir`ï¼‰

**æ•°æ®ç»“æ„**

- Summary è¾“å‡ºï¼š`id / name / description / regex_count / mtime / file_size`
- Detail è¾“å‡ºï¼šåŒ…å«å®Œæ•´ `raw_data` + è§£æåçš„ `regexes`

**å¤„ç†æµç¨‹**

1. **ç›®å½•è§£æ**
   - å…¨å±€é¢„è®¾ï¼š`presets_dir`
   - èµ„æºé¢„è®¾ï¼š`resources_dir/<resource>/presets`
   - è·¯å¾„å…è®¸å­ç›®å½•ï¼Œä½†é€šè¿‡ `_safe_join` ä¿è¯ä¸è¶Šç•Œ
2. **æ–‡ä»¶è¯»å–**
   - `_parse_preset_file()` è¯»å– JSON å¹¶æå–åŸºç¡€å­—æ®µ
3. **æ­£åˆ™æå–**
   - `_extract_regex_from_preset()` ç»Ÿä¸€è°ƒç”¨ `extract_regex_from_preset_data()`
   - å…¼å®¹ `regex_scripts / regexScripts / extensions / extension_settings` ç­‰å¤šç§å­—æ®µ
4. **API è¾“å‡º**
   - `/api/presets/list` è¿”å›åˆ—è¡¨ï¼ˆæ”¯æŒ `search` / `filter_type`ï¼‰
   - `/api/presets/detail/<preset_id>` è¿”å›è¯¦æƒ…ï¼ˆå« `regexes`ï¼‰

**å…³é”®ç‚¹**

- é¢„è®¾ ID æ”¯æŒå±‚çº§ç›®å½•ï¼Œé¿å…ç ´ååŸæœ‰å¤šå±‚ç›®å½•ç»„ç»‡
- regex æå–é€»è¾‘ä¸ `st-external-bridge` ç»“æ„ä¿æŒä¸€è‡´

---

### 2) é…’é¦†èµ„æºåŒæ­¥

**æ¨¡å—åˆ†å±‚**

- API å±‚ï¼š`core/api/v1/st_sync.py`
- æœåŠ¡å±‚ï¼š`core/services/st_client.py`
- é…ç½®å±‚ï¼š`core/config.py`ï¼ˆ`st_data_dir`, `st_url`, å„èµ„æºç›®å½•ï¼‰

**æ”¯æŒèµ„æº**

- characters / worlds / presets / regex / quick_replies

**æ•°æ®æµ**

1. **è·¯å¾„æ¢æµ‹**
   - `STClient.detect_st_path()` ç»„åˆå¸¸è§å®‰è£…è·¯å¾„ + é…ç½®
2. **èµ„æºåˆ—ä¸¾**
   - `STClient.list_*()` ä¼˜å…ˆæœ¬åœ°ç›®å½•è¯»å–
   - `use_api=true` æ—¶èµ° ST APIï¼ˆè‹¥å¯ç”¨ï¼‰
3. **åŒæ­¥é€»è¾‘**
   - `/api/st/sync` ç»Ÿä¸€å…¥å£
   - `sync_resource()` / `sync_all_resources()` å¤åˆ¶åˆ°æœ¬åœ°èµ„æºåº“

**å…³é”®ç‚¹**

- ä¸ä»…åŒæ­¥è§’è‰²å¡/ä¸–ç•Œä¹¦ï¼Œè¿˜æ”¯æŒé¢„è®¾ã€æ­£åˆ™ã€å¿«é€Ÿå›å¤
- é¢„è®¾/æ­£åˆ™ç›®å½•é‡‡ç”¨å¤šå€™é€‰è·¯å¾„æ¢æµ‹ï¼ˆå« `OpenAI Settings` / `public/presets` / `public/scripts/regex`ï¼‰
- å¯¹æ­£åˆ™è„šæœ¬æä¾› API æ¨¡å¼è¯»å–ï¼ˆ`_list_regex_scripts_api`ï¼‰
- æ­£åˆ™åŒæ­¥ä¼šé¢å¤–å¯¼å‡ºå…¨å±€æ­£åˆ™åˆ°æœ¬åœ° regex ç›®å½•

---

### 3) æ­£åˆ™æ±‡æ€»

**æ¨¡å—åˆ†å±‚**

- å·¥å…·å±‚ï¼š`core/utils/regex.py`
- æœåŠ¡å±‚ï¼š`core/services/st_client.py`
- API å±‚ï¼š`core/api/v1/st_sync.py`

**å®ç°æ ¸å¿ƒ**

1. **ç»Ÿä¸€è§„åˆ™æŠ½å–**
   - `extract_regex_from_preset_data(raw)`
   - `extract_global_regex_from_settings(raw)`
   - å…¼å®¹å­—æ®µåŒ…æ‹¬ï¼š
     - `regex / regexes / regular_expressions`
     - `extensions.regex / extension_settings.regex`
     - `regex_scripts / regexScripts`
     - `SPreset.RegexBinding.regexes`
     - `find_replace / find_and_replace`
2. **å»é‡ç­–ç•¥**
   - ä½¿ç”¨ `pattern + flags + replace` ç”Ÿæˆå”¯ä¸€é”®
3. **èšåˆè¾“å‡º**
   - `STClient.aggregate_regex()`ï¼š
     - `global`ï¼šæ¥è‡ª settings.json
     - `presets`ï¼šéå†é¢„è®¾ç›®å½•æŠ½å–ç»‘å®šæ­£åˆ™
     - `stats`ï¼šç»Ÿè®¡æ€»æ•°ä¸ç»„æ•°

**API ç»“æœç¤ºæ„**

```json
{
  "success": true,
  "global": { "path": ".../settings.json", "regexes": [...], "count": 12 },
  "presets": [
    { "presetId": "foo", "presetName": "Foo", "regexes": [...], "regexCount": 3 }
  ],
  "stats": { "presetGroups": 1, "presetRules": 3, "total": 15 }
}
```
- æ—¢å¯è¦†ç›–å…¨å±€æ­£åˆ™ï¼Œåˆå¯è¦†ç›–é¢„è®¾ç»‘å®šæ­£åˆ™

---

## ç›¸å…³å‰ç«¯ä¸æ€§èƒ½ä¼˜åŒ–

- ä¸–ç•Œä¹¦è¯¦æƒ…é»˜è®¤ä½¿ç”¨ `preview_limit=300`ï¼Œé¿å…è¶…å¤§æ¡ç›®æ¸²æŸ“å¡æ­»
- ç”¨æˆ·å¯ç‚¹å‡»â€œåŠ è½½å…¨éƒ¨â€è§¦å‘ `force_full=true` è¯·æ±‚
- ç¼–è¾‘å™¨å§‹ç»ˆå¼ºåˆ¶åŠ è½½å…¨é‡ï¼Œä¿è¯å¯ç¼–è¾‘å®Œæ•´æ•°æ®
- å†…åµŒä¸–ç•Œä¹¦é€šè¿‡ `preview_wi` èµ°é¢„è§ˆæ¨¡å¼ï¼Œå¹¶æºå¸¦æˆªæ–­çŠ¶æ€ç»™å‰ç«¯
- å…¨å±€ä¸–ç•Œä¹¦åˆ—è¡¨åšå†…å®¹å»é‡ï¼Œé¿å…ä¸å†…åµŒä¸–ç•Œä¹¦é‡å¤æ˜¾ç¤º
- Prompts/æ­£åˆ™æ¡ç›®åœ¨é¢„è®¾è¯¦æƒ…ä¸­æ”¯æŒæŠ˜å æ˜¾ç¤ºï¼Œå‡è½»è§†è§‰è´Ÿæ‹…
