# ST-Manager

<div align="center">

**SillyTavern èµ„æºå¯è§†åŒ–ç®¡ç†å·¥å…·**

[![Python](https://img.shields.io/badge/Python-3.10%2B-blue)](https://www.python.org/downloads/)
[![Flask](https://img.shields.io/badge/Flask-2.0%2B-green)](https://flask.palletsprojects.com/)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

åŠŸèƒ½å¼ºå¤§ â€¢ ç•Œé¢ç¾è§‚ â€¢ æ“ä½œä¾¿æ·

</div>

## ğŸ“– ç®€ä»‹

ST-Manager æ˜¯ä¸€æ¬¾ä¸“ä¸º SillyTavern AI èŠå¤©ç¨‹åºè®¾è®¡çš„èµ„æºå¯è§†åŒ–ç®¡ç†å·¥å…·ã€‚å®ƒæä¾›äº†ä¸€ä¸ªç°ä»£åŒ–çš„ Web ç•Œé¢ï¼Œå¸®åŠ©ç”¨æˆ·é«˜æ•ˆç®¡ç†è§’è‰²å¡ã€ä¸–ç•Œä¹¦ã€æ‰©å±•è„šæœ¬ç­‰å„ç§èµ„æºï¼Œæ”¯æŒæ‰¹é‡æ“ä½œã€è‡ªåŠ¨åŒ–è§„åˆ™å¼•æ“ã€æ™ºèƒ½ç¼“å­˜ç­‰åŠŸèƒ½ã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸ´ **è§’è‰²å¡ç®¡ç†** - æ”¯æŒ PNG/JSON æ ¼å¼è§’è‰²å¡çš„æµè§ˆã€ç¼–è¾‘ã€å¯¼å…¥å¯¼å‡º
- ğŸ“š **ä¸–ç•Œä¹¦ç®¡ç†** - ç»Ÿä¸€ç®¡ç†å…¨å±€ä¸–ç•Œä¹¦ã€èµ„æºç›®å½•ä¸–ç•Œä¹¦å’Œå†…åµŒä¸–ç•Œä¹¦
- ğŸ¤– **è‡ªåŠ¨åŒ–å¼•æ“** - åŸºäºè§„åˆ™çš„è‡ªåŠ¨åŒ–ä»»åŠ¡æ‰§è¡Œï¼Œæ”¯æŒå¤æ‚çš„æ¡ä»¶åˆ¤æ–­
- ğŸ”„ **å®æ—¶åŒæ­¥** - æ–‡ä»¶ç³»ç»Ÿè‡ªåŠ¨ç›‘å¬ï¼Œå®æ—¶åŒæ­¥å˜æ›´åˆ°æ•°æ®åº“
- ğŸ¨ **å¯è§†åŒ–ç•Œé¢** - ç°ä»£åŒ–å“åº”å¼ UIï¼Œæ”¯æŒæš—è‰²/äº®è‰²ä¸»é¢˜
- ğŸ“¦ **ç‰ˆæœ¬ç®¡ç†** - æ”¯æŒè§’è‰²å¡ Bundle å¤šç‰ˆæœ¬ç®¡ç†
- ğŸ·ï¸ **æ ‡ç­¾ç³»ç»Ÿ** - å¼ºå¤§çš„æ ‡ç­¾è¿‡æ»¤å’Œæ‰¹é‡æ ‡ç­¾ç®¡ç†
- ğŸ” **æ™ºèƒ½æœç´¢** - æ”¯æŒåç§°ã€æ–‡ä»¶åã€æ ‡ç­¾ã€åˆ›ä½œè€…ç­‰å¤šç»´åº¦æœç´¢
- ğŸ“ **é¢„è®¾ç®¡ç†** - ç®¡ç† SillyTavern ç”Ÿæˆå‚æ•°é¢„è®¾ï¼ˆJSONï¼‰å¹¶æ”¯æŒä¸Šä¼ /æŸ¥çœ‹
- ğŸ”— **é…’é¦†èµ„æºåŒæ­¥** - ä»æœ¬åœ° SillyTavern è¯»å–å¹¶åŒæ­¥è§’è‰²å¡ã€ä¸–ç•Œä¹¦ã€é¢„è®¾ã€æ­£åˆ™ã€å¿«é€Ÿå›å¤
- ğŸ§© **æ­£åˆ™æ±‡æ€»** - æ”¯æŒè¯»å–å…¨å±€æ­£åˆ™ä¸é¢„è®¾ç»‘å®šæ­£åˆ™å¹¶æ±‡æ€»å±•ç¤º

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.10 æˆ–æ›´é«˜ç‰ˆæœ¬
- pip åŒ…ç®¡ç†å™¨

### å®‰è£…æ­¥éª¤

1. **å…‹éš†ä»“åº“**

```bash
git clone https://github.com/Dadihu123/st-manager.git
cd st-manager
```

2. **å®‰è£…ä¾èµ–**

```bash
pip install -r requirements.txt
```

3. **è¿è¡Œç¨‹åº**

```bash
python app.py
```

4. **è®¿é—®ç•Œé¢**

ç¨‹åºå¯åŠ¨åä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://127.0.0.1:5000`

### Docker éƒ¨ç½²ï¼ˆæ¨èï¼‰

1. **ä½¿ç”¨ Docker Compose**

```bash
docker-compose up -d
```

2. **è®¿é—®æœåŠ¡**

æœåŠ¡å°†åœ¨ `http://localhost:5000` ä¸Šè¿è¡Œ

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
ST-Manager/
â”œâ”€â”€ app.py                      # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ config.json                 # é…ç½®æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”œâ”€â”€ requirements.txt            # Python ä¾èµ–
â”œâ”€â”€ Dockerfile                  # Docker é•œåƒæ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yaml         # Docker Compose é…ç½®
â”œâ”€â”€ AGENTS.md                   # AI åŠ©æ‰‹æŒ‡å—
â”‚
â”œâ”€â”€ core/                       # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ __init__.py            # æ¨¡å—åˆå§‹åŒ–
â”‚   â”œâ”€â”€ config.py              # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ consts.py              # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ context.py             # å…¨å±€ä¸Šä¸‹æ–‡ï¼ˆSingletonï¼‰
â”‚   â”œâ”€â”€ event_bus.py           # äº‹ä»¶æ€»çº¿
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                   # API è·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ views.py          # é¡µé¢è§†å›¾
â”‚   â”‚   â””â”€â”€ v1/               # API v1
â”‚   â”‚       â”œâ”€â”€ cards.py      # è§’è‰²å¡ API
â”‚   â”‚       â”œâ”€â”€ world_info.py # ä¸–ç•Œä¹¦ API
â”‚   â”‚       â”œâ”€â”€ system.py     # ç³»ç»Ÿ API
â”‚   â”‚       â”œâ”€â”€ resources.py  # èµ„æº API
â”‚   â”‚       â”œâ”€â”€ automation.py # è‡ªåŠ¨åŒ– API
â”‚   â”‚       â””â”€â”€ extensions.py # æ‰©å±• API
â”‚   â”‚       â””â”€â”€ presets.py    # é¢„è®¾ API
â”‚   â”‚
â”‚   â”œâ”€â”€ services/              # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ scan_service.py   # æ–‡ä»¶æ‰«ææœåŠ¡
â”‚   â”‚   â”œâ”€â”€ cache_service.py  # ç¼“å­˜ç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ card_service.py   # å¡ç‰‡ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â””â”€â”€ automation_service.py # è‡ªåŠ¨åŒ–æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ automation/            # è‡ªåŠ¨åŒ–å¼•æ“
â”‚   â”‚   â”œâ”€â”€ engine.py         # è§„åˆ™å¼•æ“æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ manager.py        # è§„åˆ™é›†ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ executor.py       # è§„åˆ™æ‰§è¡Œå™¨
â”‚   â”‚   â””â”€â”€ constants.py      # å¸¸é‡å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ data/                  # æ•°æ®å±‚
â”‚   â”‚   â”œâ”€â”€ db_session.py     # æ•°æ®åº“ä¼šè¯
â”‚   â”‚   â”œâ”€â”€ cache.py          # å…¨å±€ç¼“å­˜
â”‚   â”‚   â””â”€â”€ ui_store.py       # UI æ•°æ®å­˜å‚¨
â”‚   â”‚
â”‚   â””â”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ data.py           # æ•°æ®å¤„ç†å·¥å…·
â”‚       â”œâ”€â”€ filesystem.py     # æ–‡ä»¶ç³»ç»Ÿå·¥å…·
â”‚       â”œâ”€â”€ image.py          # å›¾ç‰‡å¤„ç†å·¥å…·
â”‚       â”œâ”€â”€ text.py           # æ–‡æœ¬å¤„ç†å·¥å…·
â”‚       â”œâ”€â”€ hash.py           # å“ˆå¸Œè®¡ç®—å·¥å…·
â”‚       â””â”€â”€ net.py            # ç½‘ç»œå·¥å…·
â”‚
â”œâ”€â”€ templates/                 # HTML æ¨¡æ¿
â”‚   â”œâ”€â”€ layout.html           # ä¸»å¸ƒå±€
â”‚   â”œâ”€â”€ index.html            # é¦–é¡µ
â”‚   â”œâ”€â”€ components/            # ç»„ä»¶æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ header.html
â”‚   â”‚   â”œâ”€â”€ sidebar.html
â”‚   â”‚   â”œâ”€â”€ grid_cards.html
â”‚   â”‚   â”œâ”€â”€ grid_wi.html
â”‚   â”‚   â””â”€â”€ grid_extensions.html
â”‚   â”‚   â””â”€â”€ grid_presets.html
â”‚   â””â”€â”€ modals/               # æ¨¡æ€æ¡†æ¨¡æ¿
â”‚       â”œâ”€â”€ detail_card.html
â”‚       â”œâ”€â”€ detail_wi_fullscreen.html
â”‚       â”œâ”€â”€ detail_wi_popup.html
â”‚       â”œâ”€â”€ settings.html
â”‚       â”œâ”€â”€ advanced_editor.html
â”‚       â”œâ”€â”€ automation.html
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ static/                    # é™æ€èµ„æº
â”‚   â”œâ”€â”€ css/                  # æ ·å¼æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ modules/
â”‚   â”œâ”€â”€ js/                   # JavaScript æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚   â””â”€â”€ components/presetGrid.js
â”‚   â””â”€â”€ lib/                  # ç¬¬ä¸‰æ–¹åº“
â”‚       â”œâ”€â”€ alpine.js
â”‚       â”œâ”€â”€ tailwindcss.js
â”‚       â”œâ”€â”€ marked.min.js
â”‚       â””â”€â”€ diff.min.js
â”‚
â””â”€â”€ data/                      # æ•°æ®ç›®å½•ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆï¼‰
    â”œâ”€â”€ system/               # ç³»ç»Ÿæ•°æ®
    â”‚   â”œâ”€â”€ db/              # æ•°æ®åº“
    â”‚   â”œâ”€â”€ thumbnails/      # ç¼©ç•¥å›¾
    â”‚   â”œâ”€â”€ trash/           # å›æ”¶ç«™
    â”‚   â””â”€â”€ automation/      # è‡ªåŠ¨åŒ–è§„åˆ™
    â”œâ”€â”€ library/              # èµ„æºåº“
    â”‚   â”œâ”€â”€ characters/      # è§’è‰²å¡ç›®å½•
    â”‚   â”œâ”€â”€ lorebooks/       # ä¸–ç•Œä¹¦ç›®å½•
    â”‚   â””â”€â”€ extensions/      # æ‰©å±•è„šæœ¬
    â”‚   â””â”€â”€ presets/         # é¢„è®¾ç›®å½•
    â””â”€â”€ temp/                # ä¸´æ—¶æ–‡ä»¶
```

---

## âš™ï¸ é…ç½®è¯´æ˜

ç¨‹åºé¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆ `config.json` é…ç½®æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦é…ç½®é¡¹ï¼š

### åŸºç¡€é…ç½®

```json
{
  "host": "127.0.0.1",
  "port": 5000,
  "dark_mode": true,
  "theme_accent": "blue"
}
```

### ç›®å½•é…ç½®

```json
{
  "cards_dir": "data/library/characters",
  "world_info_dir": "data/library/lorebooks",
  "regex_dir": "data/library/extensions/regex",
  "scripts_dir": "data/library/extensions/tavern_helper",
  "quick_replies_dir": "data/library/extensions/quick-replies",
  "presets_dir": "data/library/presets",
  "resources_dir": "data/assets/card_assets"
}
```

### SillyTavern æœ¬åœ°è·¯å¾„é…ç½®

```json
{
  "st_url": "http://127.0.0.1:8000",
  "st_data_dir": "",
  "st_auth_type": "basic",
  "st_username": "",
  "st_password": "",
  "st_proxy": ""
}
```

`st_data_dir` ç•™ç©ºæ—¶ä¼šè‡ªåŠ¨æ¢æµ‹å¸¸è§å®‰è£…è·¯å¾„ï¼ˆWindows: D:\SillyTavern / E:\SillyTavern ç­‰ï¼‰ã€‚
```

### SillyTavern é›†æˆ

```json
{
  "st_url": "http://127.0.0.1:8000",
  "st_auth_type": "basic",
  "st_username": "",
  "st_password": "",
  "st_proxy": ""
}
```

### æ˜¾ç¤ºè®¾ç½®

```json
{
  "default_sort": "date_desc",
  "items_per_page": 0,
  "items_per_page_wi": 0,
  "card_width": 220,
  "font_style": "sans",
  "bg_url": "/assets/backgrounds/default_background.jpeg",
  "bg_opacity": 0.45,
  "bg_blur": 2
}
```

### è‡ªåŠ¨ä¿å­˜è®¾ç½®

```json
{
  "auto_save_enabled": false,
  "auto_save_interval": 3,
  "snapshot_limit_manual": 50,
  "snapshot_limit_auto": 5
}
```

### ç³»ç»Ÿè®¾ç½®

```json
{
  "enable_auto_scan": true,
  "png_deterministic_sort": false,
  "allowed_abs_resource_roots": [],
  "wi_preview_limit": 300,
  "wi_preview_entry_max_chars": 2000
}
```

#### è¯´æ˜
- `png_deterministic_sort`ï¼šæ˜¯å¦å¯¹ PNG å…ƒæ•°æ®è¿›è¡Œç¡®å®šæ€§æ’åºï¼ˆé»˜è®¤å…³é—­ï¼Œé¿å…æ”¹å˜å¤–éƒ¨å·¥å…·çš„å­—èŠ‚çº§è¡Œä¸ºï¼‰
- `allowed_abs_resource_roots`ï¼šå…è®¸è®¿é—®çš„ç»å¯¹èµ„æºç›®å½•ç™½åå•ï¼ˆç”¨äºèµ„æºæ–‡ä»¶åˆ—è¡¨æ¥å£ï¼‰
- `wi_preview_limit`ï¼šä¸–ç•Œä¹¦è¯¦æƒ…é¢„è§ˆæœ€å¤§æ¡ç›®æ•°ï¼ˆ0 è¡¨ç¤ºä¸é™åˆ¶ï¼‰
- `wi_preview_entry_max_chars`ï¼šä¸–ç•Œä¹¦å•æ¡å†…å®¹é¢„è§ˆæœ€å¤§å­—ç¬¦æ•°ï¼ˆ0 è¡¨ç¤ºä¸æˆªæ–­ï¼‰

---

## ğŸ¯ åŠŸèƒ½è¯¦è§£

### è§’è‰²å¡ç®¡ç†

#### æ”¯æŒçš„æ ¼å¼
- **PNG å¡ç‰‡** - åŒ…å«åµŒå…¥å¼å…ƒæ•°æ®çš„ PNG å›¾ç‰‡
- **JSON å¡ç‰‡** - ç‹¬ç«‹çš„ JSON æ ¼å¼è§’è‰²æ–‡ä»¶
- **ä¼´ç”Ÿå›¾ç‰‡** - æ”¯æŒ PNG/JSON é…å¥—çš„ä¼´ç”Ÿå›¾ç‰‡

#### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æè¿° |
|------|------|
| **æµè§ˆæŸ¥çœ‹** | ç½‘æ ¼/åˆ—è¡¨è§†å›¾ï¼Œæ”¯æŒç¼©ç•¥å›¾é¢„è§ˆ |
| **ç¼–è¾‘ä¿®æ”¹** | æ”¯æŒç¼–è¾‘è§’è‰²åç§°ã€æè¿°ã€äººæ ¼ã€åœºæ™¯ç­‰æ‰€æœ‰å­—æ®µ |
| **å¯¼å…¥å¯¼å‡º** | æ”¯æŒä» URL å¯¼å…¥ã€æ–‡ä»¶ä¸Šä¼ ã€å¯¼å‡º |
| **æ‰¹é‡æ“ä½œ** | æ‰¹é‡ç§»åŠ¨ã€åˆ é™¤ã€æ ‡ç­¾ç®¡ç† |
| **æ”¶è—æ ‡è®°** | å¿«é€Ÿæ”¶è—å¸¸ç”¨è§’è‰² |
| **æœç´¢è¿‡æ»¤** | å¤šç»´åº¦æœç´¢å’Œæ ‡ç­¾è¿‡æ»¤ |
| **Bundle ç®¡ç†** | æ”¯æŒå¤šç‰ˆæœ¬è§’è‰²èšåˆæ˜¾ç¤º |

#### Token è®¡ç®—

è‡ªåŠ¨è®¡ç®—è§’è‰²å¡çš„æ€» Token æ•°é‡ï¼ˆåŒ…æ‹¬æè¿°ã€äººæ ¼ã€æ¶ˆæ¯ç¤ºä¾‹ã€ä¸–ç•Œä¹¦ç­‰ï¼‰ï¼Œå¸®åŠ©ç”¨æˆ·äº†è§£èµ„æºæ¶ˆè€—ã€‚

---

### ä¸–ç•Œä¹¦ç®¡ç†

#### ä¸–ç•Œä¹¦ç±»å‹

| ç±»å‹ | è¯´æ˜ |
|------|------|
| **å…¨å±€ä¸–ç•Œä¹¦** | å­˜å‚¨åœ¨ `lorebooks/` ç›®å½•ï¼Œå…¨å±€å…±äº« |
| **èµ„æºä¸–ç•Œä¹¦** | å­˜å‚¨åœ¨è§’è‰²èµ„æºç›®å½•çš„ `lorebooks/` å­ç›®å½• |
| **å†…åµŒä¸–ç•Œä¹¦** | ç›´æ¥åµŒå…¥åœ¨è§’è‰²å¡æ–‡ä»¶ä¸­çš„ä¸–ç•Œä¹¦ |

#### æ ¸å¿ƒåŠŸèƒ½

- ğŸ“‘ ç»Ÿä¸€æµè§ˆæ‰€æœ‰ç±»å‹çš„ä¸–ç•Œä¹¦
- âœï¸ åœ¨çº¿ç¼–è¾‘ä¸–ç•Œä¹¦å†…å®¹
- ğŸ“‹ ä¸–ç•Œä¹¦å‰ªåˆ‡æ¿ï¼ˆæš‚å­˜ã€æ’åºï¼‰
- ğŸ“¤ å¯¼å‡ºä¸–ç•Œä¹¦ä¸ºç‹¬ç«‹ JSON æ–‡ä»¶
- ğŸ”— ä¸è§’è‰²å¡å…³è”æ˜¾ç¤º
- ğŸ”„ ä¸€é”®æ•´ç†èµ„æºç›®å½•ç»“æ„
- âš¡ å¤§å‹ä¸–ç•Œä¹¦é¢„è§ˆä¼˜åŒ–ï¼šè¯¦æƒ…å¼¹çª—é»˜è®¤é¢„è§ˆå‰ 300 æ¡ï¼Œé¿å…å¡æ­»ï¼ˆå¯æ‰‹åŠ¨åŠ è½½å…¨éƒ¨ï¼‰
- ğŸ§¹ å…¨å±€åˆ—è¡¨å»é‡ï¼šè‡ªåŠ¨å‰”é™¤ä¸å†…åµŒä¸–ç•Œä¹¦å†…å®¹é‡å¤çš„æ¡ç›®ï¼Œé¿å…æ··æ‚å±•ç¤º

---

### è‡ªåŠ¨åŒ–è§„åˆ™å¼•æ“

#### è§„åˆ™å¼•æ“æ¦‚è¿°

ST-Manager å†…ç½®å¼ºå¤§çš„è§„åˆ™å¼•æ“ï¼Œæ”¯æŒåŸºäºæ¡ä»¶çš„è‡ªåŠ¨åŒ–ä»»åŠ¡æ‰§è¡Œã€‚ç”¨æˆ·å¯ä»¥å®šä¹‰è§„åˆ™é›†ï¼Œå½“å¡ç‰‡æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶è‡ªåŠ¨æ‰§è¡Œé¢„è®¾æ“ä½œã€‚

#### è§„åˆ™ç»“æ„

```json
{
  "spec": "st_manager_ruleset",
  "spec_version": "1.0",
  "meta": {
    "name": "è§„åˆ™é›†åç§°",
    "description": "è§„åˆ™é›†æè¿°",
    "author": "ä½œè€…"
  },
  "logic": "OR",
  "rules": [
    {
      "name": "è§„åˆ™åç§°",
      "enabled": true,
      "logic": "OR",
      "groups": [
        {
          "logic": "AND",
          "conditions": [
            {
              "field": "char_name",
              "operator": "contains",
              "value": "å…³é”®è¯"
            }
          ]
        }
      ],
      "actions": [
        {
          "type": "set_tag",
          "value": "æ ‡ç­¾åç§°"
        }
      ],
      "stop_on_match": false
    }
  ]
}
```

#### æ”¯æŒçš„å­—æ®µ

- `char_name` - è§’è‰²åç§°
- `description` - è§’è‰²æè¿°
- `creator` - åˆ›ä½œè€…
- `tags` - æ ‡ç­¾åˆ—è¡¨
- `token_count` - Token æ•°é‡
- `character_book` - ä¸–ç•Œä¹¦
- `extensions.regex_scripts` - æ­£åˆ™è„šæœ¬
- `extensions.tavern_helper` - Tavern Helper è„šæœ¬

#### æ”¯æŒçš„æ“ä½œç¬¦

| æ“ä½œç¬¦ | è¯´æ˜ |
|--------|------|
| `exists` | å­—æ®µå­˜åœ¨ |
| `not_exists` | å­—æ®µä¸å­˜åœ¨ |
| `eq` | ç­‰äº |
| `neq` | ä¸ç­‰äº |
| `contains` | åŒ…å« |
| `not_contains` | ä¸åŒ…å« |
| `gt` | å¤§äº |
| `lt` | å°äº |
| `regex` | æ­£åˆ™åŒ¹é… |
| `true` / `false` | å¸ƒå°”åˆ¤æ–­ |

#### æ”¯æŒçš„åŠ¨ä½œ

- `set_tag` - æ·»åŠ æ ‡ç­¾
- `remove_tag` - ç§»é™¤æ ‡ç­¾
- `set_favorite` - è®¾ä¸ºæ”¶è—
- `unset_favorite` - å–æ¶ˆæ”¶è—
- `set_summary` - è®¾ç½®å¤‡æ³¨
- `set_resource_folder` - è®¾ç½®èµ„æºç›®å½•

---

### æ‰©å±•è„šæœ¬ç®¡ç†

æ”¯æŒç®¡ç† SillyTavern çš„æ‰©å±•è„šæœ¬ï¼š

#### æ­£åˆ™è„šæœ¬ï¼ˆRegex Scriptsï¼‰
- æµè§ˆå’Œç¼–è¾‘æ­£åˆ™æ›¿æ¢è„šæœ¬
- æ”¯æŒæ‰¹é‡å¯¼å…¥å¯¼å‡º

#### Tavern Helper è„šæœ¬
- ç®¡ç† Tavern Helper è„šæœ¬åº“
- æ”¯æŒå˜é‡å’Œè„šæœ¬é…ç½®

#### å¿«é€Ÿå›å¤ï¼ˆQuick Repliesï¼‰
- å¿«é€Ÿå›å¤æ¨¡æ¿ç®¡ç†
- æ”¯æŒåˆ†ç±»å’Œæœç´¢

#### é¢„è®¾ï¼ˆPresetsï¼‰
- ç®¡ç†ç”Ÿæˆå‚æ•°é¢„è®¾ï¼ˆJSONï¼‰
- æ”¯æŒæ‹–æ‹½ä¸Šä¼ ã€æŸ¥çœ‹ä¸åŸºç¡€ä¿¡æ¯å±•ç¤º

### SillyTavern æœ¬åœ°èµ„æºè¯»å–ä¸åŒæ­¥

åœ¨è®¾ç½® â†’ è¿æ¥ä¸æœåŠ¡ä¸­é…ç½® SillyTavern å®‰è£…ç›®å½•ï¼Œå¯æ‰§è¡Œï¼š

- ğŸ” è‡ªåŠ¨æ¢æµ‹æœ¬åœ° SillyTavern è·¯å¾„
- ğŸ“Š æ˜¾ç¤ºæ£€æµ‹åˆ°çš„èµ„æºæ•°é‡
- ğŸ”„ ä¸€é”®åŒæ­¥è§’è‰²å¡ã€ä¸–ç•Œä¹¦ã€é¢„è®¾ã€æ­£åˆ™è„šæœ¬ã€å¿«é€Ÿå›å¤åˆ° ST-Manager
- ğŸ”§ æ­£åˆ™åŒæ­¥ä¼šå¯¼å‡º settings.json ä¸­çš„å…¨å±€æ­£åˆ™åˆ°æœ¬åœ° regex ç›®å½•ï¼ˆä»¥ `global__*.json` å‘½åï¼‰

---

### ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–

#### å…¨å±€å…ƒæ•°æ®ç¼“å­˜

- **å†…å­˜ç¼“å­˜** - æ‰€æœ‰å¡ç‰‡å…ƒæ•°æ®åŠ è½½åˆ°å†…å­˜ï¼Œå®ç°æ¯«ç§’çº§æŸ¥è¯¢
- **å¢é‡æ›´æ–°** - å•å¡ç¼–è¾‘æ—¶ä»…æ›´æ–°å†…å­˜ï¼Œæ— éœ€é‡è½½
- **åˆ†ç±»è®¡æ•°** - å®æ—¶ç»´æŠ¤åˆ†ç±»ç»Ÿè®¡
- **æ ‡ç­¾æ± ** - å…¨å±€æ ‡ç­¾ç´¢å¼•

#### æ–‡ä»¶ç³»ç»Ÿç›‘å¬

ä½¿ç”¨ `watchdog` åº“å®æ—¶ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼š
- è‡ªåŠ¨åŒæ­¥æ–°å¢æ–‡ä»¶
- è‡ªåŠ¨æ›´æ–°ä¿®æ”¹æ–‡ä»¶
- è‡ªåŠ¨æ¸…ç†åˆ é™¤æ–‡ä»¶
- é˜²æŠ–å¤„ç†ï¼Œé¿å…é‡å¤æ‰«æ

#### ç¼©ç•¥å›¾ç³»ç»Ÿ

- è‡ªåŠ¨ç”Ÿæˆå¡ç‰‡ç¼©ç•¥å›¾ï¼ˆåå°çº¿ç¨‹ï¼‰
- æ”¯æŒ PNGã€JPEG æ ¼å¼
- å¹¶å‘æ§åˆ¶ï¼ˆé»˜è®¤ 4 çº¿ç¨‹ï¼‰
- æ™ºèƒ½æ¸…ç†æ— æ•ˆç¼“å­˜

---

## ğŸ”Œ API æ–‡æ¡£

### è§’è‰²å¡ API

#### è·å–å¡ç‰‡åˆ—è¡¨

```
GET /api/list_cards?page=1&page_size=20&category=&tags=&search=&sort=date_desc
```

#### æ›´æ–°å¡ç‰‡

```
POST /api/update_card
Content-Type: application/json

{
  "id": "å¡ç‰‡ID",
  "char_name": "è§’è‰²åç§°",
  "description": "æè¿°",
  "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2"],
  ...
}
```

#### ç§»åŠ¨å¡ç‰‡

```
POST /api/move_card
Content-Type: application/json

{
  "target_category": "ç›®æ ‡åˆ†ç±»",
  "card_ids": ["å¡ç‰‡ID1", "å¡ç‰‡ID2"]
}
```

#### åˆ é™¤å¡ç‰‡

```
POST /api/delete_cards
Content-Type: application/json

{
  "card_ids": ["å¡ç‰‡ID1", "å¡ç‰‡ID2"]
}
```

### ä¸–ç•Œä¹¦ API

#### è·å–ä¸–ç•Œä¹¦åˆ—è¡¨

```
GET /api/world_info/list?type=all&search=&page=1&page_size=20
```

#### ä¸Šä¼ ä¸–ç•Œä¹¦

```
POST /api/upload_world_info
Content-Type: multipart/form-data

files: [worldbook1.json, worldbook2.json]
```

#### è·å–ä¸–ç•Œä¹¦è¯¦æƒ…

```
POST /api/world_info/detail
Content-Type: application/json

{
  "id": "world_info_id",
  "source_type": "global",
  "file_path": "/path/to/file.json",
  "preview_limit": 300,
  "force_full": false
}
```

### SillyTavern æ­£åˆ™æ±‡æ€» API

```
GET /api/st/regex
```

### è‡ªåŠ¨åŒ– API

#### è·å–è§„åˆ™é›†åˆ—è¡¨

```
GET /api/automation/rulesets
```

#### æ‰§è¡Œè§„åˆ™

```
POST /api/automation/execute
Content-Type: application/json

{
  "ruleset_id": "ruleset_id",
  "card_ids": ["card_id1", "card_id2"]
}
```

### ç³»ç»Ÿ API

#### è·å–ç³»ç»ŸçŠ¶æ€

```
GET /api/system/status
```

#### æ‰«ææ–‡ä»¶ç³»ç»Ÿ

```
POST /api/system/scan
Content-Type: application/json

{
  "full_scan": true
}
```

---

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### å¼€å‘ç¯å¢ƒè®¾ç½®

1. **å®‰è£…å¼€å‘ä¾èµ–**

```bash
pip install -r requirements.txt
pip install black flake8 mypy pylint
```

2. **å¯åŠ¨è°ƒè¯•æ¨¡å¼**

```bash
python app.py --debug
# æˆ–
FLASK_DEBUG=1 python app.py
```

è°ƒè¯•æ¨¡å¼ä¼šå¯ç”¨çƒ­é‡è½½ï¼Œä¿®æ”¹ä»£ç åè‡ªåŠ¨é‡å¯ã€‚

### ä»£ç é£æ ¼

é¡¹ç›®éµå¾ªä»¥ä¸‹ä»£ç è§„èŒƒï¼š

#### Python ä»£ç é£æ ¼

```python
# å¯¼å…¥é¡ºåºï¼šæ ‡å‡†åº“ -> ç¬¬ä¸‰æ–¹åº“ -> æœ¬åœ°æ¨¡å—
import os
import sys
import json

from flask import Blueprint, request, jsonify

from core.config import CARDS_FOLDER, load_config
from core.utils.image import extract_card_info


# å‘½åçº¦å®š
class ClassName:        # PascalCase
def function_name():    # snake_case
CONSTANT_VALUE = 1      # UPPER_CASE
_private_method()      # _leading_underscore


# ç±»å‹æç¤ºï¼ˆæ¨èï¼‰
def process_card(card_id: str, data: dict) -> bool:
    """å¤„ç†è§’è‰²å¡æ•°æ®"""
    try:
        # ä¸šåŠ¡é€»è¾‘
        return True
    except Exception as e:
        logger.error(f"Failed to process card: {e}")
        return False


# é”™è¯¯å¤„ç†
try:
    with open(filepath, 'r', encoding='utf-8') as f:
        data = json.load(f)
except FileNotFoundError:
    logger.error(f"File not found: {filepath}")
    return None
except json.JSONDecodeError as e:
    logger.error(f"Invalid JSON: {e}")
    return None
```

#### å‰ç«¯ä»£ç é£æ ¼

```javascript
// ä½¿ç”¨æ¨¡å—åŒ–
import { Alpine } from 'alpinejs';
import { marked } from 'marked';

// æ•°æ®å‡½æ•°
function cardData() {
    return {
        loading: false,
        cards: [],
        selectedIds: [],
        
        async loadCards() {
            this.loading = true;
            try {
                const response = await fetch('/api/list_cards');
                const data = await response.json();
                this.cards = data.cards;
            } catch (error) {
                console.error('Failed to load cards:', error);
            } finally {
                this.loading = false;
            }
        },
        
        toggleSelect(id) {
            const idx = this.selectedIds.indexOf(id);
            if (idx > -1) {
                this.selectedIds.splice(idx, 1);
            } else {
                this.selectedIds.push(id);
            }
        }
    };
}
```

### æ•°æ®åº“ç»“æ„

#### å¡ç‰‡å…ƒæ•°æ®è¡¨ï¼ˆcard_metadataï¼‰

```sql
CREATE TABLE card_metadata (
    id TEXT PRIMARY KEY,
    filename TEXT NOT NULL,
    char_name TEXT,
    description TEXT,
    tags TEXT,
    token_count INTEGER,
    file_size INTEGER,
    file_hash TEXT,
    last_modified REAL,
    category TEXT,
    char_version TEXT,
    creator TEXT,
    is_favorite INTEGER DEFAULT 0,
    has_character_book INTEGER DEFAULT 0,
    character_book_name TEXT
);
```

#### ä¸–ç•Œä¹¦å‰ªåˆ‡æ¿è¡¨ï¼ˆwi_clipboardï¼‰

```sql
CREATE TABLE wi_clipboard (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    content_json TEXT NOT NULL,
    sort_order INTEGER DEFAULT 0,
    created_at REAL DEFAULT (strftime('%s', 'now'))
);
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/

# è¿è¡Œå•ä¸ªæµ‹è¯•
pytest tests/test_card_service.py::test_extract_card_info
```

### ä»£ç è´¨é‡æ£€æŸ¥

```bash
# æ ¼å¼åŒ–ä»£ç 
black .

# æ£€æŸ¥ä»£ç é£æ ¼
flake8 .

# ç±»å‹æ£€æŸ¥
mypy core/
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. ç«¯å£è¢«å ç”¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
âŒ å¯åŠ¨å¤±è´¥ï¼šåœ°å€ 127.0.0.1:5000 å·²è¢«å ç”¨ï¼
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å…³é—­å…¶ä»–å ç”¨ç«¯å£çš„ç¨‹åº
- ä¿®æ”¹ `config.json` ä¸­çš„ `port` è®¾ç½®ä¸ºå…¶ä»–ç«¯å£

#### 2. æ•°æ®åº“é”å®š

**é”™è¯¯ä¿¡æ¯**ï¼š
```
database is locked
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å…³é—­æ‰€æœ‰ ST-Manager å®ä¾‹
- åˆ é™¤ `data/system/db/cards_metadata.db-wal` å’Œ `-shm` æ–‡ä»¶
- é‡å¯ç¨‹åº

#### 3. ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥

**ç—‡çŠ¶**ï¼šå¡ç‰‡ç¼©ç•¥å›¾æ˜¾ç¤ºä¸ºç©ºç™½

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶æ˜¯å¦æŸå
- æ¸…ç©º `data/system/thumbnails/` ç›®å½•
- é‡å¯ç¨‹åºé‡æ–°ç”Ÿæˆ

#### 4. è‡ªåŠ¨æ‰«æä¸å·¥ä½œ

**ç—‡çŠ¶**ï¼šæ–‡ä»¶ä¿®æ”¹åç•Œé¢ä¸æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ `config.json` ä¸­ `enable_auto_scan` æ˜¯å¦ä¸º `true`
- æ£€æŸ¥æ˜¯å¦å®‰è£…äº† `watchdog` åº“
- æ‰‹åŠ¨è§¦å‘æ‰«æï¼šç³»ç»Ÿè®¾ç½® â†’ æ‰«ææ–‡ä»¶ç³»ç»Ÿ

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç ã€æŠ¥å‘Šé—®é¢˜æˆ–æå‡ºå»ºè®®ï¼

### è´¡çŒ®æµç¨‹

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

### å¼€å‘è§„èŒƒ

- éµå¾ªç°æœ‰çš„ä»£ç é£æ ¼
- ä¸ºæ–°åŠŸèƒ½æ·»åŠ æµ‹è¯•
- æ›´æ–°ç›¸å…³æ–‡æ¡£
- ç¼–å†™æ¸…æ™°çš„æäº¤ä¿¡æ¯

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

---

## ğŸ™ è‡´è°¢

- [SillyTavern](https://github.com/SillyTavern/SillyTavern) - æœ¬é¡¹ç›®ç®¡ç†çš„ç›®æ ‡ç¨‹åº
- [Flask](https://flask.palletsprojects.com/) - Web æ¡†æ¶
- [Tailwind CSS](https://tailwindcss.com/) - CSS æ¡†æ¶
- [Alpine.js](https://alpinejs.dev/) - è½»é‡çº§ JavaScript æ¡†æ¶

---

## ğŸ“® è”ç³»æ–¹å¼

- é—®é¢˜åé¦ˆï¼š[GitHub Issues](https://github.com/Dadihu123/ST-Manager/issues)
- åŠŸèƒ½å»ºè®®ï¼š[Discord ç±»è„‘](https://discord.com/channels/1134557553011998840/1448353646596325578)

---

<div align="center">

**å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ª â­ï¸ Star æ”¯æŒä¸€ä¸‹ï¼**

Made with â¤ï¸ by ST-Manager Team

</div>
