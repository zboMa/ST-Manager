<div class="header-bar" x-data="header">
    <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div class="app-icon"
                style="background: linear-gradient(135deg, var(--accent-main), #7c3aed); border-radius: 8px; padding: 0.5rem;">
                <span style="font-size: 1.5rem;">🎴</span>
            </div>
            <div>
                <span style="font-weight: bold; font-size: 1.125rem; white-space: nowrap;">ST Manager</span>
                <span
                    style="font-size: 0.75rem; background: var(--accent-main); color: white; padding:2px 6px; border-radius:4px; margin-left: 0.25rem;">v70</span>
            </div>
        </div>

        <!-- 递归过滤开关 - 添加动画效果 -->
        <div x-show="currentMode === 'cards'"
            class="filter-toggle flex items-center gap-2 ml-4 px-3 py-1.5 rounded-full border shadow-sm transition-all duration-300"
            :class="recursiveFilter ? 'bg-accent-faint border-accent-main' : 'bg-bg-sub border-border-light'"
            @click="recursiveFilter = !recursiveFilter; fetchCards()">
            <span class="text-xs cursor-pointer select-none font-medium" style="color: var(--text-sub);">
                包含子目录
            </span>
            <button type="button"
                class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out"
                :style="{ backgroundColor: recursiveFilter ? 'var(--accent-main)' : 'var(--bg-hover)' }" role="switch"
                :aria-checked="recursiveFilter">
                <span aria-hidden="true"
                    class="pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                    :class="recursiveFilter ? 'translate-x-4' : 'translate-x-0'">
                </span>
            </button>
        </div>

        <!-- 筛选标签云 - 添加悬停效果 -->
        <div style="display: flex; gap: 0.5rem; overflow-x: auto; margin-left: 1rem; flex: 1;" class="custom-scrollbar">
            <template x-for="tag in filterTags" :key="tag">
                <div class="filter-chip hover:scale-105 transition-transform" @click="toggleFilterTag(tag)">
                    <span x-text="tag"></span><span style="opacity: 0.8;">✕</span>
                </div>
            </template>
        </div>
    </div>

    <!-- 顶部右侧 - 优化布局和视觉效果 -->
    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <!-- 选中状态栏 -->
        <div x-show="selectedIds.length > 0"
            class="selection-bar flex items-center gap-4 border px-3 py-1.5 rounded-lg mr-2 relative"
            style="background-color: var(--accent-faint); border-color: var(--accent-light); z-index: 50; overflow: visible;">
            <button @click.stop="openBatchTagModal()" class="text-xs px-2 py-1 rounded text-white"
                style="background-color: #7c3aed; transition: all 0.2s;">
                批量标签
            </button>
            <button @click="deleteSelectedCards()"
                class="text-xs bg-red-800 hover:bg-red-700 px-2 py-1 rounded text-white border border-red-600/50 transition-all">
                🗑️ 移至回收站
            </button>
            <span class="text-sm text-accent">已选 <span x-text="selectedIds.length" class="font-bold"></span></span>
            <button @click="selectedIds = []" class="text-xs hover:text-white cursor-pointer"
                style="color: var(--text-sub);">取消</button>
            <!-- 批量执行规则按钮 -->
            <div x-data="{ showRuleMenu: false }" class="relative">
                <button @click="showRuleMenu = !showRuleMenu"
                    class="text-xs px-2 py-1 rounded text-white bg-yellow-600 hover:bg-yellow-500 transition-all flex items-center gap-1">
                    <span>⚡</span> 自动处理
                </button>
                <!-- 下拉菜单：列出可用规则集 -->
                <div x-show="showRuleMenu" @click.away="showRuleMenu = false"
                    x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95"
                    x-transition:enter-end="opacity-100 scale-100"
                    class="absolute top-full left-0 mt-2 w-56 bg-[var(--bg-panel)] border border-[var(--border-light)] rounded-lg shadow-2xl py-1 custom-scrollbar"
                    style="z-index: 9999; max-height: 300px; overflow-y: auto;"
                    x-init="$watch('showRuleMenu', val => { if(val) $dispatch('load-rulesets-for-menu') })">

                    <!-- 这个列表由 header.js 管理 -->
                    <template x-for="rs in availableRuleSets" :key="rs.id">
                        <button @click="executeRuleSet(rs.id); showRuleMenu=false"
                            class="w-full text-left px-3 py-2 text-xs hover:bg-[var(--bg-hover)] text-[var(--text-main)] truncate">
                            <span x-text="rs.meta.name"></span>
                        </button>
                    </template>
                    <div x-show="availableRuleSets.length===0" class="px-3 py-2 text-xs text-[var(--text-dim)]">无规则集
                    </div>
                    <div class="border-t border-[var(--border-light)] mt-1 pt-1">
                        <button @click="$dispatch('open-automation-modal'); showRuleMenu=false"
                            class="w-full text-left px-3 py-2 text-xs text-blue-400 hover:bg-[var(--bg-hover)]">
                            ⚙️ 管理规则...
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 收藏筛选按钮 - 添加动画 -->
        <button
            @click="$store.global.viewState.filterFavorites = !$store.global.viewState.filterFavorites; fetchCards()"
            :class="$store.global.viewState.filterFavorites ? 'text-yellow-400 bg-yellow-400/10 border-yellow-400/50 scale-110' : 'text-gray-500 border-transparent hover:text-yellow-400 hover:scale-105'"
            class="btn-secondary transition-all"
            style="padding: 0.5rem; margin-right: 0.5rem; border: 1px solid; position: relative;">
            <span>★</span>
            <!-- 收藏激活时的光晕效果 -->
            <div x-show="$store.global.viewState.filterFavorites"
                class="absolute inset-0 rounded-full bg-yellow-400/20 animate-ping"></div>
        </button>

        <!-- 搜索组合框 - 优化样式 -->
        <div class="search-container ml-auto mr-4">
            <select x-show="currentMode === 'cards'" x-model="searchType" class="search-select">
                <option value="mix">✨ 智能混合</option>
                <option value="global">🌍 全局关键字</option>
                <option value="name">👤 角色名称</option>
                <option value="filename">📄 文件名</option>
                <option value="creator">🎨 创作者</option>
                <option value="tags">🏷️ 标签</option>
            </select>
            <input x-show="currentMode === 'cards'" type="text" x-model.debounce.300ms="searchQuery"
                placeholder="搜索角色卡..." class="search-input">
            <input x-show="currentMode === 'worldinfo'" type="text" x-model.debounce.300ms="wiSearchQuery"
                placeholder="搜索世界书名称..." class="search-input">
            <button x-show="searchQuery" @click="searchQuery=''"
                style="background: transparent; color: var(--text-dim); border: none; padding: 0 0.5rem; cursor: pointer;">✕</button>
        </div>

        <!-- 工具按钮组 - 添加悬停效果 -->
        <div class="tool-buttons" style="display: flex; gap: 0.5rem; margin-left: 0.5rem;">
            <!-- 随机抽卡按钮 -->
            <button @click="currentMode === 'cards' ? randomCard() : randomWorldInfo()"
                :title="currentMode === 'cards' ? '🎲 手气不错，随机角色' : '🎲 手气不错，随机世界书'"
                class="hover:scale-110 transition-transform active:rotate-180 duration-300"
                style="padding: 0.5rem; background: linear-gradient(135deg, var(--accent-main), #7c3aed); border: 1px solid var(--accent-light); border-radius: 0.5rem; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center;">
                🎲
            </button>

            <!-- 从url导入 -->
            <button @click="if(currentMode==='cards') showImportUrlModal=true; else alert('暂不支持世界书URL导入')"
                :class="currentMode === 'cards' ? 'btn-secondary hover:scale-105' : 'opacity-50 cursor-not-allowed btn-secondary'"
                title="导入 (仅角色卡可用)" class="btn-secondary transition-all">
                🌐
            </button>

            <!-- 刷新页面 -->
            <button @click="currentMode === 'cards' ? fetchCards() : fetchWorldInfoList()" title="刷新"
                class="btn-secondary hover:scale-105 transition-transform">
                ↻
            </button>

            <!-- 日月切换按钮 -->
            <button @click="toggleDarkMode()" :title="isDarkMode ? '切换到浅色模式' : '切换到深色模式'"
                class="btn-secondary hover:scale-105 transition-transform">
                <span x-text="isDarkMode ? '🌙' : '☀️'"></span>
            </button>

            <!-- 自动化规则入口 -->
            <button @click="$dispatch('open-automation-modal')" title="自动化规则管理"
                class="btn-secondary hover:scale-105 transition-transform text-yellow-500">
                ⚡
            </button>

            <!-- 设置按钮 -->
            <button @click="openSettings()" title="系统设置" class="btn-secondary hover:scale-105 transition-transform">
                ⚙️
            </button>
        </div>
    </div>
</div>