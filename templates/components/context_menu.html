<!-- 右键菜单 -->

<!-- 外层容器：根据设备类型切换布局 -->
<div x-data="contextMenu" x-show="visible" @click.away="hideContextMenu"
    :class="isMobile ? 'fixed inset-0 z-context-menu flex items-center justify-center' : 'fixed z-context-menu'"
    :style="isMobile ? {} : { top: y + 'px', left: x + 'px', display: visible ? 'block' : 'none' }"
    style="display:none;">

    <!-- 移动端：半透明遮罩 -->
    <div x-show="isMobile" @click="hideContextMenu()" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

    <!-- 菜单内容容器：根据设备类型调整样式 -->
    <div :class="isMobile ? 'w-64 max-w-[90vw] rounded-xl shadow-2xl overflow-hidden relative z-10' : 'shadow-xl rounded-lg py-1 w-56'"
        style="background: var(--bg-panel); border: 1px solid var(--border-light);">

        <!-- 移动端：标题栏 -->
        <div x-show="isMobile"
            class="px-4 py-3 border-b border-[var(--border-light)] flex items-center justify-between bg-[var(--bg-sub)]">
            <div class="text-sm font-bold text-[var(--text-main)]">目录操作</div>
            <button @click="hideContextMenu()"
                class="w-6 h-6 flex items-center justify-center text-[var(--text-dim)] hover:text-[var(--text-main)]">
                ✕
            </button>
        </div>

        <!-- 菜单项列表：共用同一份内容 -->
        <div :class="isMobile ? 'py-1' : 'py-1'">
            <template x-if="type === 'folder'">
                <div>
                    <button x-show="target !== ''" @click="handleExclude()"
                        :class="isMobile ? 'w-full text-left px-4 py-3 text-base hover:bg-[var(--bg-hover)] transition-colors flex items-center gap-2' : 'w-full text-left px-4 py-2 text-sm hover:bg-gray-700 transition-colors flex items-center gap-2'"
                        style="color: var(--text-main);">
                        <!-- 根据状态显示不同文字 -->
                        <span x-text="$store.global.viewState.excludedCategories.includes(target) ? '⭕' : '🚫'"></span>
                        <span
                            x-text="$store.global.viewState.excludedCategories.includes(target) ? '取消排除' : '排除此目录'"></span>
                    </button>
                    <button x-show="target !== ''" @click="handleRename()"
                        :class="isMobile ? 'w-full text-left px-4 py-3 text-base hover:bg-[var(--bg-hover)] transition-colors flex items-center gap-2' : 'w-full text-left px-4 py-2 text-sm hover:bg-gray-700 transition-colors flex items-center gap-2'"
                        style="color: var(--text-main);"><span>✏️</span> 重命名</button>
                    <button @click="handleCreateSub()"
                        :class="isMobile ? 'w-full text-left px-4 py-3 text-base hover:bg-[var(--bg-hover)] transition-colors flex items-center gap-2' : 'w-full text-left px-4 py-2 text-sm hover:bg-gray-700 transition-colors flex items-center gap-2'"
                        style="color: var(--text-main);"><span>➕</span> 创建子分类</button>
                    <hr x-show="target !== ''"
                        :class="isMobile ? 'border-[var(--border-light)] my-1' : 'border-gray-700 my-1'">
                    <button x-show="target !== ''" @click="handleBundle()"
                        :class="isMobile ? 'w-full text-left px-4 py-3 text-base text-yellow-400 hover:bg-[var(--bg-hover)] transition-colors flex items-center gap-2' : 'w-full text-left px-4 py-2 text-sm text-yellow-400 hover:bg-gray-700 transition-colors flex items-center gap-2'"><span>📦</span>
                        切换"角色包"</button>
                    <button x-show="target !== ''" @click="handleDelete()"
                        :class="isMobile ? 'w-full text-left px-4 py-3 text-base text-red-400 hover:bg-[var(--bg-hover)] transition-colors flex items-center gap-2' : 'w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-700 transition-colors flex items-center gap-2'"><span>🗑️</span>
                        删除分类</button>
                    <hr :class="isMobile ? 'border-[var(--border-light)] my-1' : 'border-gray-700 my-1'">
                    <!-- 运行自动化 -->
                    <!-- 桌面端：悬停显示子菜单 -->
                    <div x-show="!isMobile" x-data="{ showSub: false }" class="relative"
                        @mouseenter="showSub=true; $dispatch('load-rulesets-for-menu')" @mouseleave="showSub=false">
                        <button
                            class="w-full text-left px-4 py-2 text-sm hover:bg-gray-700 transition-colors flex items-center justify-between"
                            style="color: var(--text-main);">
                            <span class="flex items-center gap-2"><span>🤖</span> 运行自动化</span>
                            <span class="text-xs">▶</span>
                        </button>

                        <!-- 子菜单：选择规则集 -->
                        <div x-show="showSub" x-transition:enter="transition ease-out duration-100"
                            x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                            class="absolute left-full top-0 ml-1 w-48 bg-[var(--bg-panel)] border border-[var(--border-light)] rounded shadow-xl py-1 custom-scrollbar"
                            style="max-height: 300px; overflow-y: auto;">

                            <div
                                class="px-3 py-1 text-[10px] text-[var(--text-dim)] border-b border-[var(--border-light)] bg-[var(--bg-sub)]">
                                选择规则集:
                            </div>

                            <template x-for="rs in $store.global.availableRuleSets" :key="rs.id">
                                <button @click.stop="handleRunAuto(rs.id)"
                                    class="w-full text-left px-3 py-2 text-xs hover:bg-[var(--bg-hover)] text-[var(--text-main)] truncate block">
                                    <span x-text="rs.meta.name"></span>
                                </button>
                            </template>

                            <div x-show="!$store.global.availableRuleSets || $store.global.availableRuleSets.length===0"
                                class="px-3 py-2 text-xs text-[var(--text-dim)] text-center">
                                (无规则集)
                            </div>
                        </div>
                    </div>

                    <!-- 移动端：直接打开执行规则弹窗 -->
                    <button x-show="isMobile" @click="handleOpenExecuteRulesMobile()"
                        class="w-full text-left px-4 py-3 text-base hover:bg-[var(--bg-hover)] transition-colors flex items-center gap-2"
                        style="color: var(--text-main);">
                        <span>🤖</span> 运行自动化
                    </button>
                </div>
            </template>
        </div>
    </div>
</div>