<!-- URL 导入模态框 -->
<div x-data="importModal" x-show="showImportUrlModal" x-cloak class="modal-overlay z-modal-popover">
    <div style="background: var(--bg-panel); padding: 0; border-radius: 1rem; width: 36rem; border: 1px solid var(--border-light); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3); overflow: hidden; display: flex; flex-direction: column;"
        @click.away="if(!conflictData) showImportUrlModal=false">
        
        <!-- Header -->
        <div style="padding: 1.25rem 1.5rem; background: var(--bg-item); border-bottom: 1px solid var(--border-light);">
            <h3 style="font-weight: bold; color: var(--text-main); font-size: 1.125rem; display: flex; align-items: center; gap: 0.5rem;">
                <span x-show="!conflictData">🌍 从 URL 导入角色卡</span>
                <span x-show="conflictData" style="color: var(--text-warn);">⚠️ 文件名冲突</span>
            </h3>
        </div>
        
        <div style="padding: 1.5rem;">
            <!-- 正常导入表单 -->
            <div x-show="!conflictData" style="display: flex; flex-direction: column; gap: 1.25rem;">
                <div>
                    <label class="form-label" style="font-weight: 500; margin-bottom: 0.5rem; display: block;">图片链接</label>
                    <div class="relative">
                        <input type="text" x-model="importUrlInput" class="form-input" style="width: 100%; padding-left: 2.5rem;" placeholder="https://example.com/character.png"
                            @keydown.enter="importFromUrl()">
                        <div style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-dim);">🔗</div>
                    </div>
                    <div class="text-xs mt-2" style="color: var(--text-dim);">支持 PNG 直链。</div>
                </div>
                
                <div>
                    <label class="form-label" style="font-weight: 500; margin-bottom: 0.5rem; display: block;">保存位置</label>
                    <div class="relative">
                        <select x-model="importTargetCategory" class="form-input" style="width: 100%; padding-left: 2.5rem;">
                            <option value="">📂 (当前浏览目录)</option>
                            <option value="根目录">🏠 根目录</option>
                            <template x-for="folder in allFoldersList" :key="folder.path">
                                <option :value="folder.path" x-text="'📁 ' + folder.path"></option>
                            </template>
                        </select>
                        <div style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-dim); pointer-events: none;">📍</div>
                    </div>
                </div>

                <div style="display: flex; gap: 0.75rem; margin-top: 0.5rem;">
                    <button @click="showImportUrlModal=false" class="btn-secondary" style="flex:1; justify-content: center;">取消</button>
                    <button @click="importFromUrl()" :disabled="isLoading" class="btn-primary"
                        style="flex:2; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                        <span x-show="!isLoading">📥 立即导入</span>
                        <span x-show="isLoading" class="flex items-center gap-2">
                            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            下载中...
                        </span>
                    </button>
                </div>
            </div>

            <!-- 冲突解决界面 -->
            <div x-show="conflictData" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" style="display: flex; flex-direction: column; gap: 1.5rem;">
                
                <div style="font-size: 0.95rem; color: var(--text-dim); text-align: center;">
                    目标文件夹中已存在同名角色卡。<br>请选择如何处理新导入的文件。
                </div>
                
                <!-- Comparison Card -->
                <div style="margin-top: 1rem;display: flex; gap: 0; background: var(--bg-item); border-radius: 0.75rem; border: 1px solid var(--border-light); overflow: hidden;">
                    
                    <!-- Existing -->
                    <div style="flex: 1; padding: 1rem; border-right: 1px solid var(--border-light); display: flex; flex-direction: column; align-items: center; gap: 0.75rem; position: relative;">
                        <div style="position: absolute; top: 0.5rem; left: 0.5rem; font-size: 0.75rem; background: var(--bg-panel); color: var(--text-dim); padding: 0.1rem 0.5rem; border-radius: 99px; border: 1px solid var(--border-light);">原有</div>
                        
                        <div style="width: 100px; height: 150px; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); background: #000;">
                            <img :src="conflictData ? conflictData.existing_card.image_url : ''" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.8;">
                        </div>
                        <div style="text-align: center; width: 100%;">
                            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;" x-text="conflictData?.existing_card.char_name"></div>
                            <div style="display: flex; justify-content: center; gap: 0.5rem; font-size: 0.75rem; color: var(--text-dim);">
                                <span style="background: var(--bg-panel); padding: 2px 6px; border-radius: 4px;" x-text="(conflictData?.existing_card.token_count || 0) + ' Tk'"></span>
                                <span style="background: var(--bg-panel); padding: 2px 6px; border-radius: 4px;" x-text="Math.round((conflictData?.existing_card.file_size || 0) / 1024) + ' KB'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- VS Badge -->
                    <div style="width: 0; position: relative; display: flex; align-items: center; justify-content: center; z-index: 10;">
                        <div style="background: var(--bg-panel); color: var(--text-dim); font-weight: bold; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 99px; border: 1px solid var(--border-light); position: absolute;">VS</div>
                    </div>

                    <!-- New -->
                    <div style="flex: 1; padding: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.75rem; position: relative; background: rgba(var(--color-primary-rgb), 0.05);">
                        <div style="position: absolute; top: 0.5rem; right: 0.5rem; font-size: 0.75rem; background: var(--color-primary); color: white; padding: 0.1rem 0.5rem; border-radius: 99px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">NEW</div>
                        
                        <div style="width: 100px; height: 150px; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); background: #000; border: 2px solid var(--color-primary);">
                            <img :src="conflictData ? conflictData.new_card.image_url : ''" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div style="text-align: center; width: 100%;">
                            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; color: var(--color-primary);" x-text="conflictData?.new_card.char_name"></div>
                            <div style="display: flex; justify-content: center; gap: 0.5rem; font-size: 0.75rem; color: var(--text-dim);">
                                <span style="background: var(--bg-panel); padding: 2px 6px; border-radius: 4px;" x-text="(conflictData?.new_card.token_count || 0) + ' Tk'"></span>
                                <span style="background: var(--bg-panel); padding: 2px 6px; border-radius: 4px;" x-text="Math.round((conflictData?.new_card.file_size || 0) / 1024) + ' KB'"></span>
                            </div>
                        </div>
                    </div>

                </div>
                
                <!-- Actions -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 0.75rem;margin-top: 1rem;">
                    <button @click="resolveConflict('cancel')" class="btn-ghost" style="justify-content: center; color: var(--text-dim); border-radius: 0.375rem; border: 1px solid var(--text-dim);">
                        放弃 (Esc)
                    </button>
                    <button @click="resolveConflict('overwrite')" class="btn-danger" style="justify-content: center; background: transparent; border: 1px solid var(--color-danger); color: var(--color-danger);border-radius: 0.375rem;">
                        <span style="font-size: 0.9rem;">🔄 覆盖</span>
                    </button>
                    <button @click="resolveConflict('rename')" class="btn-primary" style="justify-content: center; box-shadow: 0 4px 6px -1px rgba(var(--color-primary-rgb), 0.3);border-radius: 0.375rem; border-radius: 0.375rem;">
                        <span style="font-size: 0.9rem;">➕ 追加 (Enter)</span>
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>