<!-- È¢ÑËÆæËØ¶ÊÉÖÈòÖËßàÁïåÈù¢ (Preset Detail Reader Modal) -->
<!-- Ê≠§Êñá‰ª∂Ë¢´ grid_presets.html ÂºïÁî®Ôºå‰ΩøÁî® presetGrid Alpine ÁªÑ‰ª∂ÁöÑÊï∞ÊçÆ -->
<div x-show="showPresetDetailModal" x-cloak class="modal-overlay z-modal-std flex items-center justify-center p-4"
    @click.self="closePresetDetailModal()">

    <div class="preset-reader-modal bg-[var(--bg-panel)] border border-[var(--border-light)] rounded-xl shadow-2xl
              flex flex-col w-full max-w-7xl h-[88vh] overflow-hidden relative animate-scale-in"
        @click.self="activePresetItem = null">

        <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†èÔºöÈòÖËØª‰ºòÂÖà -->
        <div
            class="preset-reader-topbar border-b border-[var(--border-light)] flex items-center gap-3 px-4 bg-[var(--bg-sub)] flex-shrink-0">
            <div class="flex items-center gap-3 min-w-0 flex-1">
                <div x-show="$store.global.deviceType !== 'mobile'" class="text-2xl select-none opacity-90">üìù</div>
                <div class="min-w-0">
                    <div class="flex items-center overflow-hidden gap-2 min-w-0">
                        <h3 class="text-sm md:text-base font-bold leading-tight truncate"
                            :title="activePresetDetail?.name" x-text="activePresetDetail?.name || 'Êú™ÂëΩÂêçÈ¢ÑËÆæ'"></h3>

                        <span class="wi-badge relative top-0 right-0"
                            :class="activePresetDetail?.type === 'global' ? 'global' : 'res'"
                            x-text="activePresetDetail?.type === 'global' ? 'GLOBAL' : 'RES'"></span>
                    </div>

                    <div class="mt-1 flex items-center gap-3 text-[10px] text-gray-500 font-mono opacity-80">
                        <span x-show="$store.global.deviceType !== 'mobile'">üìÖ </span>
                        <span x-text="formatDate(activePresetDetail?.mtime)"></span>
                        <span class="opacity-40">|</span>
                        <span>Prompts: <span class="font-bold text-[var(--text-main)]"
                                x-text="activePresetDetail?.prompt_count || 0">0</span></span>
                        <span x-show="(activePresetDetail?.regex_count || 0) > 0">Regex: <span class="font-bold text-green-500"
                                x-text="activePresetDetail?.regex_count"></span></span>
                        <span x-show="(activePresetDetail?.script_count || 0) > 0">ST: <span class="font-bold text-purple-500"
                                x-text="activePresetDetail?.script_count"></span></span>
                        <span class="opacity-40">|</span>
                        <span>üì¶ <span x-text="formatSize(activePresetDetail?.file_size)"></span></span>
                    </div>
                </div>
            </div>

            <!-- ÂÖ≥Èó≠ -->
            <button @click="closePresetDetailModal()"
                class="text-gray-500 hover:text-red-400 rounded-full hover:bg-[var(--bg-panel)] transition-colors"
                :class="$store.global.deviceType === 'mobile' ? '' : 'p-2'" title="ÂÖ≥Èó≠ (Esc)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- ÁßªÂä®Á´ØÔºö‰æßËæπÊ†èÂàáÊç¢ÊåâÈíÆ -->
        <button x-show="$store.global.deviceType === 'mobile' && !showMobileSidebar"
            @click="showMobileSidebar = !showMobileSidebar"
            class="fixed bottom-16 left-2 z-50 w-8 h-8 bg-[var(--bg-panel)] border border-[var(--border-light)] rounded-lg flex items-center justify-center text-[var(--text-main)] shadow-lg md:hidden">
            <span x-show="!showMobileSidebar">‚ò∞</span>
            <span x-show="showMobileSidebar">‚úï</span>
        </button>

        <!-- ‰∏ª‰ΩìÔºöÂ∑¶‰ø°ÊÅØ + ‰∏≠ÈòÖËØªÊµÅ + Âè≥ËØ¶ÊÉÖÔºàÂ§ßÂ±èÂõ∫ÂÆöÔºåÂ∞èÂ±èÊäΩÂ±âÔºâ -->
        <div class="flex-1 flex overflow-hidden min-h-0">

            <!-- ÁßªÂä®Á´ØÔºö‰æßËæπÊ†èÈÅÆÁΩ© -->
            <div x-show="$store.global.deviceType === 'mobile' && showMobileSidebar" @click="showMobileSidebar = false"
                class="fixed inset-0 bg-black/50 z-30" x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"></div>

            <!-- Â∑¶‰æßÔºöÈ¢ÑËÆæÂÖÉÊï∞ÊçÆ‰∏éÊìç‰Ωú -->
            <aside class="wi-reader-sidebar w-full md:w-[280px] flex-shrink-0 bg-[var(--bg-sub)]
                    border-r border-[var(--border-main)] flex-col min-h-0" :class="{
                    'hidden md:flex': $store.global.deviceType !== 'mobile',
                    'fixed top-14 left-0 bottom-0 z-40 w-[280px] max-w-[85vw] shadow-2xl flex': $store.global.deviceType === 'mobile' && showMobileSidebar,
                    'hidden': $store.global.deviceType === 'mobile' && !showMobileSidebar
                }" x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="transform -translate-x-full" x-transition:enter-end="transform translate-x-0"
                x-transition:leave="transition ease-in duration-200" x-transition:leave-start="transform translate-x-0"
                x-transition:leave-end="transform -translate-x-full">

                <!-- AI ÂèÇÊï∞Ê¶ÇËßà -->
                <div class="p-4 border-b border-[var(--border-light)] space-y-3">
                    <div class="text-[10px] uppercase font-bold text-gray-500 mb-2">Generation Parameters</div>

                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="p-2 bg-[var(--bg-body)] border border-[var(--border-light)] rounded">
                            <div class="text-[9px] text-gray-500 uppercase">Temperature</div>
                            <div class="font-bold text-orange-400"
                                x-text="formatParam(activePresetDetail?.temperature)"></div>
                        </div>
                        <div class="p-2 bg-[var(--bg-body)] border border-[var(--border-light)] rounded">
                            <div class="text-[9px] text-gray-500 uppercase">Max Tokens</div>
                            <div class="font-bold text-blue-400" x-text="formatParam(activePresetDetail?.max_tokens)">
                            </div>
                        </div>
                        <div class="p-2 bg-[var(--bg-body)] border border-[var(--border-light)] rounded">
                            <div class="text-[9px] text-gray-500 uppercase">Top P</div>
                            <div class="font-bold text-green-400" x-text="formatParam(activePresetDetail?.top_p)"></div>
                        </div>
                        <div class="p-2 bg-[var(--bg-body)] border border-[var(--border-light)] rounded">
                            <div class="text-[9px] text-gray-500 uppercase">Top K</div>
                            <div class="font-bold text-purple-400" x-text="formatParam(activePresetDetail?.top_k)">
                            </div>
                        </div>
                        <div class="p-2 bg-[var(--bg-body)] border border-[var(--border-light)] rounded">
                            <div class="text-[9px] text-gray-500 uppercase">Freq Penalty</div>
                            <div class="font-bold text-yellow-400"
                                x-text="formatParam(activePresetDetail?.frequency_penalty)"></div>
                        </div>
                        <div class="p-2 bg-[var(--bg-body)] border border-[var(--border-light)] rounded">
                            <div class="text-[9px] text-gray-500 uppercase">Pres Penalty</div>
                            <div class="font-bold text-pink-400"
                                x-text="formatParam(activePresetDetail?.presence_penalty)"></div>
                        </div>
                    </div>
                </div>

                <!-- ÊèèËø∞ -->
                <div class="p-4 border-b border-[var(--border-light)]" x-show="activePresetDetail?.description">
                    <div class="text-[10px] uppercase font-bold text-gray-500 mb-1">Description</div>
                    <div class="text-xs text-[var(--text-sub)] italic bg-[var(--bg-body)] p-2 rounded border border-[var(--border-light)]
                        max-h-28 overflow-y-auto custom-scrollbar">
                        <span x-text="activePresetDetail?.description"></span>
                    </div>
                </div>

                <!-- Êñá‰ª∂Ë∑ØÂæÑ -->
                <details class="group px-4 py-2 border-b border-[var(--border-light)]"
                    x-show="activePresetDetail?.path">
                    <summary class="cursor-pointer select-none text-[10px] uppercase font-bold text-gray-500">
                        Path <span class="opacity-60 group-open:hidden">‚ñ∂</span><span
                            class="opacity-60 hidden group-open:inline">‚ñº</span>
                    </summary>
                    <div class="mt-1 text-[10px] text-gray-500 font-mono break-all leading-tight opacity-70"
                        x-text="activePresetDetail?.path"></div>
                </details>

                <!-- Âø´ÈÄüÁ≠õÈÄâ -->
                <div class="p-4 border-b border-[var(--border-light)]">
                    <div class="text-[10px] uppercase font-bold text-gray-500 mb-2">Quick Filters</div>

                    <div class="grid grid-cols-2 gap-1.5">
                        <button class="wi-filter-chip"
                            @click="uiPresetFilter = (uiPresetFilter==='enabled' ? null : 'enabled')"
                            :class="uiPresetFilter==='enabled' && 'active'">
                            Enabled
                        </button>
                        <button class="wi-filter-chip"
                            @click="uiPresetFilter = (uiPresetFilter==='disabled' ? null : 'disabled')"
                            :class="uiPresetFilter==='disabled' && 'active'">
                            Disabled
                        </button>
                    </div>
                </div>

                <!-- ‰∏≠ÈÉ®ÔºöÁõÆÂΩïÔºàTOCÔºâ -->
                <div class="flex-1 min-h-0 overflow-y-auto custom-scrollbar p-3">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-[10px] uppercase font-bold text-gray-500">Contents</div>
                        <div class="text-[10px] text-gray-500 font-mono">
                            <span x-text="filteredPresetItems.length"></span>/<span
                                x-text="totalPresetItems.length"></span>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <!-- Prompts TOC -->
                        <template x-for="(prompt, idx) in normalizePrompts(activePresetDetail?.prompts || [])"
                            :key="prompt.key">
                            <button class="wi-toc-item w-full text-left"
                                :class="activePresetItem===prompt && 'active'"
                                @click="selectPresetItem(prompt, 'prompt', true)">

                                <span class="wi-toc-dot" data-status="prompt"></span>
                                <span class="truncate font-bold"
                                    x-text="prompt.name || ('Prompt #' + (idx + 1))"></span>
                                <span x-show="!prompt.enabled"
                                    class="wi-toc-order font-mono text-red-400">OFF</span>
                            </button>
                        </template>

                        <div x-show="filteredPresetItems.length === 0"
                            class="text-center py-8 text-[var(--text-dim)] text-xs">
                            Êó†ÂåπÈÖçÊù°ÁõÆ
                        </div>
                    </div>
                </div>

                <!-- Â∫ïÈÉ®Êìç‰ΩúÊåâÈíÆ -->
                <div class="p-3 border-t border-[var(--border-light)] mt-auto space-y-2 bg-[var(--bg-sub)]">
                    <button @click="editPresetRawFromDetail()"
                        class="w-full btn-primary py-2.5 rounded-lg flex items-center justify-center gap-2 font-bold shadow-md transform transition hover:translate-y-[-1px]">
                        <span>‚úèÔ∏è</span> ÁºñËæëÈ¢ÑËÆæ
                    </button>

                    <!-- È´òÁ∫ßÊâ©Â±ïÊåâÈíÆÔºöÊ≠£ÂàôËÑöÊú¨ + STËÑöÊú¨ -->
                    <button x-show="(activePresetDetail?.regex_count || 0) + (activePresetDetail?.script_count || 0) > 0"
                        @click="openAdvancedExtensions()"
                        class="w-full btn-secondary py-2 text-xs flex items-center justify-center gap-2 font-bold hover:bg-purple-600 hover:text-white transition-colors">
                        <span>üß©</span> È´òÁ∫ßÊâ©Â±ï
                        <span class="text-[10px] opacity-80">
                            (<span x-text="activePresetDetail?.regex_count || 0"></span>Ê≠£Âàô
                            +<span x-text="activePresetDetail?.script_count || 0"></span>ST)
                        </span>
                    </button>

                    <div class="grid grid-cols-3 gap-1.5">
                        <button @click="createSnapshot('preset')"
                            class="btn-secondary py-1.5 text-xs flex flex-col items-center justify-center gap-0.5"
                            title="Âø´ÈÄüÂ§á‰ªΩ"><span class="text-base">üì∏</span><span class="scale-90">Âø´ÁÖß</span></button>
                        <button @click="openRollback()"
                            class="btn-secondary py-1.5 text-xs flex flex-col items-center justify-center gap-0.5"
                            title="Êü•ÁúãÂéÜÂè≤ÁâàÊú¨"><span class="text-base">‚è™</span><span class="scale-90">ÂõûÊªö</span></button>
                        <button @click="openBackupFolder('preset')"
                            class="btn-secondary py-1.5 text-xs flex flex-col items-center justify-center gap-0.5"
                            title="ÊâìÂºÄÂ§á‰ªΩÊñá‰ª∂Â§π"><span class="text-base">üìÇ</span><span class="scale-90">ÁõÆÂΩï</span></button>
                    </div>

                    <template x-if="activePresetDetail?.type !== 'embedded'">
                        <button @click="deleteCurrentPreset()"
                            class="w-full py-1 text-[10px] text-red-400 hover:text-red-500 hover:bg-red-500/10 rounded transition-colors flex items-center justify-center gap-1">üóëÔ∏è
                            Âà†Èô§Ê≠§È¢ÑËÆæ</button>
                    </template>
                </div>
            </aside>

            <!-- ‰∏≠Èó¥ÔºöÈòÖËØªÊµÅ -->
            <main class="wi-reader-main flex-1 min-w-0 bg-[var(--bg-body)] relative overflow-hidden">
                <div class="absolute inset-0 overflow-y-auto custom-scrollbar">
                    <!-- È°∂ÈÉ®ÊèêÁ§∫Êù° -->
                    <div
                        class="sticky top-0 z-10 bg-[var(--bg-body)]/80 backdrop-blur border-b border-[var(--border-light)] px-4 py-2">
                        <div class="text-[11px] text-gray-500 flex items-center justify-between">
                            <div>
                                <span class="font-mono">Results:</span>
                                <span class="font-bold text-[var(--text-main)]"
                                    x-text="filteredPresetItems.length"></span>
                                <span class="opacity-60">/</span>
                                <span x-text="totalPresetItems.length"></span>
                            </div>
                            <div class="opacity-70 hidden sm:block">
                                ÂçïÂáªÊü•ÁúãËØ¶ÊÉÖÔºõÂèåÂáªË∑≥ËΩ¨ÁºñËæëÂô®
                            </div>
                        </div>
                    </div>

                    <div x-show="isLoading"
                        class="h-full flex flex-col items-center justify-center text-gray-500 gap-4">
                        <div class="text-4xl animate-bounce">‚è≥</div>
                        <p class="text-sm">Ê≠£Âú®ËØªÂèñÈ¢ÑËÆæ...</p>
                    </div>

                    <div x-show="!isLoading" class="p-4 space-y-3">
                        <!-- Prompts -->
                        <template x-for="(prompt, idx) in normalizePrompts(activePresetDetail?.prompts || [])"
                            :key="prompt.key">
                            <article :id="'preset-prompt-' + prompt.key" class="wi-reader-entry group"
                                :class="{'active': activePresetItem === prompt}" data-status="prompt"
                                @click="selectPresetItem(prompt, 'prompt', true)">

                                <div class="wi-reader-entry-status"></div>

                                <div class="wi-reader-entry-body">
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="min-w-0">
                                            <div class="wi-reader-keys font-mono flex items-center gap-2">
                                                <span class="text-purple-400">üí¨</span>
                                                <span x-text="prompt.name || ('Prompt #' + (idx + 1))"></span>
                                            </div>
                                            <div x-show="prompt.meta && prompt.meta.length > 0"
                                                class="flex flex-wrap gap-1 mt-1">
                                                <template x-for="(tag, tIdx) in prompt.meta" :key="tIdx">
                                                    <span
                                                        class="px-2 py-0.5 text-[10px] bg-white/5 text-[var(--text-dim)] border border-[var(--border-light)] rounded"
                                                        x-text="tag"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 flex-shrink-0">
                                            <span class="wi-pill" :class="prompt.enabled ? 'on' : 'off'"
                                                x-text="prompt.enabled ? 'EN' : 'OFF'"></span>
                                        </div>
                                    </div>
                                    <div x-show="prompt.content"
                                        class="wi-reader-content whitespace-pre-wrap break-words mt-2"
                                        x-text="prompt.content"></div>
                                    <div x-show="!prompt.content" class="wi-reader-content text-gray-400 italic mt-2">
                                        ËØ•Êù°ÁõÆÊú™ÂåÖÂê´ÊñáÊú¨ÂÜÖÂÆπ„ÄÇ</div>
                                </div>
                            </article>
                        </template>

                        <div x-show="filteredPresetItems.length === 0"
                            class="flex flex-col items-center justify-center py-20 opacity-50">
                            <div class="text-4xl grayscale mb-2">üçÉ</div>
                            <p class="text-sm">Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥Êù°ÁõÆ</p>
                        </div>
                    </div>
                </div>
            </main>

            <!-- ÁßªÂä®Á´ØÔºöËØ¶ÊÉÖÈù¢ÊùøÈÅÆÁΩ© -->
            <div x-show="$store.global.deviceType === 'mobile' && activePresetItem" @click="activePresetItem = null"
                class="fixed inset-0 bg-black/50 z-40" x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"></div>

            <!-- Âè≥‰æßÔºöÊù°ÁõÆËØ¶ÊÉÖÔºàÂ§ßÂ±èÂõ∫ÂÆöÔºõÂ∞èÂ±èÊäΩÂ±â overlayÔºâ -->
            <aside class="wi-reader-detail" x-show="activePresetItem"
                x-transition:enter="transition ease-out duration-300 transform"
                x-transition:enter-start="translate-x-full" x-transition:enter-end="translate-x-0"
                x-transition:leave="transition ease-in duration-200 transform" x-transition:leave-start="translate-x-0"
                x-transition:leave-end="translate-x-full">

                <div
                    class="h-10 border-b border-[var(--border-light)] flex items-center justify-between px-3 bg-[var(--bg-sub)] flex-shrink-0">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Item Details</span>
                    <button @click="activePresetItem = null"
                        class="text-gray-500 hover:text-[var(--text-main)] px-2">‚úï</button>
                </div>

                <div class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                    <template x-if="activePresetItem">
                        <div class="space-y-4">
                            <!-- PromptËØ¶ÊÉÖ -->
                            <template x-if="activePresetItemType === 'prompt'">
                                <div class="space-y-4">
                                    <div class="flex items-start justify-between gap-3">
                                        <h4 class="font-bold text-lg text-[var(--text-main)] break-all"
                                            x-text="activePresetItem.name || 'Êú™ÂëΩÂêçPrompt'"></h4>
                                        <div class="flex flex-col gap-1 items-end">
                                            <div class="px-2 py-0.5 rounded text-[10px] font-bold border uppercase"
                                                :class="activePresetItem.enabled ? 'bg-green-500/10 border-green-500/30 text-green-500' : 'bg-gray-500/10 border-gray-500/30 text-gray-500'">
                                                <span x-text="activePresetItem.enabled ? 'Enabled' : 'Disabled'"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div x-show="activePresetItem.meta && activePresetItem.meta.length > 0"
                                        class="space-y-2">
                                        <label class="text-[10px] text-gray-500 uppercase font-bold block">Meta
                                            Tags</label>
                                        <div class="flex flex-wrap gap-1">
                                            <template x-for="(tag, tIdx) in activePresetItem.meta" :key="tIdx">
                                                <span
                                                    class="px-2 py-0.5 text-[10px] bg-white/5 text-[var(--text-dim)] border border-[var(--border-light)] rounded"
                                                    x-text="tag"></span>
                                            </template>
                                        </div>
                                    </div>

                                    <div>
                                        <div class="flex justify-between items-end mb-1">
                                            <label class="text-[10px] text-gray-500 uppercase font-bold">Content</label>
                                        </div>
                                        <div
                                            class="p-3 bg-[var(--bg-body)] border border-[var(--border-light)] rounded text-sm text-[var(--text-main)]
                                    whitespace-pre-wrap break-words font-sans leading-relaxed select-text min-h-[120px] border-l-4 border-l-purple-500">
                                            <span x-text="activePresetItem.content || '(Êó†ÂÜÖÂÆπ)'"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- ÈÄöÁî®ÂèÇÊï∞ -->
                            <div class="grid grid-cols-2 gap-2 text-xs pt-4 border-t border-[var(--border-light)]">
                                <div class="p-2 border border-[var(--border-light)] rounded bg-[var(--bg-body)]">
                                    <div class="text-[9px] text-gray-500 uppercase">Type</div>
                                    <div class="font-bold">Prompt</div>
                                </div>
                                <div class="p-2 border border-[var(--border-light)] rounded bg-[var(--bg-body)]">
                                    <div class="text-[9px] text-gray-500 uppercase">Enabled</div>
                                    <div class="font-bold" x-text="activePresetItem.enabled ? 'Yes' : 'No'"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="p-3 border-t border-[var(--border-light)] bg-[var(--bg-sub)]">
                    <button @click="editPresetRawFromDetail()"
                        class="w-full btn-secondary py-2 text-xs flex items-center justify-center gap-2 font-bold hover:bg-accent-main hover:text-white transition-colors">
                        <span>üõ†Ô∏è</span> ÂéªÁºñËæëÂô®‰øÆÊîπ
                    </button>
                </div>
            </aside>

        </div>
    </div>
</div>