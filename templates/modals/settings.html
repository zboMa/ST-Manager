<!-- 设置模态框 (Refactored) -->
<div x-show="showSettingsModal" x-data="settingsModal" x-cloak class="modal-overlay z-modal-std">
    <div class="settings-modal-container" @click.away="showSettingsModal=false">

        <!-- 1. 顶部栏 -->
        <div class="settings-header">
            <div class="flex items-center gap-2">
                <span class="text-2xl">⚙️</span>
                <h3 class="font-bold text-xl">系统设置</h3>
            </div>
            <button @click="showSettingsModal=false"
                class="text-gray-400 hover:text-red-500 transition text-xl">✕</button>
        </div>

        <!-- 2. 主体区域 -->
        <div class="settings-body">

            <!-- 左侧侧边栏导航 -->
            <aside class="settings-sidebar custom-scrollbar">
                <button @click="activeSettingTab='general'" class="settings-nav-item"
                    :class="activeSettingTab==='general' ? 'active' : ''">
                    <span class="nav-icon">📂</span>
                    <span class="nav-text">常规路径</span>
                </button>
                <button @click="activeSettingTab='appearance'" class="settings-nav-item"
                    :class="activeSettingTab==='appearance' ? 'active' : ''">
                    <span class="nav-icon">🎨</span>
                    <span class="nav-text">外观显示</span>
                </button>
                <button @click="activeSettingTab='connection'" class="settings-nav-item"
                    :class="activeSettingTab==='connection' ? 'active' : ''">
                    <span class="nav-icon">🔌</span>
                    <span class="nav-text">连接与服务</span>
                </button>
                <button @click="activeSettingTab='maintenance'" class="settings-nav-item"
                    :class="activeSettingTab==='maintenance' ? 'active' : ''">
                    <span class="nav-icon">🛠️</span>
                    <span class="nav-text">维护与高级</span>
                </button>
            </aside>

            <!-- 右侧内容滚动区 -->
            <main class="settings-content custom-scrollbar">

                <!-- TAB 1: 常规路径 (General) -->
                <div x-show="activeSettingTab==='general'" x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 translate-x-2">
                    <div class="settings-group-title">文件与路径设置</div>

                    <div class="settings-row">
                        <label class="settings-label text-blue-400">角色卡存储路径 (Cards)</label>
                        <div class="settings-desc">存放角色图片和 JSON 的文件夹 (支持相对路径)</div>
                        <div class="flex gap-2 mt-2">
                            <input type="text" x-model="settingsForm.cards_dir" class="form-input" placeholder="cards">
                            <button @click="systemAction('open_folder')" title="在资源管理器中打开"
                                class="btn-secondary px-3">📂</button>
                        </div>
                    </div>

                    <div class="settings-row">
                        <label class="settings-label text-yellow-400">世界书存储路径 (Lorebooks)</label>
                        <div class="settings-desc">存放全局共享世界书 (.json) 的目录</div>
                        <input type="text" x-model="settingsForm.world_info_dir" class="form-input mt-2"
                            placeholder="lorebooks">
                    </div>

                    <div class="settings-row">
                        <label class="settings-label text-purple-400">正则脚本路径 (Regex)</label>
                        <div class="settings-desc">存放全局正则脚本 (.json) 的目录</div>
                        <input type="text" x-model="settingsForm.regex_dir" class="form-input mt-2"
                            placeholder="extensions/regex">
                    </div>

                    <div class="settings-row">
                        <label class="settings-label text-indigo-400">ST 脚本路径 (Scripts)</label>
                        <div class="settings-desc">存放全局 Tavern Helper 脚本 (.json) 的目录</div>
                        <input type="text" x-model="settingsForm.scripts_dir" class="form-input mt-2"
                            placeholder="extensions/tavern_helper">
                    </div>

                    <div class="settings-row">
                        <label class="settings-label text-yellow-500">快速回复路径 (Quick Replies)</label>
                        <div class="settings-desc">存放全局快速回复 (.json) 的目录</div>
                        <input type="text" x-model="settingsForm.quick_replies_dir" class="form-input mt-2"
                            placeholder="extensions/quick-replies">
                    </div>

                    <div class="settings-row">
                        <label class="settings-label text-orange-400">预设路径 (Presets)</label>
                        <div class="settings-desc">存放 AI 生成参数预设 (.json) 的目录</div>
                        <input type="text" x-model="settingsForm.presets_dir" class="form-input mt-2"
                            placeholder="data/library/presets">
                    </div>

                    <div class="settings-row">
                        <label class="settings-label text-green-400">资源文件夹路径 (Resources)</label>
                        <div class="settings-desc">存放角色附件、背景图、聊天记录备份的根目录</div>
                        <input type="text" x-model="settingsForm.resources_dir" class="form-input mt-2"
                            placeholder="resources">
                    </div>
                </div>

                <!-- TAB 2: 外观显示 (Appearance) -->
                <div x-show="activeSettingTab==='appearance'" x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 translate-x-2">
                    <div class="settings-group-title">主题与视觉</div>

                    <!-- 深色模式 -->
                    <div
                        class="settings-row flex justify-between items-center p-3 rounded border border-[var(--border-light)] bg-[var(--bg-sub)]">
                        <div>
                            <div class="settings-label">深色模式 (Dark Mode)</div>
                            <div class="settings-desc">切换日间/夜间配色方案</div>
                        </div>
                        <button @click="toggleDarkMode()" class="btn-secondary px-3 py-1">
                            <span x-text="isDarkMode ? '🌙 已开启' : '☀️ 已关闭'"></span>
                        </button>
                    </div>

                    <!-- 主题强调色 -->
                    <div class="settings-row">
                        <div class="settings-label mb-2">主题强调色 (Accent Color)</div>
                        <div class="flex gap-4">
                            <button @click="applyTheme('blue')" class="theme-dot" style="background-color: #2563eb;"
                                :class="settingsForm.theme_accent==='blue'?'active':''" title="Blue"></button>
                            <button @click="applyTheme('purple')" class="theme-dot" style="background-color: #7c3aed;"
                                :class="settingsForm.theme_accent==='purple'?'active':''" title="Purple"></button>
                            <button @click="applyTheme('green')" class="theme-dot" style="background-color: #059669;"
                                :class="settingsForm.theme_accent==='green'?'active':''" title="Green"></button>
                            <button @click="applyTheme('red')" class="theme-dot" style="background-color: #dc2626;"
                                :class="settingsForm.theme_accent==='red'?'active':''" title="Red"></button>
                            <button @click="applyTheme('orange')" class="theme-dot" style="background-color: #ea580c;"
                                :class="settingsForm.theme_accent==='orange'?'active':''" title="Orange"></button>
                            <button @click="applyTheme('pink')" class="theme-dot" style="background-color: #db2777;"
                                :class="settingsForm.theme_accent==='pink'?'active':''" title="Pink"></button>
                        </div>
                    </div>

                    <!-- 字体风格 -->
                    <div class="settings-row">
                        <div class="settings-label mb-2">字体风格 (Typography)</div>
                        <div class="grid grid-cols-3 gap-3">
                            <button @click="applyFont('sans')"
                                class="py-3 border border-[var(--border-light)] rounded hover:bg-[var(--bg-hover)] transition"
                                :class="settingsForm.font_style === 'sans' ? 'bg-[var(--accent-main)] text-white border-transparent' : 'bg-[var(--bg-sub)]'">
                                <span class="font-sans text-sm">无衬线 (Sans)</span>
                            </button>
                            <button @click="applyFont('serif')"
                                class="py-3 border border-[var(--border-light)] rounded hover:bg-[var(--bg-hover)] transition"
                                :class="settingsForm.font_style === 'serif' ? 'bg-[var(--accent-main)] text-white border-transparent' : 'bg-[var(--bg-sub)]'">
                                <span class="font-serif text-sm">衬线体 (Serif)</span>
                            </button>
                            <button @click="applyFont('mono')"
                                class="py-3 border border-[var(--border-light)] rounded hover:bg-[var(--bg-hover)] transition"
                                :class="settingsForm.font_style === 'mono' ? 'bg-[var(--accent-main)] text-white border-transparent' : 'bg-[var(--bg-sub)]'">
                                <span class="font-mono text-sm">等宽 (Mono)</span>
                            </button>
                        </div>
                    </div>

                    <!-- 布局密度 -->
                    <div class="settings-group-title mt-8">布局与列表</div>
                    <div class="settings-row">
                        <div class="settings-row-header">
                            <div class="settings-label">卡片尺寸基准</div>
                            <span class="text-xs text-accent" x-text="settingsForm.card_width + 'px'"></span>
                        </div>
                        <input type="range" min="150" max="400" step="10" x-model="settingsForm.card_width"
                            @input="updateCssVariable('--card-min-width', $event.target.value + 'px')"
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="settings-label text-sm">角色卡每页数量</label>
                            <select x-model.number="settingsForm.items_per_page" class="form-input mt-1">
                                <option value="0">✨ 自动 (Auto)</option>
                                <option value="20">20 张</option>
                                <option value="40">40 张</option>
                                <option value="100">100 张</option>
                                <option value="200">200 张</option>
                            </select>
                        </div>
                        <div>
                            <label class="settings-label text-sm">世界书每页数量</label>
                            <select x-model.number="settingsForm.items_per_page_wi" class="form-input mt-1">
                                <option value="0">✨ 自动 (Auto)</option>
                                <option value="20">20 本</option>
                                <option value="50">50 本</option>
                                <option value="100">100 本</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row mt-4">
                        <label class="settings-label text-sm">默认排序方式</label>
                        <select x-model="settingsForm.default_sort" class="form-input mt-1">
                            <option value="date_desc">修改日期 (新 ➜ 旧)</option>
                            <option value="date_asc">修改日期 (旧 ➜ 新)</option>
                            <option value="name_asc">名称 (A ➜ Z)</option>
                            <option value="name_desc">名称 (Z ➜ A)</option>
                            <option value="token_desc">Token 量 (大 ➜ 小)</option>
                            <option value="token_asc">Token 量 (小 ➜ 大)</option>
                        </select>
                    </div>

                    <!-- 个性化背景 -->
                    <div class="settings-group-title mt-8">个性化壁纸 (Wallpaper)</div>
                    <div class="settings-row">
                        <div class="flex gap-2 mb-2">
                            <input type="text" x-model="settingsForm.bg_url"
                                @change="updateBackgroundImage(settingsForm.bg_url)" class="form-input text-sm"
                                placeholder="输入图片 URL 或上传 ->">
                            <button @click="triggerBackgroundUpload()" class="btn-secondary px-3 whitespace-nowrap">📂
                                上传</button>
                            <input type="file" x-ref="bgUploadInput" @change="handleBackgroundUpload" accept="image/*"
                                style="display: none;">
                            <button @click="settingsForm.bg_url=''; updateBackgroundImage('')"
                                class="btn-secondary px-3" title="清除">✕</button>
                        </div>

                        <div x-show="settingsForm.bg_url" x-transition
                            class="bg-[var(--bg-sub)] p-3 rounded border border-[var(--border-light)] mt-2">
                            <div class="mb-3">
                                <div class="flex justify-between text-xs mb-1">
                                    <span>遮罩浓度 (Overlay Opacity)</span>
                                    <span x-text="Math.round(settingsForm.bg_opacity * 100) + '%'"></span>
                                </div>
                                <input type="range" min="0.2" max="1" step="0.05" x-model="settingsForm.bg_opacity"
                                    @input="updateCssVariable('--bg-overlay-opacity', $event.target.value)"
                                    class="w-full h-1.5 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span>背景模糊 (Blur)</span>
                                    <span x-text="settingsForm.bg_blur + 'px'"></span>
                                </div>
                                <input type="range" min="0" max="20" step="1" x-model="settingsForm.bg_blur"
                                    @input="updateCssVariable('--bg-blur', $event.target.value + 'px')"
                                    class="w-full h-1.5 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>
                    <div
                        class="settings-row flex justify-between items-center py-2 border-b border-[var(--border-light)]">
                        <div>
                            <div class="settings-label">收藏卡片前置 (Pin Favorites)</div>
                            <div class="settings-desc">总是将收藏的卡片排在列表最前面</div>
                        </div>
                        <input type="checkbox" x-model="settingsForm.favorites_first"
                            class="w-5 h-5 accent-[var(--accent-main)]">
                    </div>
                </div>

                <!-- TAB 3: 连接与服务 (Connection) -->
                <div x-show="activeSettingTab==='connection'" x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 translate-x-2">
                    <div class="settings-group-title">SillyTavern 本地目录</div>

                    <div class="settings-row">
                        <label class="settings-label text-cyan-400">ST 安装目录</label>
                        <div class="settings-desc">请输入 SillyTavern 安装根目录（包含 data/public/server.js）。若填入 data 或 default-user，将自动转换为根目录。</div>
                        <div class="flex gap-2 mt-2">
                            <input type="text" x-model="settingsForm.st_data_dir" class="form-input flex-1"
                                placeholder="留空自动探测，如 D:\SillyTavern">
                            <button @click="detectSTPath()" class="btn-secondary px-3" title="自动探测">🔍</button>
                            <button @click="validateSTPath()" class="btn-secondary px-3" title="验证路径">✓</button>
                        </div>
                        <div x-show="stPathStatus" x-transition class="mt-2 text-sm"
                            :class="stPathValid ? 'text-green-400' : 'text-red-400'" x-text="stPathStatus"></div>
                    </div>

                    <div x-show="stResources && Object.keys(stResources).length > 0" x-transition 
                        class="settings-row p-3 rounded border border-[var(--border-light)] bg-[var(--bg-sub)]">
                        <div class="text-sm font-bold mb-2">📊 检测到的资源</div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                            <template x-for="(info, type) in stResources" :key="type">
                                <div class="flex justify-between p-2 rounded bg-[var(--bg-main)]">
                                    <span x-text="getResourceLabel(type)"></span>
                                    <span class="text-accent" x-text="info.count + ' 个'"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="text-sm font-bold mb-2">🔄 从 SillyTavern 同步资源</div>
                        <div class="settings-desc mb-3">将 SillyTavern 中的资源复制到 ST-Manager 管理的目录</div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <button @click="syncFromST('characters')" class="btn-secondary py-2 text-sm"
                                :disabled="syncing">🎴 同步角色卡</button>
                            <button @click="syncFromST('worlds')" class="btn-secondary py-2 text-sm"
                                :disabled="syncing">📚 同步世界书</button>
                            <button @click="syncFromST('presets')" class="btn-secondary py-2 text-sm"
                                :disabled="syncing">📝 同步预设</button>
                            <button @click="syncFromST('regex')" class="btn-secondary py-2 text-sm"
                                :disabled="syncing">🔧 同步正则</button>
                            <button @click="syncFromST('quick_replies')" class="btn-secondary py-2 text-sm"
                                :disabled="syncing">💬 同步快速回复</button>
                            <button @click="syncAllFromST()" class="btn-primary py-2 text-sm"
                                :disabled="syncing">⚡ 全部同步</button>
                        </div>
                        <div x-show="syncStatus" x-transition class="mt-3 p-2 rounded text-sm"
                            :class="syncSuccess ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'"
                            x-text="syncStatus"></div>
                    </div>

                    <div class="settings-group-title mt-8">SillyTavern API 连接</div>

                    <div class="settings-row">
                        <label class="settings-label text-pink-400">ST 服务地址</label>
                        <input type="text" x-model="settingsForm.st_url" class="form-input mt-1"
                            placeholder="http://127.0.0.1:8000">
                    </div>

                    <div class="settings-row">
                        <label class="settings-label text-gray-400">请求代理 (Proxy)</label>
                        <div class="settings-desc">
                            可选。若连接 ST 需经由代理，请在此填写 (如 http://127.0.0.1:7890)。<br>
                            <span class="text-yellow-500 text-xs">留空则强制直连 (忽略系统代理)。</span>
                        </div>
                        <input type="text" x-model="settingsForm.st_proxy" class="form-input mt-1"
                            placeholder="http://127.0.0.1:7890">
                    </div>

                    <div class="settings-row p-4 rounded border border-[var(--border-light)] bg-[var(--bg-sub)]">
                        <label class="settings-label mb-2 block">认证方式</label>
                        <div class="flex gap-4 mb-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="auth_type" value="basic" x-model="settingsForm.st_auth_type"
                                    class="w-4 h-4">
                                <span class="text-sm">Basic Auth (API Key / 旧版)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="auth_type" value="web" x-model="settingsForm.st_auth_type"
                                    class="w-4 h-4">
                                <span class="text-sm">Web Login (新版登录)</span>
                            </label>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-[var(--text-dim)] uppercase">用户名</label>
                                <input type="text" x-model="settingsForm.st_username" class="form-input mt-1">
                            </div>
                            <div>
                                <label class="text-xs text-[var(--text-dim)] uppercase">密码</label>
                                <input type="password" x-model="settingsForm.st_password" class="form-input mt-1">
                            </div>
                        </div>
                    </div>

                    <div class="settings-group-title mt-8">ST Manager 服务</div>
                    <div class="settings-row">
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="settings-label text-orange-400">监听地址 (Host)</label>
                                <div class="settings-desc">默认 127.0.0.1，如需局域网访问请设为 0.0.0.0</div>
                                <input type="text" x-model="settingsForm.host" class="form-input mt-1"
                                    placeholder="127.0.0.1">
                            </div>
                            <div class="w-32">
                                <label class="settings-label text-orange-400">端口 (Port)</label>
                                <div class="settings-desc">重启生效</div>
                                <input type="number" x-model.number="settingsForm.port" class="form-input mt-1"
                                    placeholder="5000">
                            </div>
                        </div>
                        <div class="text-xs text-red-400 mt-2">⚠️ 修改 Host 或 Port 需要手动重启程序才能生效。</div>
                    </div>

                    <div class="settings-row p-4 rounded border border-[var(--border-light)] bg-[var(--bg-sub)]">
                        <label class="settings-label text-red-400 mb-2 block">🔐 外网访问身份验证</label>
                        <div class="settings-desc mb-4">
                            启用后，不在白名单内的 IP 访问时需要登录验证。<br>
                            <span class="text-yellow-400 text-xs">⚠️ 默认仅 127.0.0.1 (本机) 免登录，局域网 IP 也需要登录。</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-[var(--text-dim)] uppercase">用户名</label>
                                <input type="text" x-model="settingsForm.auth_username" class="form-input mt-1"
                                    placeholder="留空则不启用认证">
                            </div>
                            <div>
                                <label class="text-xs text-[var(--text-dim)] uppercase">密码</label>
                                <input type="password" x-model="settingsForm.auth_password" class="form-input mt-1"
                                    placeholder="留空则不启用认证">
                            </div>
                        </div>

                        <!-- IP 白名单 -->
                        <div class="mt-4 pt-4 border-t border-[var(--border-light)]">
                            <label class="text-xs text-[var(--text-dim)] uppercase mb-2 block">IP 白名单 (免登录)</label>
                            <div class="settings-desc mb-2">
                                添加信任的 IP 地址，这些 IP 无需登录即可访问。<br>
                                <span class="text-xs opacity-70">
                                    支持格式：单个 IP (192.168.1.100)、网段 (192.168.1.0/24)、通配符 (192.168.*.*)
                                </span>
                            </div>

                            <!-- 白名单列表 -->
                            <div class="space-y-2 mb-3">
                                <div class="flex items-center gap-2 px-2 py-1 rounded bg-[var(--bg-panel)] text-sm text-green-400">
                                    <span class="flex-1 font-mono">127.0.0.1, ::1</span>
                                    <span class="text-xs opacity-50">(本机 - 固定)</span>
                                </div>
                                <template x-for="(ip, index) in (settingsForm.auth_trusted_ips || [])" :key="index">
                                    <div class="flex items-center gap-2 px-2 py-1 rounded bg-[var(--bg-panel)]">
                                        <input type="text" x-model="settingsForm.auth_trusted_ips[index]"
                                            class="flex-1 bg-transparent border-none text-sm font-mono focus:outline-none"
                                            placeholder="192.168.1.0/24">
                                        <button @click="settingsForm.auth_trusted_ips.splice(index, 1)"
                                            class="text-red-400 hover:text-red-300 text-sm px-2">✕</button>
                                    </div>
                                </template>
                            </div>

                            <!-- 添加按钮 -->
                            <button @click="if(!settingsForm.auth_trusted_ips) settingsForm.auth_trusted_ips = []; settingsForm.auth_trusted_ips.push('')"
                                class="btn-secondary text-sm py-1 px-3">
                                + 添加 IP
                            </button>

                            <!-- 快捷添加 -->
                            <div class="mt-3 flex flex-wrap gap-2">
                                <span class="text-xs text-[var(--text-dim)]">快捷添加：</span>
                                <button @click="if(!settingsForm.auth_trusted_ips) settingsForm.auth_trusted_ips = []; if(!settingsForm.auth_trusted_ips.includes('192.168.*.*')) settingsForm.auth_trusted_ips.push('192.168.*.*')"
                                    class="text-xs px-2 py-0.5 rounded bg-blue-900/30 text-blue-400 hover:bg-blue-900/50">
                                    192.168.*.* (局域网 C 类)
                                </button>
                                <button @click="if(!settingsForm.auth_trusted_ips) settingsForm.auth_trusted_ips = []; if(!settingsForm.auth_trusted_ips.includes('10.*.*.*')) settingsForm.auth_trusted_ips.push('10.*.*.*')"
                                    class="text-xs px-2 py-0.5 rounded bg-blue-900/30 text-blue-400 hover:bg-blue-900/50">
                                    10.*.*.* (局域网 A 类)
                                </button>
                            </div>
                        </div>

                        <div class="text-xs text-yellow-400 mt-3">
                            ⚠️ 仅当用户名和密码都设置时才会启用认证。修改后保存即可生效。
                        </div>
                    </div>
                </div>

                <!-- TAB 4: 维护与高级 (Maintenance) -->
                <div x-show="activeSettingTab==='maintenance'" x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 translate-x-2">
                    <div class="settings-group-title">数据维护</div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- 扫描 -->
                        <div
                            class="p-4 rounded border border-[var(--border-light)] bg-[var(--bg-sub)] flex flex-col justify-between">
                            <div>
                                <div class="font-bold mb-1">🔄 同步扫描</div>
                                <div class="text-xs text-[var(--text-dim)] mb-3">强制扫描 cards
                                    目录并修复数据库索引。如果手动修改了文件，请执行此操作。</div>
                            </div>
                            <button @click="scanNow()" class="btn-secondary w-full py-2">立即扫描</button>
                        </div>

                        <!-- 备份 -->
                        <div
                            class="p-4 rounded border border-[var(--border-light)] bg-[var(--bg-sub)] flex flex-col justify-between">
                            <div>
                                <div class="font-bold mb-1">💾 备份数据</div>
                                <div class="text-xs text-[var(--text-dim)] mb-3">备份 ui_data.json 到根目录。建议定期执行。</div>
                            </div>
                            <button @click="systemAction('backup_data')" class="btn-secondary w-full py-2">执行备份</button>
                        </div>

                        <!-- 资源管理 -->
                        <div
                            class="p-4 rounded border border-[var(--border-light)] bg-[var(--bg-sub)] flex flex-col justify-between">
                            <div>
                                <div class="font-bold mb-1">📂 资源文件夹</div>
                                <div class="text-xs text-[var(--text-dim)] mb-3">打开存放图片、Markdown附件的目录。</div>
                            </div>
                            <button @click="systemAction('open_notes')" class="btn-secondary w-full py-2">打开目录</button>
                        </div>

                        <!-- 回收站 -->
                        <div
                            class="p-4 rounded border border-[var(--border-light)] bg-[var(--bg-sub)] flex flex-col justify-between">
                            <div>
                                <div class="font-bold mb-1">🗑️ 文件回收站</div>
                                <div class="text-xs text-[var(--text-dim)] mb-3">管理已删除的卡片。</div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="openTrashFolder()" class="btn-secondary flex-1 py-2">📂 打开</button>
                                <button @click="emptyTrash()"
                                    class="btn-secondary flex-1 py-2 text-red-400 hover:text-red-500">⚠ 清空</button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-group-title">高级选项</div>

                    <div class="settings-row border-b border-[var(--border-light)] py-3">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="settings-label">PNG 元数据确定性排序</div>
                                <div class="settings-desc">关闭可避免改变外部工具的字节级行为（建议保持关闭）</div>
                            </div>
                            <input type="checkbox" x-model="settingsForm.png_deterministic_sort"
                                class="w-5 h-5 accent-[var(--accent-main)]">
                        </div>
                    </div>

                    <div class="settings-row border-b border-[var(--border-light)] py-3">
                        <div class="settings-label">世界书预览限制</div>
                        <div class="settings-desc">控制详情弹窗的预览条目数与单条内容最大字符数</div>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <div>
                                <label class="text-xs text-[var(--text-dim)]">预览最大条目数</label>
                                <input type="number" x-model.number="settingsForm.wi_preview_limit"
                                    class="form-input mt-1" min="0">
                            </div>
                            <div>
                                <label class="text-xs text-[var(--text-dim)]">单条最大字符数</label>
                                <input type="number" x-model.number="settingsForm.wi_preview_entry_max_chars"
                                    class="form-input mt-1" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="settings-row border-b border-[var(--border-light)] py-3">
                        <div class="settings-label">资源目录绝对路径白名单</div>
                        <div class="settings-desc">一行一个路径，用于允许资源文件列表接口访问绝对路径</div>
                        <textarea x-model="allowedAbsRootsText" class="form-input mt-2"
                            rows="3" placeholder="D:\\SillyTavern\\assets&#10;E:\\resources"></textarea>
                    </div>

                    <!-- 自动保存设置行 -->
                    <div class="settings-row border-b border-[var(--border-light)] py-3">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="settings-label">快照保留数量 (Snapshot Limits)</div>
                                <div class="settings-desc">超过限制时自动删除最旧的快照</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <div>
                                <label class="text-xs text-[var(--text-dim)]">手动快照 (Manual) (上限200)</label>
                                <input type="number" x-model.number="settingsForm.snapshot_limit_manual"
                                    class="form-input mt-1" min="1" max="200">
                            </div>
                            <div>
                                <label class="text-xs text-[var(--text-dim)]">自动快照 (Auto) (上限50)</label>
                                <input type="number" x-model.number="settingsForm.snapshot_limit_auto"
                                    class="form-input mt-1" min="1" max="50">
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <div class="settings-label">智能自动快照 (Smart Auto Snapshot)</div>
                                <div class="settings-desc">定时检查变更并创建备份（仅当内容变化且历史备份中不存在时创建）</div>
                            </div>
                            <!-- 开关 -->
                            <input type="checkbox" name="toggle" id="auto-save-toggle"
                                x-model="settingsForm.auto_save_enabled" class="w-5 h-5 accent-[var(--accent-main)]" />
                        </div>

                        <!-- 时间间隔滑块 (仅开启时显示) -->
                        <div x-show="settingsForm.auto_save_enabled" x-transition
                            class="bg-[var(--bg-sub)] p-3 rounded border border-[var(--border-light)] mt-2 flex items-center gap-4">
                            <span class="text-sm whitespace-nowrap">⏱️ 保存间隔:</span>
                            <input type="range" min="1" max="60" step="1"
                                x-model.number="settingsForm.auto_save_interval"
                                class="flex-1 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            <span class="text-sm font-mono w-16 text-right">
                                <span x-text="settingsForm.auto_save_interval"></span> min
                            </span>
                        </div>
                    </div>

                    <div
                        class="settings-row flex items-center justify-between py-2 border-b border-[var(--border-light)]">
                        <div>
                            <div class="settings-label">静默快照 (Silent Snapshot)</div>
                            <div class="settings-desc">创建备份快照时不弹出确认提示框</div>
                        </div>
                        <input type="checkbox" x-model="settingsForm.silent_snapshot"
                            class="w-5 h-5 accent-[var(--accent-main)]">
                    </div>
                </div>

            </main>
        </div>

        <!-- 3. 底部操作栏 -->
        <div class="settings-footer">
            <button @click="saveSettings()" class="btn-primary px-6 py-2 rounded-lg font-bold shadow-lg">
                💾 保存并应用
            </button>
        </div>
    </div>
</div>
