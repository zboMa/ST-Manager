<!-- ÂÖ®Â±è‰∏ñÁïå‰π¶ÁºñËæëÂô® (UI Refactored & Bug Fixed) -->
<div x-show="showFullScreenWI" x-data="wiEditor" x-cloak class="detail-wi-full-screen fixed inset-0 z-modal-editor wi-editor-container"
    @click.self="showFullScreenWI=false">

    <!-- ÂÜÖÈÉ®Â∏ÉÂ±ÄÁä∂ÊÄÅÁÆ°ÁêÜ -->
    <div class="flex flex-col h-full w-full overflow-hidden"
        x-data="{ rightTab: 'settings', showLeftList: $store.global.deviceType !== 'mobile', showRightPanel: $store.global.deviceType !== 'mobile' }">

        <!-- 1. È°∂ÈÉ®ÂØºËà™Ê†è -->
        <div class="h-12 border-b items-center justify-between px-4 shadow-sm flex-shrink-0 z-20"
            :class="$store.global.deviceType === 'mobile' ? '' : 'flex'"
            style="background: var(--bg-panel); border-color: var(--border-main);">

            <div class="flex items-center gap-4 min-w-0">
                <!-- Ê†áÈ¢ò/Logo -->
                <div class="flex items-center gap-2 text-orange-400 font-bold select-none cursor-default">
                    <span>üåé</span> <span class="hidden md:inline">ÁºñËæëÂô®</span>
                </div>

                <!-- Êù•Ê∫êÊ†áËÆ∞ (Badge) - ‰ΩøÁî® template x-if Èò≤Ê≠¢ÂàùÂßãÂåñÊä•Èîô -->
                <template x-if="editingWiFile">
                    <div class="px-2 py-0.5 rounded text-[10px] font-bold tracking-wider uppercase border bg-opacity-10"
                        :class="{
                            'bg-blue-500 border-blue-500 text-blue-400': editingWiFile.type === 'global',
                            'bg-green-500 border-green-500 text-green-400': editingWiFile.type === 'resource',
                            'bg-purple-500 border-purple-500 text-purple-400': editingWiFile.type === 'embedded'
                        }">
                        <span x-text="editingWiFile.type"></span>
                    </div>
                </template>

                <div class="h-4 w-[1px] bg-[var(--border-light)]"></div>

                <!-- Ê†áÈ¢òËæìÂÖ•Ê°Ü -->
                <div class="flex items-center gap-2">
                    <span x-show="!editingWiFile && activeCard" class="text-xs text-gray-500 truncate max-w-[100px]"
                        x-text="activeCard ? activeCard.char_name + ' /' : ''"></span>

                    <template x-if="editingData && editingData.character_book">
                        <input type="text" x-model="editingData.character_book.name"
                            class="bg-transparent text-sm font-bold border-b border-transparent hover:border-gray-500 focus:border-accent-main outline-none transition-colors w-40 md:w-64"
                            placeholder="‰∏ñÁïå‰π¶ÂêçÁß∞...">
                    </template>
                </div>
            </div>

            <!-- Âè≥‰æßÊåâÈíÆÁªÑ -->
            <div class="flex items-center gap-2" :class="$store.global.deviceType === 'mobile' ? 'justify-end' : ''">
                <!-- Token ÁªüËÆ° -->
                <div class="hidden lg:flex flex-col items-end mr-4 px-3 border-r border-[var(--border-light)]"
                    title="È¢Ñ‰º∞ÊÄª Token">
                    <span class="text-[9px] text-gray-500 uppercase font-bold">Tokens</span>
                    <span class="text-xs font-mono font-bold text-neon"
                        :class="(typeof getTotalWiTokens === 'function' && getTotalWiTokens() > 10000) ? 'text-red-400' : 'text-green-400'"
                        x-text="typeof getTotalWiTokens === 'function' ? getTotalWiTokens() : 0">
                    </span>
                </div>

                <div class="hidden lg:flex items-center gap-2 mr-2" x-show="activeEditorEntry">
                    <span class="wi-pill mono" :class="activeEditorEntry?.enabled ? 'on' : 'off'"
                        x-text="activeEditorEntry?.enabled ? 'EN' : 'OFF'"></span>

                    <span class="wi-pill"
                        :class="activeEditorEntry?.constant ? 'const' : (activeEditorEntry?.vectorized ? 'vector' : 'normal')"
                        x-text="activeEditorEntry?.constant ? 'Constant' : (activeEditorEntry?.vectorized ? 'Vector' : 'Normal')"></span>

                    <span class="wi-pill mono" x-text="'#' + (activeEditorEntry?.insertion_order ?? 0)"></span>
                </div>

                <!-- 1. Êó∂ÂÖâÊú∫ -->
                <button @click="openRollback && openRollback()" class="wi-action-btn" title="Êó∂ÂÖâÊú∫ÔºöÊü•ÁúãÂéÜÂè≤ÁâàÊú¨‰∏éÂõûÊªö">‚è™</button>

                <!-- 2. Âø´ÁÖß -->
                <button @click="createSnapshot('lorebook')" @contextmenu.prevent="createKeySnapshot('lorebook')"
                    class="wi-action-btn"
                    :title="(!editingWiFile || editingWiFile.type === 'embedded') ? 'Â§á‰ªΩÂΩìÂâçËßíËâ≤ (Â∑¶ÈîÆ: ÊôÆÈÄö | Âè≥ÈîÆ: ÂÖ≥ÈîÆËäÇÁÇπ)' : 'Â§á‰ªΩÂΩìÂâç‰∏ñÁïå‰π¶ (Â∑¶ÈîÆ: ÊôÆÈÄö | Âè≥ÈîÆ: ÂÖ≥ÈîÆËäÇÁÇπ)'">
                    üì∏
                </button>

                <!-- 3. ÊâìÂºÄÂ§á‰ªΩÊñá‰ª∂Â§π -->
                <button @click="openBackupFolder('lorebook')" class="wi-action-btn" title="ÊâìÂºÄÂ§á‰ªΩÊñá‰ª∂Â§π">üìÇ</button>

                <div class="h-4 w-[1px] bg-[var(--border-light)] mx-1"></div>

                <!-- 4. ‰øùÂ≠òÊåâÈíÆÁªÑ -->
                <div class="flex items-center gap-2">
                    <!-- Âú∫ÊôØ A: ÁºñËæëÁã¨Á´ãÊñá‰ª∂ (ÊòæÁ§∫‰øùÂ≠òÊñá‰ª∂ + Âè¶Â≠ò‰∏∫) -->
                    <template x-if="editingWiFile && editingWiFile.type !== 'embedded'">
                        <div class="flex items-center gap-2">
                            <button @click="saveWiFileChanges()" :disabled="isSaving"
                                class="btn-primary px-4 py-1.5 rounded text-xs font-bold shadow-lg flex items-center gap-2 whitespace-nowrap transition-all hover:brightness-110">
                                <span x-show="isSaving" class="animate-spin">‚è≥</span>
                                <span>üíæ</span>
                                <span x-show="$store.global.deviceType !== 'mobile'"> ‰øùÂ≠òÊù°ÁõÆ</span>
                            </button>
                            <button @click="saveWholeWorldbook()" :disabled="isSaving"
                                class="btn-secondary px-3 py-1.5 text-xs rounded whitespace-nowrap" title="ÂÖàÂàõÂª∫Êï¥Êú¨ÂõûÊªöÁâàÊú¨ÔºåÂÜçÊâßË°å‰øùÂ≠ò">
                                <span>üóÇÔ∏è</span>
                                <span x-show="$store.global.deviceType !== 'mobile'"> ‰øùÂ≠òÊï¥Êú¨</span>
                            </button>
                            <button @click="saveAsGlobalWi()"
                                class="btn-secondary px-3 py-1.5 text-xs rounded whitespace-nowrap" title="Âè¶Â≠ò‰∏∫Êñ∞Êñá‰ª∂">
                                <span>üì§</span>
                                <span x-show="$store.global.deviceType !== 'mobile'"> Âè¶Â≠ò‰∏∫...</span>
                            </button>
                        </div>
                    </template>

                    <!-- Âú∫ÊôØ B: ÁºñËæëÂç°ÁâáÂÜÖÂµå (ÊòæÁ§∫‰øùÂ≠òÂà∞Âç°Áâá + Âè¶Â≠ò‰∏∫ÂÖ®Â±Ä) -->
                    <template x-if="!editingWiFile || editingWiFile.type === 'embedded'">
                        <div class="flex items-center gap-2">
                            <button @click="saveChanges()" :disabled="isSaving"
                                class="btn-primary px-4 py-1.5 rounded text-xs font-bold shadow-lg flex items-center gap-2 whitespace-nowrap transition-all hover:brightness-110">
                                <span x-show="isSaving" class="animate-spin">‚è≥</span>
                                <span>üíæ</span>
                                <span x-show="$store.global.deviceType !== 'mobile'"> ‰øùÂ≠òÊù°ÁõÆ</span>
                            </button>
                            <button @click="saveWholeWorldbook()" :disabled="isSaving"
                                class="btn-secondary px-3 py-1.5 text-xs rounded whitespace-nowrap" title="ÂÖàÂàõÂª∫Êï¥Êú¨ÂõûÊªöÁâàÊú¨ÔºåÂÜçÊâßË°å‰øùÂ≠ò">
                                <span>üóÇÔ∏è</span>
                                <span x-show="$store.global.deviceType !== 'mobile'"> ‰øùÂ≠òÊï¥Êú¨</span>
                            </button>
                            <button @click="saveAsGlobalWi()"
                                class="btn-secondary px-3 py-1.5 text-xs rounded whitespace-nowrap" title="ÊèêÂèñ‰∏∫ÂÖ®Â±Ä‰∏ñÁïå‰π¶">
                                <span>üì§</span>
                                <span x-show="$store.global.deviceType !== 'mobile'"> Âè¶Â≠ò‰∏∫ÂÖ®Â±Ä</span>
                            </button>
                        </div>
                    </template>
                </div>

                <button @click="showFullScreenWI=false"
                    class="btn-secondary px-3 py-1.5 text-xs rounded hover:bg-red-500/20 hover:text-red-400 ml-2">
                    ‚úï
                </button>
            </div>
        </div>

        <!-- 2. ‰∏ª‰ΩìÂå∫Âüü -->
        <div class="flex-1 flex overflow-hidden relative">

            <!-- === Â∑¶‰æßÂàóË°® === -->
            <div class="flex flex-col border-r transition-all duration-300 ease-in-out bg-[var(--bg-sub)] relative"
                :style="{ width: showLeftList ? '260px' : '0px', opacity: showLeftList ? '1' : '0' }"
                style="border-color: var(--border-main);">

                <div class="p-2 border-b border-[var(--border-light)] flex-shrink-0">
                    <button @click="addWiEntry()"
                        class="w-full bg-green-600/10 text-green-500 border border-green-600/30 py-1.5 rounded text-xs hover:bg-green-600/20 font-bold transition-all flex items-center justify-center gap-1">
                        <span>+</span> Êñ∞Â¢ûÊù°ÁõÆ
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1">
                    <!-- ‰ΩøÁî® Optional Chain È£éÊ†ºÁöÑÊ£ÄÊü•Èò≤Ê≠¢ÂàùÂßãÂåñÁ©∫ÊåáÈíà -->
                    <template x-for="(entry, index) in (typeof getWIArrayRef === 'function' ? getWIArrayRef() : [])"
                        :key="entry.id || index">
                        <div :id="'wi-item-' + index" @click="selectMainWiItem(index)" draggable="true"
                            @dragstart="wiDragStart($event, index)" @drop="wiDrop($event, index)"
                            @dragover="wiDragOver($event, index)"
                            class="wi-list-item p-2 rounded cursor-pointer group relative text-xs select-none border border-transparent"
                            :data-type="entry.constant ? 'const' : (entry.vectorized ? 'vector' : 'normal')"
                            :class="currentWiIndex === index ? 'active' : ''">

                            <div class="flex justify-between items-center mb-1">
                                <div class="flex items-center gap-2 overflow-hidden flex-1">
                                    <div class="w-2 h-2 rounded-full flex-shrink-0 shadow-sm" :class="{
                                             'bg-blue-500 shadow-blue-500/50': entry.constant,
                                             'bg-purple-500 shadow-purple-500/50': !entry.constant && entry.vectorized,
                                             'bg-green-500 shadow-green-500/50': !entry.constant && !entry.vectorized && entry.enabled,
                                             'bg-gray-600': !entry.enabled
                                         }"></div>
                                    <span class="font-bold truncate"
                                        :class="currentWiIndex === index ? 'text-[var(--text-main)]' : 'text-[var(--text-sub)]'"
                                        x-text="entry.comment || 'Êó†Ê†áÈ¢ò'"></span>
                                </div>
                                <input type="checkbox" x-model="entry.enabled" @click.stop
                                    class="cursor-pointer accent-accent-main">
                            </div>

                            <div class="text-[10px] opacity-60 font-mono truncate pl-4">
                                <div class="flex items-center justify-between mt-0.5">
                                    <!-- Keys ÊòæÁ§∫ -->
                                    <span class="text-[10px] opacity-60 font-mono truncate max-w-[160px]"
                                        x-text="entry.constant ? 'Constant' : (entry.vectorized ? 'Vectorized' : (typeof formatWiKeys === 'function' ? formatWiKeys(entry.keys) : entry.keys))">
                                    </span>

                                    <!-- ÊùÉÈáçÊ†áËÆ∞ -->
                                    <span
                                        class="text-[9px] font-mono bg-black/10 dark:bg-white/10 px-1.5 rounded text-gray-500 ml-1 flex-shrink-0"
                                        title="ÊèíÂÖ•ÊùÉÈáç (Insertion Order)">
                                        #<span x-text="entry.insertion_order"></span>
                                    </span>
                                </div>
                                <div class="wi-li-preview text-[10px] opacity-50 truncate pl-4 mt-0.5"
                                    x-text="(entry.content || '').replace(/\n/g,' ').slice(0, 90)">
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="p-1 border-t border-[var(--border-light)] flex justify-center bg-[var(--bg-sub)]">
                    <button @click="showLeftList = false"
                        class="text-[10px] text-gray-500 hover:text-[var(--text-main)] w-full">‚óÄ Êî∂Ëµ∑ÂàóË°®</button>
                </div>
            </div>

            <!-- ÂàóË°®Â±ïÂºÄÊÇ¨ÊµÆÊåâÈíÆ -->
            <div x-show="!showLeftList" class="wi-toggle-btn-float left" @click="showLeftList = true" title="Â±ïÂºÄÂàóË°®">‚ñ∂
            </div>

            <!-- === ‰∏≠Èó¥ÔºöÊ≤âÊµ∏ÂºèÁºñËæëÂå∫ === -->
            <div class="wi-center-pane">
                <!-- ËøôÈáåÁöÑ x-if ÊòØÂÖ≥ÈîÆÔºöÂè™Êúâ activeEditorEntry Â≠òÂú®Êó∂ÔºåÂÜÖÈÉ® DOM Êâç‰ºöË¢´ÂàõÂª∫ -->
                <!-- Ê≥®ÊÑèÔºöÁßªÈô§‰∫Ü x-data="{ entry: ... }"ÔºåÁõ¥Êé•‰ΩøÁî® activeEditorEntry -->
                <template x-if="activeEditorEntry">
                    <div class="flex flex-col h-full">

                        <div class="p-4 pb-2 flex-shrink-0 flex items-center gap-4 transition-all duration-300 border-b"
                            :class="isEditingClipboard ? 'bg-purple-900/10 border-purple-500/30' : 'bg-transparent border-transparent'">

                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-[10px] uppercase font-bold tracking-wider block"
                                        :class="isEditingClipboard ? 'text-purple-400' : 'text-gray-500'">
                                        <span
                                            x-text="isEditingClipboard ? 'üìã Ê≠£Âú®ÁºñËæëÂâ™ÂàáÊùøÊù°ÁõÆ (Clipboard Item)' : 'Â§áÊ≥® (Comment)'"></span>
                                    </label>

                                    <!-- Ââ™ÂàáÊùøÊ®°ÂºèÂæΩÁ´† -->
                                    <span x-show="isEditingClipboard"
                                        class="text-[9px] px-1.5 py-0.5 rounded bg-purple-500 text-white font-bold animate-pulse">
                                        EDITING
                                    </span>
                                </div>

                                <input type="text" x-model="activeEditorEntry.comment"
                                    class="w-full bg-transparent text-lg font-bold border-b outline-none transition-colors p-1"
                                    :class="isEditingClipboard 
                    ? 'border-purple-500/30 focus:border-purple-500 placeholder-purple-300/50' 
                    : 'border-transparent focus:border-[var(--accent-main)]'" placeholder="ËæìÂÖ•Êù°ÁõÆÂ§áÊ≥®...">
                            </div>

                            <!-- ÊåâÈíÆÁªÑÔºöÊ†πÊçÆÊ®°ÂºèÂàáÊç¢ -->
                            <div class="flex gap-2">

                                <!-- Âú∫ÊôØ A: Ââ™ÂàáÊùøÊ®°Âºè (ÊòæÁ§∫‰øùÂ≠ò/ËøîÂõû) -->
                                <template x-if="isEditingClipboard">
                                    <div class="flex gap-2">
                                        <button @click="exitClipboardEdit()"
                                            class="wi-action-btn w-auto px-3 gap-1 hover:bg-gray-500/20 text-gray-500 border border-transparent hover:border-gray-500/30"
                                            title="ÂèñÊ∂àÁºñËæëÂπ∂ËøîÂõû">
                                            <span>‚Ü©</span> <span class="text-xs font-bold">ËøîÂõû</span>
                                        </button>
                                        <button @click="saveClipboardItem()"
                                            class="wi-action-btn w-auto px-3 gap-1 bg-purple-600 hover:bg-purple-500 text-white shadow-sm hover:shadow-purple-500/20"
                                            title="‰øùÂ≠òÂØπÂâ™ÂàáÊùøÊù°ÁõÆÁöÑ‰øÆÊîπ">
                                            <span>üíæ</span> <span class="text-xs font-bold">‰øùÂ≠ò</span>
                                        </button>
                                    </div>
                                </template>

                                <!-- Âú∫ÊôØ B: ÊôÆÈÄöÊ®°Âºè (ÊòæÁ§∫Âà†Èô§/Â§çÂà∂) -->
                                <template x-if="!isEditingClipboard">
                                    <div class="flex gap-2">
                                        <button @click.stop="openEntryHistoryModal()" title="Êù°ÁõÆÂéÜÂè≤ÂõûÊªö"
                                            class="wi-action-btn hover:text-orange-400 hover:bg-orange-500/10">
                                            üï∞Ô∏è
                                        </button>
                                        <button @click.stop="removeWiEntry(currentWiIndex)" title="Âà†Èô§Êù°ÁõÆ"
                                            class="wi-action-btn hover:text-red-400 hover:bg-red-500/10">
                                            üóëÔ∏è
                                        </button>
                                        <button @click.stop="copyWiToClipboard(activeEditorEntry)" title="Â§çÂà∂Âà∞Ââ™ÂàáÊùø"
                                            class="wi-action-btn hover:text-purple-400 hover:bg-purple-500/10">
                                            üìã
                                        </button>
                                    </div>
                                </template>

                            </div>
                        </div>

                        <div class="wi-content-wrapper relative" :class="{'bg-purple-900/5': isEditingClipboard}">
                            <label
                                class="text-neon absolute top-2 right-6 z-10 text-[10px] px-2 py-0.5 rounded border pointer-events-none opacity-80"
                                :class="isEditingClipboard ? 'text-purple-400 bg-purple-900/20 border-purple-500/30' : 'text-gray-500 bg-[var(--bg-panel)] border-[var(--border-light)]'">
                                CONTENT <span
                                    x-text="typeof estimateTokens === 'function' ? ('(' + estimateTokens(activeEditorEntry.content) + ' T)') : ''"></span>
                            </label>

                            <textarea x-model="activeEditorEntry.content" class="wi-main-textarea custom-scrollbar"
                                :class="{'border-purple-500/30 focus:border-purple-500': isEditingClipboard}"
                                placeholder="Âú®Ê≠§ËæìÂÖ•‰∏ñÁïå‰π¶ÂÜÖÂÆπ..."></textarea>
                        </div>
                    </div>
                </template>

                <template x-if="!activeEditorEntry">
                    <div class="flex-1 flex flex-col items-center justify-center text-gray-600 gap-4 select-none">
                        <div class="text-6xl opacity-20">üìù</div>
                        <p>ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™Êù°ÁõÆÂºÄÂßãÁºñËæë</p>
                    </div>
                </template>
            </div>

            <!-- === Âè≥‰æßÔºöÂ±ûÊÄßÈù¢Êùø === -->
            <div class="wi-inspector-panel custom-scrollbar"
                :style="{ width: showRightPanel ? '320px' : '0px', opacity: showRightPanel ? '1' : '0' }">

                <div class="wi-inspector-tabs">
                    <div class="wi-tab-btn" :class="rightTab==='settings' && 'active'" @click="rightTab='settings'">‚öôÔ∏è
                        Â±ûÊÄßËÆæÁΩÆ</div>
                    <div class="wi-tab-btn" :class="rightTab==='clipboard' && 'active'" @click="rightTab='clipboard'">üìã
                        Ââ™ÂàáÊùø</div>
                    <button @click="showRightPanel = false"
                        class="px-3 text-gray-500 hover:text-red-400 border-l border-[var(--border-light)]">‚úï</button>
                </div>

                <!-- Tab 1: Settings Inspector -->
                <!-- ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰ΩøÁî® template x-if Á°Æ‰øù activeEditorEntry Â≠òÂú®Ôºå‰∏î rightTab ÂåπÈÖçÊó∂ÊâçÊ∏≤Êüì -->
                <template x-if="rightTab==='settings' && activeEditorEntry">
                    <div class="wi-inspector-content">

                        <!-- 1. Ëß¶ÂèëÁ≠ñÁï• -->
                        <div class="props-group">
                            <div class="props-header text-blue-400">Ëß¶ÂèëÁ≠ñÁï• (Strategy)</div>
                            <div class="props-body">
                                <div class="flex gap-2">
                                    <label
                                        class="flex-1 flex flex-col items-center justify-center p-2 rounded border cursor-pointer transition-all"
                                        :class="activeEditorEntry.constant ? 'bg-blue-500/10 border-blue-500 text-blue-400' : 'border-[var(--border-light)] hover:bg-[var(--bg-hover)]'">
                                        <input type="checkbox" x-model="activeEditorEntry.constant"
                                            @change="if(activeEditorEntry.constant) activeEditorEntry.vectorized = false"
                                            class="hidden">
                                        <span class="text-lg">üîµ</span>
                                        <span class="text-[10px] mt-1 font-bold">Â∏∏È©ª (Constant)</span>
                                    </label>
                                    <label
                                        class="flex-1 flex flex-col items-center justify-center p-2 rounded border cursor-pointer transition-all"
                                        :class="activeEditorEntry.vectorized ? 'bg-purple-500/10 border-purple-500 text-purple-400' : 'border-[var(--border-light)] hover:bg-[var(--bg-hover)]'">
                                        <input type="checkbox" x-model="activeEditorEntry.vectorized"
                                            @change="if(activeEditorEntry.vectorized) activeEditorEntry.constant = false"
                                            class="hidden">
                                        <span class="text-lg">üìé</span>
                                        <span class="text-[10px] mt-1 font-bold">ÂêëÈáèÂåñ (Vector)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 2. ÂÖ≥ÈîÆËØç (‰ΩøÁî® template x-if Â§ÑÁêÜÂÜÖÈÉ®ÈÄªËæëÊòæÁ§∫) -->
                        <template x-if="!activeEditorEntry.constant && !activeEditorEntry.vectorized">
                            <div class="props-group">
                                <div class="props-header text-green-400">ÂÖ≥ÈîÆËØç (Keywords)</div>
                                <div class="props-body space-y-3">
                                    <div>
                                        <label class="text-[10px] text-gray-500 block mb-1">‰∏ªËß¶ÂèëËØç (Primary Keys)</label>
                                        <textarea
                                            :value="(activeEditorEntry && typeof formatWiKeys === 'function') ? formatWiKeys(activeEditorEntry.keys) : (activeEditorEntry?.keys || '')"
                                            @input="activeEditorEntry && (typeof updateWiKeys === 'function' ? updateWiKeys(activeEditorEntry, $event.target.value) : (activeEditorEntry.keys = $event.target.value.split(',')))"
                                            class="w-full bg-[var(--bg-body)] border border-[var(--border-light)] rounded p-2 text-xs font-mono text-yellow-500 focus:border-yellow-500 outline-none resize-none h-16"
                                            placeholder="key1, key2..."></textarea>
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-gray-500 block mb-1">Ê¨°Ë¶Å/ËøáÊª§ËØç (Filter Keys)</label>
                                        <textarea
                                            :value="(activeEditorEntry && typeof formatWiKeys === 'function') ? formatWiKeys(activeEditorEntry.secondary_keys) : (activeEditorEntry?.secondary_keys || '')"
                                            @input="activeEditorEntry && (activeEditorEntry.secondary_keys = $event.target.value.split(',').map(s=>s.trim()).filter(s=>s))"
                                            class="w-full bg-[var(--bg-body)] border border-[var(--border-light)] rounded p-2 text-xs font-mono text-teal-500 focus:border-teal-500 outline-none resize-none h-12"
                                            placeholder="ÂèØÈÄâËøáÊª§ËØç..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- 3. ÊèíÂÖ•ËÆæÁΩÆ -->
                        <div class="props-group">
                            <div class="props-header text-orange-400">ÊèíÂÖ•ËÆæÁΩÆ (Insertion)</div>
                            <div class="props-body text-xs space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500">‰ΩçÁΩÆ (Position)</span>
                                    <select x-model.number="activeEditorEntry.position"
                                        class="bg-[var(--bg-body)] border border-[var(--border-light)] rounded px-2 py-1 max-w-[140px]">
                                        <option value="0">0 - ËßíËâ≤ÂÆö‰πâÂâç (Before Char)</option>
                                        <option value="1">1 - ËßíËâ≤ÂÆö‰πâÂêé (After Char)</option>
                                        <option value="2">2 - ‰ΩúËÄÖÊ≥®ÈáäÂâç (Before AN)</option>
                                        <option value="3">3 - ‰ΩúËÄÖÊ≥®ÈáäÂêé (After AN)</option>
                                        <option value="5">5 - Á§∫‰æãÊ∂àÊÅØÂâç (Before EM)</option>
                                        <option value="6">6 - Á§∫‰æãÊ∂àÊÅØÂêé (After EM)</option>
                                        <option value="4">4 - @Â±ÇÁ∫ß (At Depth)</option>
                                        <option value="7">7 - ËæìÂá∫Á´Ø (Outlet)</option>
                                    </select>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500">ÊùÉÈáç (Order)</span>
                                    <input type="number" x-model.number="activeEditorEntry.insertion_order"
                                        class="w-16 bg-[var(--bg-body)] border border-[var(--border-light)] rounded px-2 py-1 text-center">
                                </div>
                                <template x-if="activeEditorEntry.position === 4">
                                    <div
                                        class="pt-2 border-t border-[var(--border-light)] flex items-center justify-between">
                                        <span class="text-gray-500">Ê∑±Â∫¶ (Depth)</span>
                                        <input type="number" x-model.number="activeEditorEntry.depth"
                                            class="w-16 bg-[var(--bg-body)] border border-[var(--border-light)] rounded px-2 py-1 text-center">
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="props-group">
                            <div class="props-header text-pink-400">ÈÄíÂΩí‰∏éÊµÅÁ®ã (Recursion)</div>
                            <div class="props-body text-xs space-y-2">
                                <label
                                    class="flex items-center gap-2 cursor-pointer p-1 hover:bg-[var(--bg-hover)] rounded">
                                    <input type="checkbox" x-model="activeEditorEntry.excludeRecursion"
                                        class="accent-pink-500">
                                    <span>‰∏çÂèØÈÄíÂΩí (Exclude Recursion)</span>
                                </label>

                                <label
                                    class="flex items-center gap-2 cursor-pointer p-1 hover:bg-[var(--bg-hover)] rounded">
                                    <input type="checkbox" x-model="activeEditorEntry.preventRecursion"
                                        class="accent-pink-500">
                                    <span>ÈòªÊ≠¢ÂêéÁª≠ÈÄíÂΩí (Prevent Recursion)</span>
                                </label>

                                <label
                                    class="flex items-center gap-2 cursor-pointer p-1 hover:bg-[var(--bg-hover)] rounded">
                                    <input type="checkbox" x-model="activeEditorEntry.ignoreBudget"
                                        class="accent-red-500">
                                    <span class="text-red-400">Êó†ËßÜÈôêÈ¢ù (Ignore Budget)</span>
                                </label>

                                <div
                                    class="flex items-center justify-between mt-1 pt-1 border-t border-[var(--border-light)]">
                                    <span class="text-gray-500">Âª∂ËøüÈÄíÂΩíÁ≠âÁ∫ß</span>
                                    <input type="number" x-model.number="activeEditorEntry.delayUntilRecursion"
                                        placeholder="0"
                                        class="w-12 bg-[var(--bg-body)] border border-[var(--border-light)] rounded px-1 text-center">
                                </div>
                            </div>
                        </div>

                        <!-- 4. ÈÄªËæë‰∏éËøáÊª§ -->
                        <div class="props-group" x-data="{ expanded: false }">
                            <div class="props-header cursor-pointer hover:bg-[var(--bg-hover)]"
                                @click="expanded = !expanded">
                                <span class="text-purple-400">È´òÁ∫ßÈÄªËæë (Logic)</span>
                                <span x-text="expanded ? '‚ñº' : '‚ñ∂'" class="text-[10px]"></span>
                            </div>
                            <div class="props-body space-y-3" x-show="expanded">
                                <div class="flex items-center justify-between gap-2">
                                    <span class="text-xs text-gray-500 whitespace-nowrap flex-shrink-0">ÈÄªËæëÊ®°Âºè
                                        (Logic)</span>
                                    <select x-model.number="activeEditorEntry.selectiveLogic"
                                        class="bg-[var(--bg-body)] border border-[var(--border-light)] rounded px-2 py-1.5 text-xs flex-1 min-w-0 hover:border-accent-main transition-colors cursor-pointer"
                                        :disabled="!activeEditorEntry.selective">
                                        <option value="0">0 - ‰ªªÊÑèÂåπÈÖç (Any/OR)</option>
                                        <option value="1">1 - ÂÖ®ÈÉ®ÂåπÈÖç (All/AND)</option>
                                        <option value="2">2 - ÂÖ®‰∏çÂåπÈÖç (Not Any/NOR)</option>
                                        <option value="3">3 - ÈùûÂÖ®ÈÉ® (Not All/NAND)</option>
                                    </select>
                                </div>

                                <div class="grid grid-cols-1 gap-1 pt-2 border-t border-[var(--border-light)]">
                                    <label
                                        class="flex items-center justify-between cursor-pointer p-1.5 hover:bg-[var(--bg-hover)] rounded group transition-colors">
                                        <span class="text-xs text-gray-400 group-hover:text-gray-200">ÂÖ®ËØçÂåπÈÖç (Whole
                                            Words)</span>
                                        <input type="checkbox" x-model="activeEditorEntry.matchWholeWords"
                                            class="accent-purple-500 scale-90">
                                    </label>
                                    <label
                                        class="flex items-center justify-between cursor-pointer p-1.5 hover:bg-[var(--bg-hover)] rounded group transition-colors">
                                        <span class="text-xs text-gray-400 group-hover:text-gray-200">Âå∫ÂàÜÂ§ßÂ∞èÂÜô (Case
                                            Sensitive)</span>
                                        <input type="checkbox" x-model="activeEditorEntry.caseSensitive"
                                            class="accent-purple-500 scale-90">
                                    </label>
                                    <label
                                        class="flex items-center justify-between cursor-pointer p-1.5 hover:bg-[var(--bg-hover)] rounded group transition-colors">
                                        <span class="text-xs text-gray-400 group-hover:text-gray-200">Ê≠£ÂàôÊ®°Âºè
                                            (Regex)</span>
                                        <input type="checkbox" x-model="activeEditorEntry.use_regex"
                                            class="accent-purple-500 scale-90">
                                    </label>
                                </div>

                                <div class="pt-2 mt-2 border-t border-[var(--border-light)]">
                                    <div class="flex items-center justify-between">
                                        <div class="flex flex-col">
                                            <span class="text-xs text-gray-500">Ëß¶ÂèëÊ¶ÇÁéá (Probability)</span>
                                            <span class="text-[9px] text-gray-600"
                                                x-text="activeEditorEntry.useProbability ? '‚úÖ Â∑≤ÂêØÁî®' : 'üö´ ‰∏çÁîüÊïà'"></span>
                                        </div>

                                        <div class="flex items-center gap-2">
                                            <!-- Ê¶ÇÁéáÊï∞ÂÄºËæìÂÖ• -->
                                            <div class="relative flex items-center">
                                                <input type="number" x-model.number="activeEditorEntry.probability"
                                                    min="0" max="100" :disabled="!activeEditorEntry.useProbability"
                                                    class="w-12 bg-[var(--bg-body)] border border-[var(--border-light)] rounded px-1 py-1 text-center text-xs focus:border-accent-main outline-none"
                                                    :class="{'opacity-50': !activeEditorEntry.useProbability}">
                                                <span class="ml-1 text-[10px] text-gray-500">%</span>
                                            </div>

                                            <!-- ÂêØÁî®ÂºÄÂÖ≥ -->
                                            <label
                                                class="cursor-pointer flex items-center justify-center w-6 h-6 hover:bg-[var(--bg-hover)] rounded transition-colors"
                                                title="ÂêØÁî®/Á¶ÅÁî®Ê¶ÇÁéá">
                                                <input type="checkbox" x-model="activeEditorEntry.useProbability"
                                                    class="accent-accent-main cursor-pointer w-4 h-4">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </template>

                <div x-show="rightTab==='settings' && !activeEditorEntry" class="p-6 text-center text-gray-500 text-xs">
                    Ê≤°ÊúâÈÄâ‰∏≠ÁöÑÊù°ÁõÆ
                </div>

                <!-- Tab 2: Clipboard -->
                <div x-show="rightTab==='clipboard'" class="flex-1 flex flex-col h-full overflow-hidden">
                    <div
                        class="p-2 border-b border-[var(--border-light)] flex justify-between items-center bg-[var(--bg-panel)]">
                        <span class="text-xs font-bold text-gray-500">Global Items</span>
                        <button @click="typeof clearWiClipboard === 'function' && clearWiClipboard()"
                            class="text-[10px] text-red-400 hover:underline">Ê∏ÖÁ©∫</button>
                    </div>

                    <div x-show="typeof wiClipboardOverwriteMode !== 'undefined' && wiClipboardOverwriteMode"
                        class="bg-yellow-500/10 border-b border-yellow-500/30 p-2 text-center" x-transition>
                        <p class="text-[10px] text-yellow-500 font-bold mb-1">‚ö†Ô∏è Ââ™ÂàáÊùøÂ∑≤Êª°</p>
                        <p class="text-[10px] opacity-70 mb-1">ÁÇπÂáª‰∏ãÊñπÊù°ÁõÆ‰ª•Ë¶ÜÁõñ‰øùÂ≠ò</p>
                        <button @click="wiClipboardOverwriteMode=false"
                            class="text-[10px] underline hover:text-white">ÂèñÊ∂à</button>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2" @dragover.prevent
                        @drop.prevent="typeof handleClipboardDropReorder === 'function' && handleClipboardDropReorder($event)">

                        <template
                            x-for="(item, idx) in (typeof wiClipboardItems !== 'undefined' ? wiClipboardItems : [])"
                            :key="item.db_id || idx">
                            <div class="clipboard-item group relative flex flex-col gap-1 p-2 rounded border transition-all cursor-pointer select-none"
                                :class="(isEditingClipboard && currentClipboardIndex === idx) 
                                        ? 'border-purple-500 bg-purple-500/10 shadow-[0_0_10px_rgba(168,85,247,0.2)]' 
                                        : 'border-[var(--border-light)] bg-[var(--bg-panel)] hover:border-blue-400'"
                                draggable="true" @click="selectClipboardItem(idx)"
                                @dragstart="typeof clipboardDragStart === 'function' && clipboardDragStart($event, item, idx)"
                                @drop.stop="typeof clipboardDropInside === 'function' && clipboardDropInside($event, idx)">

                                <div class="flex justify-between items-center">
                                    <!-- Ê†áÈ¢òÈ¢úËâ≤‰πüË∑üÈöèÁä∂ÊÄÅÊîπÂèò -->
                                    <span class="font-bold text-xs truncate"
                                        :class="(isEditingClipboard && currentClipboardIndex === idx) ? 'text-purple-400' : 'text-blue-400'"
                                        x-text="item.content.comment || 'Untitled'"></span>

                                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <!-- ‰øùÊåÅÂéüÊúâÁöÑÊåâÈíÆ‰∏çÂèò -->
                                        <button @click.stop="addWiEntryFromClipboard(item.content)"
                                            class="text-green-500 hover:bg-green-500/10 p-1 rounded"
                                            title="Ê∑ªÂä†">‚ûï</button>
                                        <button @click.stop="deleteWiClipboardItem(item.db_id)"
                                            class="text-red-500 hover:bg-red-500/10 p-1 rounded" title="Âà†Èô§">‚úï</button>
                                    </div>
                                </div>

                                <!-- Â¢ûÂä†‰∏Ä‰∏™ÁºñËæë‰∏≠Ê†áËÆ∞Êù° -->
                                <div x-show="isEditingClipboard && currentClipboardIndex === idx"
                                    class="absolute left-0 top-0 bottom-0 w-1 bg-purple-500 rounded-l"></div>

                                <div class="text-[10px] text-gray-500 truncate font-mono">
                                    <span
                                        x-text="typeof formatWiKeys === 'function' ? formatWiKeys(item.content.keys) : item.content.keys"></span>
                                </div>
                            </div>
                        </template>

                        <div x-show="typeof wiClipboardItems !== 'undefined' && wiClipboardItems.length === 0"
                            class="text-center py-8 text-gray-500 text-xs">
                            Ââ™ÂàáÊùø‰∏∫Á©∫
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="!showRightPanel" class="wi-toggle-btn-float right" @click="showRightPanel = true" title="Â±ïÂºÄÈù¢Êùø">
                ‚óÄ</div>

            <!-- Êù°ÁõÆÂéÜÂè≤ÂõûÊªöÂºπÁ™ó -->
            <div x-show="showEntryHistoryModal" x-cloak class="fixed inset-0 z-[9999] bg-black/60 flex items-center justify-center p-4"
                @click.self="showEntryHistoryModal = false">
                <div class="w-full max-w-7xl h-[82vh] rounded-xl border border-[var(--border-main)] bg-[var(--bg-panel)] shadow-2xl flex flex-col overflow-hidden">
                    <div class="px-4 py-3 border-b border-[var(--border-light)] flex items-center justify-between">
                        <div>
                            <div class="text-sm font-bold text-[var(--text-main)]">Êù°ÁõÆÊó∂ÂÖâÊú∫</div>
                            <div class="text-[11px] text-[var(--text-dim)]">Â∑¶‰æßÈÄâÊã©ÁâàÊú¨ÔºåÂè≥‰æßÊü•ÁúãË°åÁ∫ßÂ∑ÆÂºÇÔºàÁªø=Êñ∞Â¢û / ÈªÑ=‰øÆÊîπ / Á∫¢=Âà†Èô§Ôºâ</div>
                        </div>
                        <button @click="showEntryHistoryModal = false"
                            class="text-gray-400 hover:text-red-400 px-2 py-1 rounded">‚úï</button>
                    </div>

                    <div class="flex-1 min-h-0 flex overflow-hidden">
                        <div class="w-[290px] border-r border-[var(--border-light)] bg-[var(--bg-sub)] flex flex-col">
                            <div class="px-3 py-2 border-b border-[var(--border-light)] text-[11px] text-[var(--text-dim)]">
                                ÁâàÊú¨ÂàóË°®ÔºàÂèØÂàÜÂà´ÊåáÂÆö Left / RightÔºâ
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2">
                                <div x-show="isEntryHistoryLoading" class="text-center text-xs text-gray-400 py-8">
                                    Ê≠£Âú®Âä†ËΩΩÂéÜÂè≤ÁâàÊú¨...
                                </div>

                                <template x-for="ver in entryHistoryVersions" :key="ver.id || ('v-' + ver.created_at)">
                                    <div class="border rounded-lg p-2 bg-[var(--bg-panel)] border-[var(--border-light)]">
                                        <div class="flex items-center justify-between gap-2">
                                            <div class="min-w-0">
                                                <div class="text-xs font-bold"
                                                    :class="ver.is_current ? 'text-green-400' : 'text-orange-400'"
                                                    x-text="ver.is_current ? 'ÂΩìÂâçÁâàÊú¨ (Current)' : formatEntryHistoryTime(ver.created_at)"></div>
                                                <div class="text-[11px] text-[var(--text-dim)] truncate"
                                                    x-text="(ver.snapshot && ver.snapshot.comment) ? ver.snapshot.comment : 'Êó†Â§áÊ≥®'"></div>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <button @click="setEntryHistorySide('left', ver)"
                                                    class="px-2 py-0.5 rounded text-[10px] border"
                                                    :class="entryHistorySelection.left === ver ? 'bg-red-500/80 text-white border-red-400' : 'border-[var(--border-light)] text-[var(--text-dim)] hover:text-red-300'">
                                                    L
                                                </button>
                                                <button @click="setEntryHistorySide('right', ver)"
                                                    class="px-2 py-0.5 rounded text-[10px] border"
                                                    :class="entryHistorySelection.right === ver ? 'bg-green-500/80 text-white border-green-400' : 'border-[var(--border-light)] text-[var(--text-dim)] hover:text-green-300'">
                                                    R
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <div x-show="!isEntryHistoryLoading && entryHistoryVersions.length <= 1"
                                    class="text-center text-xs text-gray-500 py-8">
                                    ËØ•Êù°ÁõÆÊöÇÊó†ÂéÜÂè≤ÁâàÊú¨Ôºà‰ªÖÂΩìÂâçÁâàÊú¨Ôºâ
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 min-w-0 flex flex-col">
                            <div class="px-3 py-2 border-b border-[var(--border-light)] flex items-center justify-between gap-3">
                                <div class="text-[11px] text-[var(--text-dim)] truncate">
                                    Left:
                                    <span class="text-red-300"
                                        x-text="entryHistorySelection.left ? (entryHistorySelection.left.is_current ? 'Current' : formatEntryHistoryTime(entryHistorySelection.left.created_at)) : '-'"></span>
                                    <span class="mx-2">vs</span>
                                    Right:
                                    <span class="text-green-300"
                                        x-text="entryHistorySelection.right ? (entryHistorySelection.right.is_current ? 'Current' : formatEntryHistoryTime(entryHistorySelection.right.created_at)) : '-'"></span>
                                </div>
                                <button @click="restoreEntryFromSelectedHistory()"
                                    class="btn-primary px-3 py-1 text-xs rounded whitespace-nowrap"
                                    :disabled="!canRestoreEntryFromSelection()">
                                    ÊÅ¢Â§çÂà∞ Left ÁâàÊú¨
                                </button>
                            </div>

                            <div class="flex-1 min-h-0 grid grid-cols-2 gap-0">
                                <div class="min-h-0 border-r border-[var(--border-light)]">
                                    <div class="px-3 py-2 text-xs font-bold text-red-300 border-b border-[var(--border-light)]">Left (Old)</div>
                                    <div class="h-[calc(82vh-140px)] overflow-y-auto custom-scrollbar" x-html="entryHistoryDiff.left"></div>
                                </div>
                                <div class="min-h-0">
                                    <div class="px-3 py-2 text-xs font-bold text-green-300 border-b border-[var(--border-light)]">Right (New)</div>
                                    <div class="h-[calc(82vh-140px)] overflow-y-auto custom-scrollbar" x-html="entryHistoryDiff.right"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
