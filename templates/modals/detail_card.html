<!-- ËØ¶ÊÉÖÈ°µÊ®°ÊÄÅÊ°Ü (Refactored) -->
<div x-show="showDetail" x-data="detailModal" x-cloak class="modal-overlay z-modal-std" @click.self="showDetail=false">

    <div class="detail-modal" @click.stop>
        <!-- Â∑¶‰æßÂ§ñÊÇ¨ÊµÆÔºöSKINSÔºà‰∏çÈÅÆÊå°ÂõæÁâáÔºâ -->
        <div class="detail-filmstrip-outside custom-scrollbar"
            x-show="showDetail && !isCardFlipped && skinImages.length > 0"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-x-4"
            x-transition:enter-end="opacity-100 translate-x-0">
            <div class="detail-filmstrip-title">SKINS</div>

            <!-- ‰∏ªÂõæ -->
            <button type="button" @click="currentSkinIndex=-1" class="detail-thumb"
                :class="currentSkinIndex === -1 ? 'active-main' : ''">
                <img :src="activeCard.image_url" alt="Main">
                <span class="detail-thumb-label">Main</span>
            </button>

            <!-- ÁöÆËÇ§ÂàóË°® -->
            <template x-for="(skin, idx) in skinImages" :key="skin">
                <button type="button" @click="currentSkinIndex=idx" class="detail-thumb"
                    :class="currentSkinIndex === idx ? 'active-skin' : ''" :title="skin">
                    <!-- ‰ΩøÁî® getSkinUrl ÂáΩÊï∞ÔºåÂπ∂Ê∑ªÂä† x-show Á°Æ‰øù URL ÊúâÊïàÊâçÊ∏≤Êüì -->
                    <img :src="getSkinUrl(skin)" x-show="getSkinUrl(skin)" loading="lazy" alt="Skin"
                        onerror="this.style.display='none'">
                    <span class="detail-thumb-label" x-text="skin.length > 10 ? '...'+skin.slice(-8) : skin"></span>
                </button>
            </template>
        </div>

        <div class="detail-modal-inner">
            <!-- Â∑¶‰æßÔºöÂõæÁâá / ÂÖÉÊï∞ÊçÆ / Áº©Êîæ / ÁâàÊú¨Êù° -->
            <section class="detail-left" x-data="{
                        isPanning: false,
                        startX: 0,
                        startY: 0,
                        scrollLeft: 0,
                        scrollTop: 0
                    }" @mouseleave="isPanning=false">

                <!-- ÂõæÁâáËßÜÂè£ -->
                <div class="detail-image-area">

                    <!-- ÂõæÁâáÊªöÂä®ÂÆπÂô® -->
                    <div x-show="!isCardFlipped" class="detail-image-scroll custom-scrollbar" x-ref="imgWrapper"
                        @wheel.prevent="handleWheelZoom($event)" @mousedown="isPanning = true;
                                startX = $event.pageX - $refs.imgWrapper.offsetLeft;
                                startY = $event.pageY - $refs.imgWrapper.offsetTop;
                                scrollLeft = $refs.imgWrapper.scrollLeft;
                                scrollTop = $refs.imgWrapper.scrollTop" @mousemove="if(isPanning) {
                                $refs.imgWrapper.scrollLeft = scrollLeft - ($event.pageX - $refs.imgWrapper.offsetLeft - startX);
                                $refs.imgWrapper.scrollTop = scrollTop - ($event.pageY - $refs.imgWrapper.offsetTop - startY);
                            }" @mouseup="isPanning=false" @dragstart.prevent>

                        <img :src="displayImageUrl"
                            :style="'width: ' + zoomLevel + '%; min-width: ' + zoomLevel + '%; max-width: none;'"
                            class="detail-image" draggable="false"
                            onerror="this.onerror=null; this.src='/static/images/default_card.png';" alt="Card Image">
                    </div>

                    <!-- ÂÖÉÊï∞ÊçÆÈù¢Êùø -->
                    <div x-show="isCardFlipped" class="detail-metadata">
                        <div class="detail-metadata-header">
                            <div class="flex items-center gap-2">
                                <span class="text-accent font-bold">üì¶ METADATA</span>
                                <span class="text-xs" style="color: var(--text-dim);">Âè™ËØªÈ¢ÑËßà</span>
                            </div>
                            <button @click="isCardFlipped=false" class="btn-secondary"
                                style="padding:0.25rem 0.75rem; font-size:0.75rem;">
                                ‚Ü© ËøîÂõûÂõæÁâá
                            </button>
                        </div>
                        <pre class="detail-metadata-body custom-scrollbar" x-text="rawMetadataContent"></pre>
                    </div>

                    <!-- Â∑¶‰æßÂ∑•ÂÖ∑Êù°ÔºàÊÇ¨ÊµÆÔºâ -->
                    <div class="detail-left-toolbar">
                        <button x-show="!isCardFlipped" @click.stop="flipCard()" class="btn-secondary detail-icon-btn"
                            title="Êü•ÁúãÂÖÉÊï∞ÊçÆ">
                            ‚ÑπÔ∏è
                        </button>

                        <button x-show="!isCardFlipped" @click.stop="triggerImageUpload()"
                            class="btn-secondary detail-icon-btn" title="Êõ¥Êç¢ÂõæÁâá">
                            üì∑
                        </button>
                    </div>

                    <!-- Áº©ÊîæÊù°ÔºàÂ∫ïÈÉ®ÊÇ¨ÊµÆÔºâ -->
                    <div x-show="!isCardFlipped" class="detail-zoombar">
                        <button @click.stop="modifyZoom(-20)" class="detail-zoom-btn">‚àí</button>

                        <input type="range" min="20" max="500" step="10" x-model.number="zoomLevel"
                            class="detail-zoom-range" @click.stop>

                        <button @click.stop="modifyZoom(20)" class="detail-zoom-btn">+</button>

                        <span class="detail-zoom-text" x-text="zoomLevel + '%'"></span>

                        <button @click.stop="zoomLevel=100" class="detail-zoom-reset" title="ÈáçÁΩÆ">
                            ‚Ü∫
                        </button>
                    </div>

                </div>

                <!-- ÁâàÊú¨Êù°ÔºöBundle Ê®°Âºè -->
                <div x-show="!isCardFlipped && activeCard.is_bundle" @wheel.prevent="$el.scrollLeft += $event.deltaY"
                    class="detail-versions custom-scrollbar flex items-center px-4 overflow-x-auto bg-black/20 border-t border-white/10">

                    <div class="detail-versions-title mr-2">VERSIONS</div>

                    <template x-for="ver in activeCard.versions" :key="ver.id">
                        <div class="detail-version-thumb-btn group relative"
                            :class="editingData.id === ver.id ? 'active' : ''" @click="switchVersion(ver.id)">

                            <!-- Áº©Áï•Âõæ -->
                            <img :src="'/api/thumbnail/' + encodeURIComponent(ver.id)" class="detail-version-img"
                                loading="lazy" onerror="this.src='/static/images/default_card.png'">

                            <!-- ËÆæ‰∏∫Â∞ÅÈù¢ÊåâÈíÆ (‰ªÖÂú®ÈùûÂΩìÂâçÈ¶ñÂõæÊó∂ÊòæÁ§∫ÔºåÊàñËÄÖ‰∏ÄÁõ¥ÊòæÁ§∫‰æõË∞ÉÊï¥) -->
                            <button @click.stop="setAsBundleCover(ver.id)" class="detail-version-set-cover"
                                title="ËÆæ‰∏∫ÊúÄÊñ∞/Â∞ÅÈù¢ (Êõ¥Êñ∞Êó∂Èó¥)">
                                ‚òÖ
                            </button>

                            <!-- Êñá‰ª∂ÂêçË¶ÜÁõñÂ±Ç -->
                            <div class="detail-version-overlay" x-text="getVersionName(ver.filename)"></div>
                        </div>
                    </template>
                </div>

                <!-- ÈöêËóèÁöÑ Input -->
                <input type="file" x-ref="imageInput" @change="handleImageUpload" accept="image/*"
                    style="display:none;">
            </section>

            <!-- Âè≥‰æßÔºö‰ø°ÊÅØ + Tab -->
            <section class="detail-right">

                <!-- È°∂ÈÉ®Ê†èÔºöÊ†áÈ¢ò / token / Âø´Êç∑Êìç‰Ωú -->
                <header class="detail-topbar">
                    <!-- ÂÖ≥Èó≠ÊåâÈíÆÊîπ‰∏∫ÁúüÊ≠£Âè≥‰∏äËßí -->
                    <button @click="showDetail=false" class="btn-secondary detail-close-floating" title="ÂÖ≥Èó≠">‚úï</button>

                    <div class="detail-title-block">
                        <div class="detail-title-row">
                            <div class="detail-title-label">ËßíËâ≤ÂêçÁß∞</div>

                            <!-- ÂêçÁß∞ -->
                            <div class="detail-title-inline">
                                <input type="text" x-model="editingData.char_name" class="detail-title-input">
                            </div>
                        </div>

                        <div class="detail-subrow">
                            <span class="detail-link-icon">üîó</span>
                            <input type="text" x-model="editingData.source_link" placeholder="Êù•Ê∫êÈìæÊé• (http://...)"
                                class="detail-link-input">
                            <a x-show="editingData.source_link" :href="editingData.source_link" target="_blank"
                                class="detail-open-link" title="ÊâìÂºÄÈìæÊé•">‚Üó ÊâìÂºÄ</a>
                        </div>
                    </div>

                    <!-- Token ÊòæÁ§∫ (ÊîæÂú®‰∏≠Èó¥ÂÅèÂè≥) -->
                    <div class="topbar-token" title="È¢Ñ‰º∞ TokenÔºàÂê´‰∏ñÁïå‰π¶Ôºâ">
                        <span class="topbar-token-label">Tokens</span>
                        <span class="topbar-token-value text-neon"
                            :class="totalTokenCount > 20000 ? 'danger' : (totalTokenCount > 5000 ? 'warn' : 'ok')"
                            x-text="totalTokenCount"></span>
                    </div>

                    <!-- ‰øÆÊîπÊó∂Èó¥ÊòæÁ§∫ -->
                    <div class="topbar-token border-r-0 pl-3 ml-2 border-l border-[var(--border-light)]" title="ÊúÄÂêé‰øÆÊîπÊó∂Èó¥">
                        <span class="topbar-token-label">Last Modified</span>
                        <span class="text-xs font-mono font-bold text-neon" style="color: var(--text-main);"
                            x-text="formatDate(activeCard.last_modified)"></span>
                    </div>

                    <div class="detail-top-actions">
                        <div class="detail-actions-row">
                            <button @click="createSnapshot('card')" @contextmenu.prevent="createKeySnapshot('card')"
                                class="btn-secondary detail-action-btn detail-snapshot-btn" title="Â∑¶ÈîÆ: Âø´ÁÖß | Âè≥ÈîÆ: ÂÖ≥ÈîÆÂø´ÁÖß">üì∏
                                Âø´ÁÖß</button>

                            <button @click="saveChanges()" :disabled="isSaving"
                                class="btn-primary detail-action-btn detail-save-btn">
                                <span x-text="isSaving ? '‰øùÂ≠ò‰∏≠...' : 'üíæ ‰øùÂ≠ò'"></span>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- ‰∫åÁ∫ßÔºöËµÑÊ∫êÁõÆÂΩïÊù°ÔºàÊõ¥Ê∏ÖÊô∞Ôºâ -->
                <div class="detail-resourcebar">
                    <div class="detail-resource-left">
                        <div class="detail-resource-title">üìÅ ËµÑÊ∫êÁõÆÂΩï</div>
                        <div class="detail-resource-path">
                            <template x-if="editingData.resource_folder">
                                <span class="detail-chip" x-text="editingData.resource_folder"></span>
                            </template>
                            <template x-if="!editingData.resource_folder">
                                <span class="detail-muted">Êú™ËÆæÁΩÆËµÑÊ∫êÁõÆÂΩï</span>
                            </template>
                        </div>
                    </div>

                    <div class="detail-resource-actions">
                        <button @click="openResourceFolder()" x-show="editingData.resource_folder"
                            class="btn-secondary detail-mini-btn" title="ÊµèËßàËµÑÊ∫êÁõÆÂΩï">
                            üîç ÊµèËßà
                        </button>
                        <button @click="createResourceFolder()" x-show="!editingData.resource_folder"
                            class="btn-secondary detail-mini-btn" title="ÂàõÂª∫ËµÑÊ∫êÁõÆÂΩï">
                            ‚ú® ÂàõÂª∫
                        </button>
                        <button @click="showSetResourceFolderModal=true" class="btn-secondary detail-mini-btn"
                            title="ËÆæÁΩÆËµÑÊ∫êÁõÆÂΩï">
                            ‚öôÔ∏è ËÆæÁΩÆ
                        </button>
                    </div>
                </div>

                <!-- Tab Ê†è -->
                <nav class="detail-tabs">
                    <button class="detail-tab" :class="tab==='basic' ? 'active' : ''" @click="tab='basic'">üìù
                        Âü∫Á°Ä</button>
                    <button x-show="hasPersonaFields" class="detail-tab" :class="tab==='persona' ? 'active' : ''" @click="tab='persona'">üß†
                        ËÆæÂÆö</button>
                    <button class="detail-tab" :class="tab==='dialog' ? 'active' : ''" @click="tab='dialog'">üí¨
                        ÂØπËØù</button>
                    <button class="detail-tab" :class="tab==='tags' ? 'active' : ''" @click="tab='tags'">üè∑Ô∏è
                        Ê†áÁ≠æ</button>
                    <button class="detail-tab" :class="tab==='wi' ? 'active' : ''" @click="tab='wi'">üåé ‰∏ñÁïå‰π¶</button>
                    <button class="detail-tab" :class="tab==='manage' ? 'active' : ''" @click="tab='manage'">üß∞
                        ÁÆ°ÁêÜ</button>
                </nav>

                <!-- ÂÜÖÂÆπÂå∫ÔºàÊªöÂä®Ôºâ -->
                <div class="detail-content custom-scrollbar">

                    <!-- TAB: Âü∫Á°Ä -->
                    <section x-show="tab==='basic'" x-transition.opacity class="detail-section detail-section-fill">
                        <div class="detail-tab-scroll custom-scrollbar">
                            <div class="detail-card">
                                <div class="detail-card-head">
                                    <div class="detail-card-title flex items-center gap-2"
                                        style="color: var(--accent-light);">
                                        <span class="note-label-icon">üìå</span>
                                        <span>Êú¨Âú∞Â§áÊ≥® (Local Note)</span>
                                    </div>
                                    <button class="expand-btn" @click="openLargeEditor('ui_summary','Êú¨Âú∞Â§áÊ≥®')">‚§¢</button>
                                </div>
                                <textarea x-model="editingData.ui_summary" class="form-textarea note-textarea"
                                    style="height: 10rem; resize:none;" placeholder="ËøôÊòØ‰ªÖÂ≠òÂÇ®Âú®Êú¨Âú∞ÁöÑÁßÅÊúâÂ§áÊ≥®Ôºå‰∏ç‰ºöÂÜôÂÖ•ËßíËâ≤Âç°Êñá‰ª∂...">
                                    </textarea>
                            </div>

                            <div class="detail-card">
                                <div class="detail-card-head">
                                    <div class="detail-card-title">ÂéüÁÆÄ‰ªã (Description)</div>
                                    <button class="expand-btn" @click="openLargeEditor('description','ÂéüÁÆÄ‰ªã')">‚§¢</button>
                                </div>
                                <textarea x-model="editingData.description" class="form-textarea"
                                    style="height: 10rem; resize:none;"></textarea>
                            </div>
                        </div>
                    </section>

                    <section x-show="tab==='persona'" x-transition.opacity class="detail-section detail-section-fill">
                        <div class="detail-tab-scroll custom-scrollbar">
                            
                            <!-- 1. ‰∫∫Ê†ºËÆæÂÆö (Personality) -->
                            <template x-if="editingData.personality">
                                <div class="detail-card" style="background: rgba(0,0,0,0.15); border-color: transparent;">
                                    <div class="detail-card-head py-1 min-h-[2rem]">
                                        <div class="detail-card-title text-xs text-gray-500 uppercase tracking-wider">‰∫∫Ê†ºËÆæÂÆö (Personality)</div>
                                        <button class="expand-btn scale-90 opacity-50 hover:opacity-100 transition-opacity" 
                                            @click="openLargeEditor('personality','‰∫∫Ê†ºËÆæÂÆö')">‚§¢</button>
                                    </div>
                                    <textarea readonly x-model="editingData.personality" 
                                        class="form-textarea text-xs bg-transparent text-[var(--text-dim)] focus:outline-none custom-scrollbar"
                                        style="height: 8rem; resize:none; border:none; box-shadow: none;"></textarea>
                                </div>
                            </template>

                            <!-- 2. Âú∫ÊôØËÆæÂÆö (Scenario) -->
                            <template x-if="editingData.scenario">
                                <div class="detail-card" style="background: rgba(0,0,0,0.15); border-color: transparent;">
                                    <div class="detail-card-head py-1 min-h-[2rem]">
                                        <div class="detail-card-title text-xs text-gray-500 uppercase tracking-wider">Âú∫ÊôØËÆæÂÆö (Scenario)</div>
                                        <button class="expand-btn scale-90 opacity-50 hover:opacity-100 transition-opacity" 
                                            @click="openLargeEditor('scenario','Âú∫ÊôØËÆæÂÆö')">‚§¢</button>
                                    </div>
                                    <textarea readonly x-model="editingData.scenario" 
                                        class="form-textarea text-xs bg-transparent text-[var(--text-dim)] focus:outline-none custom-scrollbar"
                                        style="height: 6rem; resize:none; border:none; box-shadow: none;"></textarea>
                                </div>
                            </template>

                            <!-- 3. ‰ΩúËÄÖÊ≥®Èáä (Creator Notes) -->
                            <template x-if="editingData.creator_notes">
                                <div class="detail-card" style="background: rgba(0,0,0,0.15); border-color: transparent;">
                                    <div class="detail-card-head py-1 min-h-[2rem]">
                                        <div class="detail-card-title text-xs text-gray-500 uppercase tracking-wider">‰ΩúËÄÖÊ≥®Èáä (Creator Notes)</div>
                                        <button class="expand-btn scale-90 opacity-50 hover:opacity-100 transition-opacity" 
                                            @click="openLargeEditor('creator_notes','‰ΩúËÄÖÊ≥®Èáä')">‚§¢</button>
                                    </div>
                                    <textarea readonly x-model="editingData.creator_notes" 
                                        class="form-textarea text-xs bg-transparent text-[var(--text-dim)] focus:outline-none custom-scrollbar"
                                        style="height: 6rem; resize:none; border:none; box-shadow: none;"></textarea>
                                </div>
                            </template>

                            <!-- 4. Á≥ªÁªüÊèêÁ§∫ËØç (System Prompt) -->
                            <template x-if="editingData.system_prompt">
                                <div class="detail-card" style="background: rgba(40, 20, 60, 0.15); border-color: transparent;">
                                    <div class="detail-card-head py-1 min-h-[2rem]">
                                        <div class="detail-card-title text-xs text-purple-400/70 uppercase tracking-wider">Á≥ªÁªüÊèêÁ§∫ËØç (System Prompt)</div>
                                        <button class="expand-btn scale-90 opacity-50 hover:opacity-100 transition-opacity" 
                                            @click="openLargeEditor('system_prompt','Á≥ªÁªüÊèêÁ§∫ËØç')">‚§¢</button>
                                    </div>
                                    <textarea readonly x-model="editingData.system_prompt" 
                                        class="form-textarea text-xs font-mono bg-transparent text-[var(--text-dim)] focus:outline-none custom-scrollbar"
                                        style="height: 6rem; resize:none; border:none; box-shadow: none;"></textarea>
                                </div>
                            </template>

                            <!-- 5. ÂéÜÂè≤Êåá‰ª§ (Post History) -->
                            <template x-if="editingData.post_history_instructions">
                                <div class="detail-card" style="background: rgba(40, 20, 60, 0.15); border-color: transparent;">
                                    <div class="detail-card-head py-1 min-h-[2rem]">
                                        <div class="detail-card-title text-xs text-purple-400/70 uppercase tracking-wider">ÂéÜÂè≤Êåá‰ª§ (Post History)</div>
                                        <button class="expand-btn scale-90 opacity-50 hover:opacity-100 transition-opacity" 
                                            @click="openLargeEditor('post_history_instructions','ÂéÜÂè≤Êåá‰ª§')">‚§¢</button>
                                    </div>
                                    <textarea readonly x-model="editingData.post_history_instructions" 
                                        class="form-textarea text-xs font-mono bg-transparent text-[var(--text-dim)] focus:outline-none custom-scrollbar"
                                        style="height: 6rem; resize:none; border:none; box-shadow: none;"></textarea>
                                </div>
                            </template>
                        </div>
                    </section>

                    <!-- TAB: ÂØπËØù -->
                    <section x-show="tab==='dialog'" x-transition.opacity class="detail-section detail-section-fill">
                        <div class="detail-tab-scroll custom-scrollbar">
                            <!-- First MessageÔºöÁºñËæë/È¢ÑËßà -->
                            <div class="detail-card detail-card--lg">
                                <div class="detail-card-head detail-card-head-row">
                                    <div class="detail-card-title">ÂºÄÂú∫ÁôΩ (First Message)</div>
                                    <div class="detail-card-actions">
                                        <button class="expand-btn"
                                            @click="openLargeEditor('first_mes','ÂºÄÂú∫ÁôΩ')">‚§¢</button>
                                        <div class="toggle-btn-group">
                                            <button class="toggle-btn" :class="!showFirstPreview ? 'active' : ''"
                                                @click="showFirstPreview=false">ÁºñËæë</button>
                                            <button class="toggle-btn" :class="showFirstPreview ? 'active' : ''"
                                                @click="showFirstPreview=true">HTMLÈ¢ÑËßà</button>
                                        </div>
                                    </div>
                                </div>

                                <textarea x-show="!showFirstPreview" x-model="editingData.first_mes"
                                    class="form-textarea" style="height: 10rem; resize:none;"></textarea>

                                <div x-show="showFirstPreview" class="form-textarea custom-scrollbar"
                                    style="height: 10rem; background: var(--bg-panel); border-color: var(--accent-main); padding: 0; overflow: auto;"
                                    x-effect="updateShadowContent($el, showFirstPreview ? editingData.first_mes : null)">
                                </div>
                            </div>

                            <!-- Mes Example -->
                            <div class="detail-card">
                                <div class="detail-card-head">
                                    <div class="detail-card-title">ÂØπËØùÁ§∫‰æã (Mes Example)</div>
                                    <button class="expand-btn" @click="openLargeEditor('mes_example','ÂØπËØùÁ§∫‰æã')">‚§¢</button>
                                </div>
                                <textarea x-model="editingData.mes_example" class="form-textarea"
                                    style="height: 10rem; resize:none; font-family: monospace; font-size: 0.85rem;"></textarea>
                            </div>

                            <!-- Alternate Greetings -->
                            <div class="detail-card detail-card--sm">
                                <div class="detail-card-head detail-card-head-row">
                                    <div class="detail-card-title">Â§áÁî®ÂºÄÂú∫ÁôΩ (Alternate Greetings)</div>

                                    <div class="detail-card-actions">
                                        <button class="expand-btn" x-show="editingData.alternate_greetings.length > 0"
                                            @click="openLargeEditor('alternate_greetings','Â§áÁî®ÂºÄÂú∫ÁôΩ #' + (altIdx+1), true, altIdx)">‚§¢</button>

                                        <div class="detail-alt-nav" x-show="editingData.alternate_greetings.length > 1">
                                            <button @click="prevAlt()" class="detail-alt-btn">‚Äπ</button>
                                            <span class="detail-alt-count"
                                                x-text="(altIdx+1) + '/' + editingData.alternate_greetings.length"></span>
                                            <button @click="nextAlt()" class="detail-alt-btn">‚Ä∫</button>
                                        </div>

                                        <button @click="removeAlt()" title="Âà†Èô§" class="btn-secondary detail-mini-btn"
                                            style="color:#f87171;">üóëÔ∏è</button>
                                        <button @click="addAlt()" title="Êñ∞Â¢û"
                                            class="btn-primary detail-mini-btn">Ôºã</button>
                                    </div>
                                </div>

                                <template x-if="editingData.alternate_greetings.length > 0">
                                    <textarea x-model="editingData.alternate_greetings[altIdx]" class="form-textarea"
                                        style="height: 8rem; resize:none;" placeholder="Âú®Ê≠§ËæìÂÖ•Â§áÁî®ÂºÄÂú∫ÁôΩ..."></textarea>
                                </template>
                            </div>
                        </div>
                    </section>

                    <!-- TAB: Ê†áÁ≠æ -->
                    <section x-show="tab==='tags'" x-transition.opacity class="detail-section custom-scrollbar">
                        <div class="detail-card">
                            <div class="detail-card-head detail-card-head-row">
                                <div class="detail-card-title">Ê†áÁ≠æ (Tags)</div>

                                <div class="detail-card-actions">
                                    <button @click="openTagPicker()" class="btn-secondary detail-mini-btn">
                                        üìö Ê†áÁ≠æÂ∫ì
                                    </button>

                                    <div class="detail-inline-input">
                                        <input type="text" x-model="newTagInput" @keydown.enter.prevent="addTag()"
                                            placeholder="Ëá™ÂÆö‰πâ..." class="detail-inline-text">
                                        <button @click="addTag()" class="detail-inline-add">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-taglist">
                                <template x-for="tag in editingData.tags" :key="tag">
                                    <button type="button" @click="toggleTag(tag)" class="detail-tag">
                                        <span x-text="tag"></span>
                                        <span class="detail-tag-x">‚úï</span>
                                    </button>
                                </template>

                                <div x-show="!editingData.tags || editingData.tags.length===0" class="detail-muted">
                                    ÊöÇÊó†Ê†áÁ≠æ...
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- TAB: ‰∏ñÁïå‰π¶Ôºà‰øùÁïôÂéüÊúâ WI ÂùóÂäüËÉΩÔºåÂè™ÂÅöÂÆπÂô®ÁæéÂåñ‰∏éÊî∂Á∫≥Ôºâ -->
                    <section x-show="tab==='wi'" x-transition.opacity class="detail-section detail-section-fill">
                        <div class="detail-tab-scroll custom-scrollbar">
                            <!-- Áõ¥Êé•Â§çÁî®Áé∞Êúâ WI ÂÆπÂô®‰∏éÂÜÖÈÉ®ÈÄªËæëÔºàÊú™Âà†‰ªª‰ΩïÊñπÊ≥ï/Â≠óÊÆµÔºâ -->
                            <div class="wi-container" x-data="{ wiOpen: true }">
                                <input type="file" x-ref="wiImportInput" style="display:none" accept=".json,.jsonl"
                                    @change="handleWiImport">

                                <div class="wi-header group" @click="wiOpen = !wiOpen">
                                    <div class="flex items-center gap-2 mr-3 pointer-events-none">
                                        <span class="text-lg shadow-sm">üåé</span>
                                        <div class="flex flex-col leading-none">
                                            <span
                                                class="text-orange-400 font-bold text-xs uppercase tracking-wider">World
                                                Info</span>
                                            <span class="text-[10px] text-gray-500 font-mono mt-0.5">
                                                <span x-text="getWorldInfoCount()">0</span> Êù°ÁõÆ
                                            </span>
                                        </div>
                                    </div>

                                    <div class="flex-1 min-w-0 mx-2 relative group/input h-full flex items-center"
                                        @click.stop>
                                        <div class="w-[1px] h-6 mr-3" style="background: var(--border-light);">
                                        </div>
                                        <input type="text" x-model="editingData.character_book.name"
                                            placeholder="Êú™ÂëΩÂêç‰∏ñÁïå‰π¶..."
                                            class="w-full bg-transparent text-sm font-medium outline-none border-b border-transparent transition-colors py-1"
                                            style="color: var(--text-main);" title="‰∏ñÁïå‰π¶ÂêçÁß∞">
                                    </div>

                                    <div class="flex items-center gap-2 pl-2">
                                        <div class="flex items-center gap-2" @click.stop>
                                            <div class="flex rounded-lg p-0.5 border"
                                                style="background: var(--bg-sub); border-color: var(--border-light);">
                                                <button @click="$refs.wiImportInput.click()" title="ÂØºÂÖ•"
                                                    class="px-2 py-1 text-[10px] text-gray-400 hover:text-green-400 rounded transition-colors flex items-center gap-1">üìÇ</button>
                                                <div class="w-[1px] my-0.5" style="background: var(--border-light);">
                                                </div>
                                                <button @click="exportWorldBookSingle()" title="ÂØºÂá∫"
                                                    class="px-2 py-1 text-[10px] text-gray-400 hover:text-blue-400 rounded transition-colors flex items-center gap-1">üíæ</button>
                                            </div>

                                            <button @click="openFullScreenWI()" title="ÂÖ®Â±èÁºñËæë" class="btn-primary"
                                                style="padding: 0.35rem 0.75rem; font-size: 0.75rem; border-radius: 0.375rem;">
                                                ‚§¢ ÂÖ®Â±è
                                            </button>
                                        </div>

                                        <div class="pl-2 ml-1 border-l h-6 flex items-center justify-center"
                                            style="border-color: var(--border-light);">
                                            <span
                                                class="text-xs text-gray-500 transform transition-transform duration-300"
                                                :class="wiOpen ? 'rotate-180 text-orange-400' : 'rotate-0 group-hover:text-gray-300'">
                                                ‚ñº
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div x-show="wiOpen" x-cloak class="wi-content custom-scrollbar">
                                    <!-- ‰ª•‰∏ã WI ÂÜÖÂÆπÔºö‰øùÊåÅÂéüÊù•ÁöÑÂäüËÉΩ -->
                                    <div class="flex justify-between items-center mb-3 px-1">
                                        <span class="text-xs text-gray-500">ÊèêÁ§∫: Ë∞ÉÊï¥ Order ÂèØÊîπÂèòËß¶ÂèëÈ°∫Â∫è</span>
                                        <button @click="addWiEntry()"
                                            class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded flex items-center gap-1 transition">
                                            ‚ûï Êñ∞Â¢ûÊù°ÁõÆ
                                        </button>
                                    </div>

                                    <div class="flex flex-col gap-2">
                                        <template x-for="(entry, index) in getWIArrayRef()" :key="index">
                                            <div x-data="{ expanded: false }"
                                                class="border rounded-md overflow-hidden transition-all"
                                                style="background: var(--bg-panel); border-color: var(--border-light);">
                                                <div class="flex items-center gap-2 p-2 cursor-pointer select-none"
                                                    style="background: var(--bg-sub);" @click="expanded = !expanded">
                                                    <div @click.stop class="flex items-center">
                                                        <input type="checkbox" x-model="entry.enabled"
                                                            class="cursor-pointer w-4 h-4 rounded">
                                                    </div>

                                                    <div class="flex-1 min-w-0 flex flex-col">
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-xs font-bold"
                                                                style="color: var(--text-main);"
                                                                x-text="entry.comment || 'Êó†Â§áÊ≥®'"></span>
                                                            <span x-show="entry.constant"
                                                                class="text-[10px] px-1 rounded border"
                                                                style="background: var(--bg-tag); color: var(--accent-light); border-color: var(--accent-light);">Constant</span>
                                                        </div>
                                                        <div class="text-[10px] font-mono mt-0.5 break-all whitespace-normal"
                                                            style="color: var(--text-dim); line-height: 1.2;">
                                                            <span class="opacity-70">Keys:</span>
                                                            <span x-text="formatWiKeys(entry.keys)"
                                                                style="color: #ca8a04;"></span>
                                                        </div>
                                                    </div>

                                                    <div class="flex items-center gap-1" @click.stop>
                                                        <div class="flex flex-col mr-2">
                                                            <button @click="moveWiEntry(index, -1)"
                                                                class="text-[10px] text-gray-500 hover:text-white leading-none mb-1">‚ñ≤</button>
                                                            <button @click="moveWiEntry(index, 1)"
                                                                class="text-[10px] text-gray-500 hover:text-white leading-none">‚ñº</button>
                                                        </div>
                                                        <button @click="removeWiEntry(index)"
                                                            class="text-gray-500 hover:text-red-400 p-1 rounded transition">üóëÔ∏è</button>
                                                        <button @click="expanded = !expanded"
                                                            class="text-gray-500 hover:text-blue-400 p-1 transform transition-transform duration-200"
                                                            :class="expanded ? 'rotate-180' : ''">‚ñº</button>
                                                    </div>
                                                </div>

                                                <div x-show="expanded" x-collapse class="p-3 border-t space-y-3"
                                                    style="border-color: var(--border-light); background: var(--bg-panel);">

                                                    <div class="grid grid-cols-6 gap-3">
                                                        <div class="col-span-4">
                                                            <label
                                                                class="block text-[10px] text-purple-400 uppercase font-bold mb-1">Ëß¶ÂèëÂÖ≥ÈîÆÂ≠ó</label>
                                                            <input type="text" :value="formatWiKeys(entry.keys)"
                                                                @input="updateWiKeys(entry, $event.target.value)"
                                                                class="form-input text-xs" style="color: #fde047;"
                                                                placeholder="ËâæÈõÖ, Python">
                                                        </div>
                                                        <div class="col-span-2">
                                                            <label
                                                                class="block text-[10px] text-gray-500 uppercase font-bold mb-1">ÊùÉÈáç
                                                                (Order)</label>
                                                            <input type="number" x-model.number="entry.insertion_order"
                                                                class="form-input text-xs">
                                                        </div>
                                                    </div>

                                                    <div>
                                                        <div class="flex justify-between items-center mb-1">
                                                            <label
                                                                class="text-[10px] text-green-400 uppercase font-bold">ÂÜÖÂÆπ
                                                                (Content)</label>
                                                            <div class="text-[10px] text-gray-600">Token: <span
                                                                    x-text="estimateTokens(entry.content)"></span>
                                                            </div>
                                                        </div>
                                                        <textarea x-model="entry.content" rows="4"
                                                            class="form-textarea text-xs font-mono custom-scrollbar break-all"
                                                            placeholder="ÂÜÖÂÆπ..." style="word-break: break-all;">
                                                            </textarea>
                                                    </div>

                                                    <div class="flex items-center gap-4">
                                                        <div class="flex-1">
                                                            <label
                                                                class="block text-[10px] text-gray-500 uppercase font-bold mb-1">Â§áÊ≥®</label>
                                                            <input type="text" x-model="entry.comment"
                                                                class="form-input text-xs" placeholder="‰ªÖ‰ΩúÊ†áËÆ∞">
                                                        </div>
                                                        <div class="flex items-center pt-4">
                                                            <label class="flex items-center gap-2 cursor-pointer">
                                                                <input type="checkbox" x-model="entry.constant"
                                                                    class="rounded w-4 h-4">
                                                                <span class="text-xs text-accent">Constant
                                                                    (Â∏∏È©ª)</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>

                                        <div x-show="getWIArrayRef().length === 0"
                                            class="text-center py-8 text-gray-600 border border-dashed border-gray-700 rounded-lg">
                                            <p class="text-sm">ÊöÇÊó†‰∏ñÁïå‰π¶Êù°ÁõÆ</p>
                                            <button @click="addWiEntry()"
                                                class="mt-2 text-xs text-blue-400 hover:underline">ÁÇπÂáªÊ∑ªÂä†Á¨¨‰∏ÄÊù°</button>
                                        </div>
                                    </div>

                                    <div class="wi-raw-section" x-data="{ showRaw: false }">
                                        <button
                                            @click="showRaw = !showRaw; if(showRaw) editingData.character_book_raw = JSON.stringify(editingData.character_book, null, 2)"
                                            class="text-[10px] underline flex items-center gap-1 transition-colors"
                                            style="color: var(--text-dim);">
                                            ‚öôÔ∏è <span x-text="showRaw ? 'ÈöêËóèÂéüÂßãÊï∞ÊçÆ' : 'Êü•Áúã/ÁºñËæëÂéüÂßã JSON (Advanced)'"></span>
                                        </button>
                                        <div x-show="showRaw" class="mt-2">
                                            <textarea x-model="editingData.character_book_raw"
                                                class="wi-raw-textarea w-full h-40 custom-scrollbar"></textarea>
                                            <button @click="if(applyCharacterBookJson()) showRaw=false"
                                                class="btn-danger-xs">‚ö† Â∫îÁî® JSON Ë¶ÜÁõñÂΩìÂâçË°®Ê†º</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- TAB: ÁÆ°ÁêÜ -->
                    <section x-show="tab==='manage'" x-transition.opacity class="detail-section custom-scrollbar">
                        <div class="detail-card">
                            <div class="detail-card-head">
                                <div class="detail-card-title">Â∑•ÂÖ∑ÁÆ±</div>
                            </div>

                            <div class="detail-toolbox">
                                <div class="toolbox-group">
                                    <div class="toolbox-title">üìå ÂÆö‰Ωç‰∏éÊñá‰ª∂</div>
                                    <div class="toolbox-grid">
                                        <button @click="locateCard()" class="toolbox-btn">üéØ Ë∑≥ËΩ¨ÂÆö‰Ωç</button>
                                        <button @click="openCardLocation()" class="toolbox-btn">üìÇ ÊâìÂºÄÊâÄÂú®Êñá‰ª∂Â§π</button>
                                    </div>
                                </div>

                                <div class="toolbox-group">
                                    <div class="toolbox-title">üï∞Ô∏è Â§á‰ªΩ‰∏éÂõûÊªö</div>
                                    <div class="toolbox-grid">
                                        <button @click="openRollback('card')" class="toolbox-btn warn">‚è™
                                            Êó∂ÂÖâÊú∫</button>
                                        <button @click="openBackupFolder('card')" class="toolbox-btn">üóÉÔ∏è
                                            ÊâìÂºÄÂ§á‰ªΩÁõÆÂΩï</button>
                                        <!-- <button @click="createSnapshot('card')"
                                                @contextmenu.prevent="createKeySnapshot('card')"
                                                class="toolbox-btn amber">üì∏ Âø´ÁÖß</button> -->
                                    </div>
                                </div>

                                <div class="toolbox-group">
                                    <div class="toolbox-title">üõ†Ô∏è È´òÁ∫ß</div>
                                    <div class="toolbox-grid">
                                        <button @click="openAdvancedEditor()" class="toolbox-btn purple">üõ†Ô∏è
                                            È´òÁ∫ßÊâ©Â±ï</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-card-head">
                                <div class="detail-card-title">
                                    <!-- Âå∫ÂàÜÊòæÁ§∫ -->
                                    <span x-show="!activeCard.is_bundle">Êñá‰ª∂Âêç</span>
                                    <span x-show="activeCard.is_bundle">
                                        <span style="color:#fbbf24;">ËßíËâ≤ÂåÖ (Êñá‰ª∂Â§π)</span> / ÂΩìÂâçÁâàÊú¨Êñá‰ª∂
                                    </span>
                                </div>
                            </div>

                            <!-- ÊôÆÈÄöÊ®°ÂºèÔºöÂè™ÊòæÁ§∫‰∏Ä‰∏™ËæìÂÖ•Ê°Ü -->
                            <div x-show="!activeCard.is_bundle">
                                <input type="text" x-model="editingData.filename" class="form-input">
                            </div>

                            <!-- ÂåÖÊ®°ÂºèÔºöÊòæÁ§∫‰∏§‰∏™ËæìÂÖ•Ê°Ü -->
                            <div x-show="activeCard.is_bundle" class="flex flex-col gap-2">
                                <!-- 1. Êñá‰ª∂Â§πÂêç (ÂØπÂ∫î Bundle Name) -->
                                <div class="flex items-center gap-2">
                                    <span
                                        class="text-xs w-16 text-yellow-500 font-bold text-right flex-shrink-0">Êñá‰ª∂Â§π:</span>
                                    <!-- ÊòæÁ§∫ÂΩìÂâçÊñá‰ª∂Â§πË∑ØÂæÑÔºå‰∏çÂèØÁºñËæë -->
                                    <div
                                        class="text-sm font-mono text-[var(--text-main)] px-2 py-1 bg-[var(--bg-sub)] rounded border border-[var(--border-light)] flex-1 truncate">
                                        <span x-text="activeCard.bundle_dir"></span>
                                    </div>
                                    <!-- Áã¨Á´ãÁöÑÈáçÂëΩÂêçÊåâÈíÆ -->
                                    <button @click="renameFolderFromDetail(activeCard.bundle_dir)"
                                        class="btn-secondary text-xs px-2 py-1 whitespace-nowrap">ÈáçÂëΩÂêç</button>
                                </div>

                                <!-- 2. ÂΩìÂâçÁâàÊú¨Êñá‰ª∂Âêç -->
                                <div class="flex items-center gap-2">
                                    <span
                                        class="text-xs w-16 text-blue-400 font-bold text-right flex-shrink-0">ÂΩìÂâçÊñá‰ª∂:</span>
                                    <!-- Ëøô‰∏™ input ÁªëÂÆö editingData.filenameÔºåÁÇπÂáªÂ∫ïÈÉ®ÁöÑ‚Äú‰øùÂ≠ò‚ÄùÊåâÈíÆÊó∂ÁîüÊïà -->
                                    <input type="text" x-model="editingData.filename"
                                        class="form-input flex-1 font-mono text-sm">
                                </div>
                                <div class="detail-muted mt-1 text-xs">
                                    ÊèêÁ§∫: ‰øÆÊîπ "ÂΩìÂâçÊñá‰ª∂" Â∞ÜÈáçÂëΩÂêçÂåÖÂÜÖÁöÑËøôÂº†ÂÖ∑‰ΩìÂõæÁâáÔºåÈúÄÁÇπÂáªÂ∫ïÈÉ®‰øùÂ≠òÁîüÊïà„ÄÇ
                                </div>
                            </div>
                        </div>

                        <div class="detail-card">
                            <div class="detail-card-head">
                                <div class="detail-card-title">Êõ¥Êñ∞ËßíËâ≤Âç° (Update)</div>
                            </div>

                            <div class="detail-manage-grid">
                                <div class="detail-manage-box">
                                    <div class="detail-manage-label">Êñá‰ª∂Ë¶ÜÁõñ</div>
                                    <div class="detail-muted">‰∏ä‰º† PNG/JSON Ë¶ÜÁõñÊàñÊ∑ªÂä†Êñ∞ÁâàÊú¨ÔºàBundleÔºâ</div>
                                    <div class="detail-manage-actions">
                                        <button @click="triggerCardUpdate()" class="btn-update-card btn-update-file">üìÇ
                                            Êñá‰ª∂Ë¶ÜÁõñ</button>
                                        <input type="file" x-ref="cardUpdateInput" @change="handleCardUpdate"
                                            accept=".png,.json" style="display:none;">
                                    </div>
                                </div>

                                <div class="detail-manage-box">
                                    <div class="detail-manage-label">URL Êõ¥Êñ∞</div>
                                    <div class="detail-muted">‰ªé PNG Áõ¥ÈìæÊõ¥Êñ∞</div>
                                    <div class="detail-manage-actions">
                                        <button @click="triggerUrlUpdate()" class="btn-update-card btn-update-url">üåê
                                            URL Êõ¥Êñ∞</button>
                                    </div>
                                </div>

                                <div class="detail-manage-box">
                                    <div class="detail-manage-label">ÂèëÈÄÅÂà∞ SillyTavern</div>
                                    <div class="detail-muted">ÈÄöËøáÈÖçÁΩÆÁöÑ ST Âú∞ÂùÄÂèëÈÄÅÂΩìÂâçÂç°</div>
                                    <div class="detail-manage-actions">
                                        <button id="btn-send-st" @click="sendToST()"
                                            class="bg-indigo-600 hover:bg-indigo-500 text-white border border-indigo-500/50 px-4 py-2 rounded-lg cursor-pointer text-sm flex items-center gap-2 transition-all shadow-lg">
                                            üöÄ ÂèëÈÄÅÂà∞ ST
                                        </button>
                                    </div>
                                </div>

                                <div class="detail-manage-box danger">
                                    <div class="detail-manage-label">Âà†Èô§</div>
                                    <div class="detail-muted">ÁßªËá≥ÂõûÊî∂Á´ôÔºàÂèØÂú®ËÆæÁΩÆÈ°µÊâìÂºÄÂõûÊî∂Á´ôÁõÆÂΩïÔºâ</div>
                                    <div class="detail-manage-actions">
                                        <button @click="deleteCards([activeCard.id])" class="btn-secondary"
                                            style="border-color:#ef4444; color:#ef4444;">
                                            üóëÔ∏è ÁßªËá≥ÂõûÊî∂Á´ô
                                        </button>
                                        <button x-show="activeCard.is_bundle" @click="unbundleCard()"
                                            class="btn-secondary" style="border-color:#fbbf24; color:#fbbf24;">
                                            üíî ÂèñÊ∂àËÅöÂêà
                                        </button>
                                    </div>
                                </div>
                                <div class="detail-manage-box" x-show="!activeCard.is_bundle">
                                    <div class="detail-manage-label">ËΩ¨Êç¢‰∏∫ÂåÖÊ®°Âºè</div>
                                    <div class="detail-muted">ÂàõÂª∫Êñá‰ª∂Â§πÂπ∂Â∞ÜÊ≠§Âç°ÁâáÁßªÂÖ•ÔºåÂºÄÂêØÂ§öÁâàÊú¨ÁÆ°ÁêÜ</div>
                                    <div class="detail-manage-actions">
                                        <button @click="convertToBundle()" class="btn-secondary"
                                            style="border-color: #f59e0b; color: #f59e0b;">
                                            üì¶ ËΩ¨‰∏∫ÂåÖ (Bundle)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Â¢ûÂä†Â∫ïÈÉ®ÁïôÁôΩÔºåÈò≤Ê≠¢ÊªöÂä®Âà∞Â∫ïÈÉ®Â§™Ë¥¥Ëæπ -->
                        <div style="height: 1rem; flex-shrink: 0;"></div>
                    </section>

                    <div style="height: 1rem;"></div>
                </div>

            </section>
        </div>
    </div>
    <div x-show="showSetResourceFolderModal" x-cloak class="modal-overlay z-[1000]" style="position: absolute;"
        @click.stop>
        <div style="background: var(--bg-panel); padding: 1.5rem; border-radius: 0.75rem; width: 25rem; border: 1px solid var(--border-light);"
            @click.stop>
            <h3 style="font-weight: bold; margin-bottom: 1rem;">ËÆæÁΩÆËµÑÊ∫êÁõÆÂΩï</h3>
            <div class="flex flex-col gap-2">
                <div style="color: var(--text-dim); font-size: 0.875rem;">ËæìÂÖ•Áõ∏ÂØπË∑ØÂæÑÊàñÁªùÂØπË∑ØÂæÑ</div>
                <input type="text" x-model="editingData.resource_folder" class="form-input">
                <div class="flex gap-2">
                    <button @click="showSetResourceFolderModal = false" class="btn-secondary flex-1">ÂèñÊ∂à</button>
                    <button @click="setResourceFolder(); showSetResourceFolderModal = false;"
                        class="btn-primary flex-1 rounded">Á°ÆÂÆö (API‰øùÂ≠ò)</button>
                </div>
            </div>
        </div>
    </div>
</div>